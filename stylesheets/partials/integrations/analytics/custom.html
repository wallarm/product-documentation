{# stylesheets/partials/integrations/analytics/custom.html #}

<script id="__analytics">
  // Run analytics ONLY on docs.wallarm.com

  function __md_isAmplitudeAllowed() {
    // If Material helpers are not available yet, assume Amplitude is allowed (fallback)
    if (typeof __md_get !== "function") {
      return true;
    }

    var consent = __md_get("__consent");

    // Default: enabled
    if (!consent) {
      return true;
    }

    // Prefer custom "amplitude" cookie, if present
    if (Object.prototype.hasOwnProperty.call(consent, "amplitude")) {
      return !!consent.amplitude;
    }

    // Fallback: built-in "analytics" flag
    if (Object.prototype.hasOwnProperty.call(consent, "analytics")) {
      return !!consent.analytics;
    }

    // If nothing matches, treat as disabled
    return false;
  }

  function __md_setFeedbackVisible(visible) {
    var form = document.forms && document.forms.feedback ? document.forms.feedback : null;
    if (form) form.hidden = !visible;

    var container = document.querySelector(".md-feedback");
    if (container) container.style.display = visible ? "" : "none";

    var details = document.getElementById("feedbackInput");
    if (!visible && details) details.style.display = "none";
  }

  function __md_analytics() {
    // Gate: do not load Amplitude if consent disallows it
    if (!__md_isAmplitudeAllowed()) {
      // If SDK already exists, opt-out defensively
      try {
        if (window.amplitude && window.amplitude.getInstance) {
          window.amplitude.getInstance().setOptOut(true);
        }
      } catch (e) {}
      return;
    }

    // Avoid double init
    if (window.__amplitude_loaded) return;
    window.__amplitude_loaded = true;

    var API_KEY = "{{ config.extra.analytics.amplitude_api_key }}";

    // Load Amplitude SDK (analytics-browser)
    var s = document.createElement("script");
    s.async = true;
    s.src = "https://cdn.amplitude.com/libs/analytics-browser-2.33.1-min.js.gz";
    s.onload = function () {
      if (!window.amplitude) return;

      // Init
      window.amplitude.init(API_KEY, {
        autocapture: true,
        minIdLength: 3
      });

      // Optional: Session Replay
      var r = document.createElement("script");
      r.async = true;
      r.src = "https://cdn.amplitude.com/libs/plugin-session-replay-browser-1.25.7-min.js.gz";
      r.onload = function () {
        try {
          if (window.sessionReplay && window.sessionReplay.plugin) {
            window.amplitude.add(window.sessionReplay.plugin({ sampleRate: 1 }));
          }
        } catch (e) {}
      };
      document.head.appendChild(r);
    };
    document.head.appendChild(s);
  }

  function __md_feedback() {
    function onReady(fn) {
      if (typeof document$ !== "undefined") {
        document$.subscribe(fn);
      } else {
        document.addEventListener("DOMContentLoaded", fn);
      }
    }

    function track(name, props) {
      // Respect consent every time we track
      if (!__md_isAmplitudeAllowed()) return;

      try {
        if (window.amplitude && typeof window.amplitude.track === "function") {
          window.amplitude.track(name, props || {});
        }
      } catch (e) {}
    }

    function dropRequired(container) {
      if (!container) return;
      container.querySelectorAll("[required]").forEach(function (el) {
        el.removeAttribute("required");
      });
    }

    onReady(function () {
      // Gate: show/hide feedback based on Amplitude consent
      if (!__md_isAmplitudeAllowed()) {
        __md_setFeedbackVisible(false);
        return;
      }
      __md_setFeedbackVisible(true);

      var feedback = document.forms && document.forms.feedback ? document.forms.feedback : null;
      if (!feedback) return;

      // Prevent reload from submit buttons
      if (!feedback.dataset.submitPatched) {
        feedback.dataset.submitPatched = "true";
        feedback.addEventListener("submit", function (ev) {
          ev.preventDefault();
        });
      }

      // Avoid double-binding on the same page instance
      if (feedback.dataset.wired === "true") return;
      feedback.dataset.wired = "true";

      function disableVoting() {
        if (feedback.firstElementChild) feedback.firstElementChild.disabled = true;
      }

      function showNote(value) {
        var wrapper = feedback.querySelector(".md-feedback__note");
        if (!wrapper) return;

        wrapper.style.display = "block";

        wrapper.querySelectorAll("[data-md-value]").forEach(function (el) {
          el.hidden = true;
          el.style.display = "none";
        });

        var note = wrapper.querySelector("[data-md-value='" + value + "']");
        if (note) {
          note.hidden = false;
          note.style.display = "block";
        }
      }

      var details = document.getElementById("feedbackInput");
      dropRequired(details);

      function wireNegativeDetails(container) {
        if (!container || container.dataset.negativeWired === "true") return;
        container.dataset.negativeWired = "true";

        var submit = container.querySelector(".feedback-submit-button");
        var radios = container.querySelectorAll('.feedback-input input[type="radio"]');
        var textarea = container.querySelector(".feedback-input textarea");
        var counter = container.querySelector(".character-count");
        var max = 240;

        if (!submit || !textarea) return;

        function updateState() {
          var radioChecked = Array.from(radios).some(function (r) { return r.checked; });
          var textFilled = textarea.value.trim() !== "";
          submit.disabled = !(radioChecked || textFilled);
        }

        textarea.addEventListener("input", function () {
          if (textarea.value.length > max) textarea.value = textarea.value.slice(0, max);
          if (counter) counter.textContent = textarea.value.length + "/" + max;
          updateState();
        });

        radios.forEach(function (r) {
          r.addEventListener("change", updateState);
        });

        submit.addEventListener("click", function (ev) {
          ev.preventDefault();

          container.style.display = "none";
          dropRequired(container);

          var selected = Array.from(radios).find(function (r) { return r.checked; });
          var text = textarea.value.trim();

          if (selected) {
            track("DOCS_FEEDBACK_NEGATIVE_REASON", {
              reason: selected.value,
              page_path: document.location.pathname,
              page_title: document.title
            });
          }

          if (text) {
            track("DOCS_FEEDBACK_NEGATIVE_TEXT", {
              text: text,
              page_path: document.location.pathname,
              page_title: document.title
            });
          }
        });

        updateState();
        if (counter) counter.textContent = textarea.value.length + "/" + max;
      }

      feedback.querySelectorAll('[type="submit"][data-md-value]').forEach(function (btn) {
        btn.addEventListener("click", function (ev) {
          ev.preventDefault();

          // If consent changed mid-session, hide immediately
          if (!__md_isAmplitudeAllowed()) {
            __md_setFeedbackVisible(false);
            return;
          }

          var value = this.getAttribute("data-md-value");

          if (value === "1") {
            track("DOCS_FEEDBACK_POSITIVE", {
              page_path: document.location.pathname,
              page_title: document.title
            });
          } else if (value === "0") {
            track("DOCS_FEEDBACK_NEGATIVE", {
              page_path: document.location.pathname,
              page_title: document.title
            });

            if (details) {
              details.style.display = "flex";
              dropRequired(details);
              wireNegativeDetails(details);
            }
          }

          disableVoting();
          showNote(value);
        });
      });
    });
  }

</script>