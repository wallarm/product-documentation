# APIインベントリの探索 <a href="../../about-wallarm/subscription-plans/#subscription-plans"><img src="../../images/api-security-tag.svg" style="border: none;"></a>

[API Discovery](overview.md) モジュールがエンドポイント（あなたのAPIインベントリ）のカタログを構築したら、Wallarmコンソールの **API Discovery** セクションでそれを探索できます。この記事から、発見されたデータを調査する方法を学びます。

## エンドポイント

[US](https://us1.my.wallarm.com/api-discovery) または [EU](https://my.wallarm.com/api-discovery) クラウドで **API Discovery** セクションを使用して、発見されたAPIインベントリを探索します。

![API Discovery によって発見されたエンドポイント](../images/about-wallarm-waf/api-discovery/discovered-api-endpoints.png)

**API Discovery** セクションを開くたびに、過去1週間のすべての発見されたエンドポイントとその[変更](track-changes.md)が表示されます。**変更日以降**フィルターを使用すると、`先週`を他の期間に変更できます。

デフォルトでは、エンドポイントはホスト/エンドポイント名でソートされ（ホストごとにグループ化されます）。**ヒット数**や**リスク**で並べ替えると、グループ化が解除されます - デフォルトに戻るには、もう一度ホスト/エンドポイント列をクリックします。

### 外部 vs 内部

外部ネットワークからアクセス可能なエンドポイントは、主要な攻撃方向です。したがって、外部から利用可能なものを見て、最初にこれらのエンドポイントに注意を払うことが重要です。

Wallarmは、発見されたAPIを自動的に外部と内部に分割します。次の場所にあるホストとそのすべてのエンドポイントは内部と見なされます：

* プライベートIPまたはローカルIPアドレス
* 一般的なトップレベルドメイン（例：localhost、dashboardなど）

残りの場合、ホストは外部と見なされます。

デフォルトでは、すべてのAPIホスト（外部および内部）のリストが表示されます。構築されたAPIインベントリでは、内部および外部のAPIを個別に表示できます。これを行うには、**外部**または**内部**をクリックします。

### フィルタリング

幅広いAPIエンドポイントフィルターの中から、分析目的に対応するフィルターを選択できます。例えば：

* ヒット数で並べ替えることができる、攻撃されているエンドポイントのみ。
* 機密データの処理と高い[リスクレベル](risk-score.md)の活動的な脆弱性を特徴とする最も脆弱なエンドポイントを見つけます。高リスクレベルの脆弱性を悪用することで、攻撃者はエンドポイントが処理/保存する機密データの盗難を含む多くの悪質な行為を行うことができます。
* [ローグエンドポイント](rogue-api.md)を見つけます：シャドウ、オーファン、ゾンビ。
* 過去1週間に変更されたり新たに発見されたりしたエンドポイントを見つけ、PIIデータを処理しているエンドポイントを見つけます。この種のリクエストを使用すると、APIの[変更](track-changes.md)に関する最新情報を把握することができます。
* PUTまたはPOSTコールによってデータがサーバーにアップロードされているエンドポイントを見つけます。このようなエンドポイントは頻繁に攻撃の対象となるため、十分にセキュアである必要があります。この種のリクエストを使用して、エンドポイントがチームに知られており、攻撃から十分に保護されていることを確認できます。
* 顧客の銀行カードデータを処理しているエンドポイントを見つけます。このリクエストを使用して、機密データがセキュアなエンドポイントでのみ処理されていることを確認できます。
* 非推奨のAPIバージョンのエンドポイント（例：`/v1`を検索することによって）を見つけ、それらがクライアントによって使用されていないことを確認します。

すべてのフィルター処理されたデータは、追加の分析のためにOpenAPI v3でエクスポートできます。

## エンドポイントの詳細

<a name="params"></a>エンドポイントをクリックすることで、リクエスト統計、ヘッダー、必須およびオプションのパラメーターとその関連するデータ型を含むエンドポイントの詳細も見つけることができます：

![API Discovery によって発見されたリクエストパラメーター](../images/about-wallarm-waf/api-discovery/discovered-request-params.png)

各パラメーター情報には以下が含まれます：

* パラメーター名とこのパラメーターが属するリクエストの部分
* パラメーターの変更情報（新規、未使用）
* このパラメーターによって送信される機密データの有無とタイプ、例えば：

    * IPアドレスとMACアドレスのような技術データ
    * 秘密鍵やパスワードのようなログイン認証情報
    * 銀行カード番号のような財務データ
    * 医療ライセンス番号のような医療データ
    * 氏名、パスポート番号、またはSSNのような個人識別情報（PII）

* このパラメーターに送信されるデータの[タイプ/フォーマット](#parameter-format-and-data-type)
* パラメーター情報が最後に更新された日時

### フォーマットとデータ型

**タイプ**列で、Wallarmはトラフィック分析を通じて特定されたデータフォーマットまたは、具体的でない場合は一般的なデータ型を示します。

Wallarmは、`Int32`、`Int64`、`Float`、`Double`、`Datetime`、`IPv4`/`IPv6`など、さまざまなデータフォーマットを検出しようとします。値が認識されたデータフォーマットに一致しない場合、Wallarmはそれを`Integer`、`Number`、`String`、`Boolean`などの一般的なデータ型として分類します。

このデータにより、各パラメーターで期待されるフォーマットの値が渡されているかどうかをチェックできます。不一致は、例えば次のような攻撃またはAPIのスキャンの結果である可能性があります：

* `IP`フィールドに`String`値が渡されている
* `Int32`よりも大きい値であるべきフィールドに`Double`値が渡されている

### 変動性

URLには、ユーザーのIDのようなさまざまな要素が含まれることがあります。例えば：

* `/api/articles/author/author-a-0001`
* `/api/articles/author/author-a-1401`
* `/api/articles/author/author-b-1401`

**API Discovery** モジュールは、上記の例で3つのエンドポイントではなく、そのような要素をエンドポイントパスの `{parameter_X}` フォーマットに統合するため、1つになります：

* `/api/articles/author/{parameter_1}`

エンドポイントをクリックしてそのパラメーターを展開し、多様なパラメーターに自動的に検出されたタイプを表示します。

![API Discovery - パス内の変動性](../images/about-wallarm-waf/api-discovery/api-discovery-variability-in-path.png)

アルゴリズムは新しいトラフィックを分析することに注意してください。ある時点で、統合されるべきアドレスがまだそうされていないことが見られる場合、少し時間を与えてください。データが増えるにつれて、システムは適切な数の一致するアドレスを持つ新しいパターンに適合するエンドポイントを統合します。

## APIエンドポイントに対する攻撃の監視

最後の7日間のAPIエンドポイントへの攻撃数が**ヒット**列に表示されます。フィルターで攻撃されたエンドポイントのみを表示するように要求することができます：**その他** → **攻撃されたエンドポイント**。

いくつかのエンドポイントへの攻撃を見るには、**ヒット**列の数字をクリックしてください：

![APIエンドポイント - イベントを開く](../images/about-wallarm-waf/api-discovery/endpoint-open-events.png)

[適用されたフィルター](../user-guides/search-and-filters/use-search.md)を持つ**攻撃**セクションが表示されます：

```
attacks last 7 days endpoint_id:<YOUR_ENDPOINT_ID>
```

また、特定のエンドポイントURLをクリップボードにコピーして、イベントを検索するために使用することもできます。これを行うには、このエンドポイントのメニューで **URLをコピー** を選択してください。

## APIエンドポイントのルール作成

APIインベントリの任意のエンドポイントから新しい[カスタムルール](../user-guides/rules/rules.md)を素早く作成することができます：

1. このエンドポイントのメニューで**ルールを作成**を選択します。ルール作成ウィンドウが表示されます。エンドポイントアドレスは自動的にウィンドウに解析されます。
1. ルール作成ウィンドウで、ルール情報を指定してから**作成**をクリックします。

![エンドポイントからルールを作成](../images/about-wallarm-waf/api-discovery/endpoint-create-rule.png)

## APIインベントリのOpenAPI仕様（OAS）のダウンロード

API Discovery UIを使用すると、Wallarmによって発見された個々のAPIエンドポイントまたはAPI全体の[OpenAPI v3](https://spec.openapis.org/oas/v3.0.0)仕様をダウンロードするオプションが提供されます。

* APIインベントリページの**OASをダウンロード**ボタンは、ダウンロード前にフィルターが適用されている場合はそのフィルター済みデータのみ、そうでなければインベントリ全体の`swagger.json`を返します。

    ダウンロードしたデータを使用して、例えばPostmanにアップロードするなど、自分でエンドポイントをテストできます。

    !!! warning "ダウンロードされたSwaggerファイル内のAPIホスト情報"
        発見されたAPIインベントリに複数のAPIホストが含まれている場合、ダウンロードされたSwaggerファイルにはすべてのAPIホストのエンドポイントが含まれます。現在、ファイルにAPIホスト情報は含まれていません。

* 個々のエンドポイントメニュー内の**OASをダウンロード**ボタンは、選択されたエンドポイントの`swagger.json`を返します。

    ダウンロードした仕様をPostmanなどの他のアプリケーションで利用することで、エンドポイントの脆弱性テストなどを実施できます。また、エンドポイントの機能をより詳細に調査して、機密データの処理や文書化されていないパラメーターの存在を発見することができます。