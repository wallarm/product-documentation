# Threat Replay Testingのセットアップ <a href="../../../about-wallarm/subscription-plans/#core-subscription-plans"><img src="../../../images/api-security-tag.svg" style="border: none;"></a> <a href="../../../about-wallarm/subscription-plans/#core-subscription-plans"><img src="../../../images/security-testing-tag.svg" style="border: none;"></a>

この記事では、Wallarmの[Threat Replay Testing](overview.md)の有効化と設定方法を説明します。

## 有効化

Threat Replay Testingはデフォルトで無効です。有効化して実行するには、次の手順に従います。

1. Advanced API Securityの[サブスクリプションプラン](../../about-wallarm/subscription-plans.md#core-subscription-plans)を契約していることを確認します。
1. Wallarm ConsoleのSecurity Testing → Threat Replayに、[US Cloud](https://us1.my.wallarm.com/threat-replay-testing/tests)または[EU Cloud](https://my.wallarm.com/threat-replay-testing/tests)のリンクから進み、**Enable Threat Replay Testing**スイッチをオンに切り替えます。

    Threat Replayが表示されない場合は、Wallarmのテクニカルサポートに[お問い合わせ](mailto:support@wallarm.com)ください。

1. Threat Replay TestingのIPアドレスを許可リストに[追加](#preventing-from-being-blocked)します。
1. **Test policies**タブに移動し、[少なくとも1つのポリシー](#configure-test-policies)を作成します。

## ブロックされないようにする

Wallarmに加えて、自動的にトラフィックをフィルタリングおよびブロックする追加の仕組み（ソフトウェアまたはハードウェア）を使用している場合は、Threat Replay TestingのIPアドレスを含む[許可リストを設定](../../admin-en/scanner-addresses.md)することを推奨します。

これにより、Threat Replay Testingを含むWallarmコンポーネントが、対象のリソースに対して脆弱性スキャンをシームレスに実行できるようになります。

## テストポリシーの設定

フィルタリングノードがあるエンドポイントへの攻撃を検知すると、[有効化済み](#enable)のThreat Replay Testingが、当該エンドポイントがその攻撃タイプに対して脆弱かどうかを確認するテストを実行します。

これらのテストを実行するかどうか、また具体的な実行方法は、テストポリシーで定義します。各ポリシーでは次を定義します：

* どのホストに対してテストを実行するか。
* どの環境でテストを実行するか。
* どの攻撃タイプに対してテストを実行するか（[制限事項](overview.md#limitations)を参照）。
* このエンドポイントと攻撃タイプについて再テストをどの頻度で実行するか。
* 任意項目として、テスト環境で実行する前にテストリクエストをどのように変更するか。

![Threat Replay Testing - テストポリシー](../../images/vulnerability-detection/trt-policy.png)

## 複数のテストポリシーの動作

次のとおりです。

* ポリシーがない → テストは実行されません。
* このホスト/攻撃タイプ向けのポリシーがない → テストは実行されません。
* 対象ホストに影響するポリシーが複数ある → 複数の独立したテストが実行されます。

時間に関して：このエンドポイントと攻撃タイプに対するテストがすでに実行済みで、その後このエンドポイントに同タイプの新たな攻撃が発生しても、**Period**の期限が切れるまでテストは再実行されません。

## ホストとリプレイ先ホスト

テストを実行するホストと、それらのテストをどの環境で実行するかは、Host affected by attackおよびReplay attack on hostフィールドで定義します。

両フィールドでは、キャプチャグループや後方参照を含む正規表現を使用できます。以下に代表的なシナリオを示します。

### シナリオ#1：特定のホスト上の任意のサブドメインの攻撃を再チェック

Host affected by the attack: `.+\.wallarm\.com`  
Replay attack on host:  `test.wallarm.com`

結果：

*  `www.wallarm.com`  への任意の攻撃は`test.wallarm.com`上でテストされます。
* `dev.wallarm.com`への任意の攻撃は`test.wallarm.com`上でテストされます。

### シナリオ#2：ホスト名の中間部分を置換

Host affected by the attack: `(.+)\.wallarm\.com`  
Replay attack on host:   `\1.test-wallarm.com`

結果：

* `www.wallarm.com`への攻撃は`www.test-wallarm.com`上でテストされます。
* `dev.wallarm.com`への攻撃は`dev.test-wallarm.com`上でテストされます。

### シナリオ#3：同一ホスト上の任意のリクエストを再チェック

Host affected by the attack: `(.+)`  
Replay attack on host: `\1`

結果： 

* `www.wallarm.com`への攻撃は`www.wallarm.com`上でテストされます。  
* `dev.wallarm.com`への攻撃は`dev.wallarm.com`上でテストされます。
             
### シナリオ#4：特定のホストの攻撃を特定のホストで再チェック

Host affected by the attack: `www\.wallarm\.com`  
Replay attack on host:  `test.wallarm.com`

結果： 

* 攻撃先が` www.wallarm.com`の場合は`test.wallarm.com`上でテストされます。  
* `dev.wallarm.com`への攻撃はテストされません。

## Rewrites

デフォルトでは、Threat Replay Testingは[特定の認証パラメータの除去](overview.md#test-request-security)を除き、オリジナルのリクエストデータを保持します。テストポリシーのRewritesセクションを使用すると、オリジナルのリクエスト要素を基にテスト攻撃セットを生成する前に、それらの要素を変更できます。これは、オリジナルの認証データをテスト用データに置き換える場合や、別のアドレスで攻撃のリプレイを実施する場合に特に有用です。

!!! warning "オリジナルのリクエスト要素の変更"
    変更できるのは、オリジナルのリクエストのヘッダー（`header`）とパス（`uri`）のみです。その他のリクエスト要素は変更も追加もできません。

**Rewriteの例**

以下は、example.comで再生される攻撃が`COOKIE`ヘッダーに`PHPSESSID=mntdtbgt87j3auaq60iori2i63; security=low`という値を保持するようにするためのRewriteです。

![COOKIEを変更するRewriteの例](../../images/vulnerability-detection/trt-policy-with-rewrite.png)