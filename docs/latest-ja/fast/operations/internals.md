[img-testpolicy-id]:                        ../../images/fast/operations/common/internals/policy-id.png
[img-execution-timeline-recording]:         ../../images/fast/operations/en/internals/execution-timeline.png
[img-execution-timeline-no-recording]:      ../../images/fast/operations/en/internals/execution-timeline-existing-testrecord.png
[img-testrecord]:                           ../../images/fast/operations/en/internals/testrecord-explained.png           
[img-fast-node]:                            ../../images/fast/operations/common/internals/fast-node.png
[img-reuse-token]:                          ../../images/fast/operations/common/internals/reuse-token.png
[img-components-relations]:                 ../../images/fast/operations/common/internals/components-relations.png
[img-common-timeline-no-recording]:         ../../images/fast/operations/en/internals/common-timeline-existing-testrecord.png

[doc-ci-intro]:                     ../poc/integration-overview.md
[doc-node-deployment-api]:          ../poc/node-deployment.md
[doc-node-deployment-ci-mode]:      ../poc/ci-mode-recording.md
[doc-quick-start]:                  ../qsg/deployment-options.md
[doc-integration-overview]:         ../poc/integration-overview.md

[link-create-policy]:               test-policy/general.md
[link-use-policy]:                  test-policy/using-policy.md
[doc-policy-in-detail]:             test-policy/overview.md

[anchor-testpolicy]:    #fast-test-policy
[anchor-testrun]:       #test-run
[anchor-token]:         #token
[anchor-testrecord]:    #test-record

[doc-testpolicy-creation-example]:  ../qsg/test-preparation.md#2-create-a-test-policy-targeted-at-xss-vulnerabilities
[doc-about-timeout]:                create-testrun.md
[doc-node-deployment]:              ../poc/node-deployment.md#run-docker-container-with-the-fast-node

[link-wl-portal-new-policy]:    https://us1.my.wallarm.com/testing/policies/new#general 
[link-wl-portal-policy-tab]:    https://us1.my.wallarm.com/testing/policies
[link-wl-portal-node-tab]:      https://us1.my.wallarm.com/testing/nodes

#   FASTの操作方法

--8<-- "../include-ja/fast/cloud-note.md"

!!! info "文書内容についての簡単な注意事項"
    本章で説明されているエンティティ間の関係（以下参照）とテストシナリオは、Wallarm APIを用いたテストに関連しています。この種のテストではすべてのエンティティが使用されるため、これらのエンティティがどのように相互作用するかについての包括的な洞察を読者に提供することが可能です。
    
    FASTをCI/CDワークフローに統合する際、これらのエンティティは変わりませんが、特定のケースではステップの順序が異なることがあります。詳細については、[この文書][doc-ci-intro]をご覧ください。

FASTは以下のエンティティを使用しています：

* [テストレコード。][anchor-testrecord]
* [FAST テストポリシー。][anchor-testpolicy]
* [テスト実行。][anchor-testrun]
* [トークン。][anchor-token]

先に述べたエンティティ間にはいくつかの重要な関係があります：
* テストポリシーとテストレコードは、複数のテストランとFASTノードで使用することができます。
* トークンはWallarmクラウド内の単一のFASTノード、そのFASTノードを含む単一のDockerコンテナ、および単一のテストランに関連しています。
* トークンが他のノードを含むDockerコンテナで使用されていない場合、既存のトークン値をFASTノードを含むDockerコンテナに渡すことができます。
* 別のテストランが実施中の場合、そのFASTノードの新しいテストランを作成すると、現在のテストランは停止して新しいものに置き換えられます。

![コンポーネント間の関係][img-components-relations]

##   FASTが使用するエンティティ

FASTノードは、リクエストソースからターゲットアプリケーションへのすべてのリクエストのプロキシとして機能します。Wallarmの用語では、これらのリクエストは*ベースラインリクエスト*と呼ばれます。

FASTノードがリクエストを受信すると、それらを特別な「テストレコード」オブジェクトに保存して後でそこからセキュリティテストを作成します。Wallarmの用語では、このプロセスは「ベースラインリクエストの記録」と呼ばれます。

ベースラインリクエストの記録が終わると、FASTノードは[*テストポリシー*][anchor-testpolicy]に従ってセキュリティテストセットを作成します。その後、セキュリティテストセットは、ターゲットアプリケーションが脆弱性に対してどの程度評価可能かを調査するために実行されます。

テストレコードを使用すると、以前に記録されたベースラインリクエストを再利用して同じターゲットアプリケーションまたは別のターゲットアプリケーションを再テストすることができます。そのため、同一のベースラインリクエストをFASTノードを通じて送信する手間が省けます。ただし、これはテストレコード内のベースラインリクエストがアプリケーションをテストするのに適している場合に限ります。


### テストレコード

FASTは、テストレコードに保存されたベースラインリクエストからセキュリティテストセットを作成します。

テストレコードにいくつかのベースラインリクエストを記録するには、このテストレコードとFASTノードに紐づいた[テストラン][anchor-testrun]を実行し、いくつかのベースラインリクエストをFASTノードを通じて送信する必要があります。  

もしくは、テストランを作成せずにテストレコードを記録することも可能です。そのためには、記録モードでFASTノードを実行する必要があります。詳細については[この文書][doc-node-deployment-ci-mode]をご覧ください。 

テストレコードがリクエストで記録されていると、テストレコード内に格納されているベースラインリクエストのサブセットを使用して評価対象のアプリケーションが脆弱性を持っている可能性があるかどうかを調べることができる別のテストランでそれを使用することが可能となります。  

単一のテストレコードは、複数のFASTノードとテストランで使用することができます。これは以下のような場合に有用です：
* 同じターゲットアプリケーションが再度テストされる場合。
* 同じベースラインリクエストを使用して複数のターゲットアプリケーションが同時にテストされる場合。

![テストレコードとの連携][img-testrecord]
 

### FAST テストポリシー

*テストポリシー*は、脆弱性検出プロセスを行うためのルールセットを定義します。特に、アプリケーションがテストされるべき脆弱性のタイプを選択することができます。さらに、ポリシーは、セキュリティテストセットを作成する際に、ベースラインリクエストのどのパラメータが処理可能であるかを決定します。これらのデータは、FASTが攻撃対象のアプリケーションが攻撃可能であるかどうかを確認するために使用するテストリクエストを作成するために使用されます。

新しいポリシーを[作成][link-create-policy]することも、既存のものを[使用][link-use-policy]することもできます。

!!! info "適切なテストポリシーの選択"
    テストポリシーの選択は、テスト対象のアプリケーションの動作方法に依存します。それぞれのアプリケーションに対して個別のテストポリシーを作成することをお勧めします。

!!! info "追加情報"

    * クイックスタートガイドからの[テストポリシーの例][doc-testpolicy-creation-example]
    * [テストポリシーの詳細][doc-policy-in-detail]

### テストラン

*テストラン*は、脆弱性テストプロセスの単一の反復を記述します。

テストランには以下のものが含まれます：

* [テストポリシー][anchor-testpolicy]の識別子
* [テストレコード][anchor-testrecord]の識別子

FASTノードは、これらの値を使用してターゲットアプリケーションのセキュリティテストを実行します。

各テストランは、単一のFASTノードと密接に関連しています。FASTノードで新しいテストラン `B`を作成して、別のテストラン `A`がこのノードで進行中の場合、テストラン `A`の実行は中止されてテストラン `B`で置き換えられます。

テストランの作成は、2つの異なるテストシナリオで可能です：
* 最初のシナリオでは、ターゲットアプリケーションが脆弱性のテストを受け、ベースラインリクエストの記録が同時に行われます（新しいテストレコードに）。ベースラインリクエストが記録されるためには、リクエストソースからターゲットアプリケーションにリクエストが通過する必要があります。 

    このガイドでは、このシナリオでのテストランの作成を「テストランの作成」と呼びます。

* 2つ目のシナリオでは、ターゲットアプリケーションが既存の、空でないテストレコードから抽出したベースラインリクエストで脆弱性のテストを受けます。このシナリオでは、リクエストソースをデプロイする必要はありません。

    このガイドでは、このシナリオでのテストランの作成を「テストランのコピー」と呼びます。

テストランを作成またはコピーすると、その実行は直ちに開始されます。実行プロセスは、動作中のテストシナリオに応じて異なるステップを辿ります（下記を参照）。

### テストランの実行フロー（ベースラインリクエストの記録が行われます）

テストランを作成すると、その実行は直ちに開始され、以下のステップが実行されます：

1.  FASTノードはテストランを待ちます。

    FASTノードがテストランが開始したことを確認すると、ノードはテストランからテストポリシーとテストレコードの識別子を取得します。
    
2.  識別子を取得した後、*ベースラインリクエストの記録プロセス*が開始されます。
    
    この時点で、FASTノードはリクエストソースからターゲットアプリケーションへのリクエストの受信を待つ状態になります。
    
3.  リクエストの記録がアクティブになると、既存のテストの実行を開始することができます。HTTPとHTTPSのリクエストがFASTノードに送信され、それらをベースラインリクエストとして認識します。

    すべてのベースラインリクエストは、テストランに対応するテストレコードに保存されます。
    
4.  テストの実行が終わったら、記録プロセスを停止することができます。
    
    テストランの作成後に特別なタイムアウト値が設定されています。これは、FASTが新しいベースラインリクエストを待つべき時間を決定します。ベースラインリクエストがない場合の記録プロセスの停止（[`inactivity_timeout`][doc-about-timeout]パラメータ）。

    手動で記録プロセスを停止しない場合、
    
    * テストランは、FASTのセキュリティテストがすでに完了していても、タイムアウト値が切れるまで実行を続けます。
    * 他のテストランは、このテストランが停止するまでテストレコードを再利用することができません。
    
    ベースラインリクエストがこれ以上待たなくなったら、FASTノード上で記録プロセスを停止することができます。以下の点に注意してください：

    * セキュリティテストの作成と実行のプロセスは停止すべきではありません。テストランの実行は、ターゲットアプリケーションに対する評価が終了するまで停止します。この挙動は、CI/CDジョブの実行時間を短縮するのに役立ちます。
    * 他のテストランは、記録が停止されるとテストレコードを再利用することができるようになります。
    
5.  FASTノードは、各入力ベースラインリクエストに基づいて1つ以上のテストリクエストを作成します（ただし、ベースラインリクエストが適用されたテストポリシーを満たしている場合のみ）。
     
6.  FASTノードは、テストリクエストをターゲットアプリケーションに送信することでテストリクエストを実行します。

ベースラインリクエストの記録プロセスを停止しても、テストリクエストの作成と実行のプロセスには影響がありません。

ベースラインリクエストの記録プロセスとFASTセキュリティテストの作成と実行のプロセスは並行して実行します：

![テストランの実行フロー（ベースラインリクエストの記録が行われます）][img-execution-timeline-recording]

注：上記のチャートは、[FASTクイックスタートガイド][doc-quick-start]で説明されているフローを示しています。ベースラインリクエストの記録が行われるフローは、手動のセキュリティテストまたはCI/CDツールを使用した自動化されたセキュリティテストに適しています。

このシナリオでは、テストランを操作するためにWallarm APIが必要となります。詳細は[このドキュメント][doc-node-deployment-api]をご覧ください。 


### テストランの実行フロー（事前に記録されたベースラインリクエストが使用されます）

テストランをコピーすると、その実行は直ちに開始され、以下のステップが実行されます：

1.  FASTノードはテストランを待ちます。 

    FASTノードがテストランが開始したことを確認すると、ノードはテストランからテストポリシーとテストレコードの識別子を取得します。
    
2.  識別子を取得した後、ノードはテストレコードからベースラインリクエストを抽出します。

3.  FASTノードは、各抽出されたベースラインリクエストに基づいて1つ以上のテストリクエストを作成します（ただし、ベースラインリクエストが適用されたテストポリシーを満たしている場合のみ）。

4.  FASTノードは、テストリクエストをターゲットアプリケーションに送信することでテストリクエストを実行します。

ベースラインリクエストの抽出プロセスは、FASTセキュリティテストの作成と実行の前に行われます：

![テストランの実行フロー（事前に記録されたベースラインリクエストが使用されます）][img-execution-timeline-no-recording]

注：ここでは、[FASTクイックスタートガイド][doc-quick-start]で使用されている実行フローを示しています。事前に記録されたベースラインリクエストを使用するフローは、CI/CDツールを使用した自動化されたセキュリティテストに適しています。

このシナリオでは、テストランを操作するためにWallarm APIまたはCIモードのFASTノードを使用することができます。詳細は[このドキュメント][doc-integration-overview]をご覧ください。

以下のチャートは、最も一般的に遭遇されるCI/CDワークフローを示しており、上記のタイムラインに準じています：

![テストランの実行フロー（CIモード）][img-common-timeline-no-recording]


##  テストランの操作

このガイドを読んでいると、API呼び出しを使ってテストランの実行プロセスを管理する方法を学べます。具体的には、以下の機能について学びます：
* リクエストソースからのリクエストがこれ以上ない場合に、ベースラインリクエストの記録プロセスを停止する方法。
* テストランの実行ステータスを確認する方法。

これらのAPI呼び出しを行い、テストランをFASTノードに結びつけるためには、[*トークン*][anchor-token]を取得する必要があります。

### トークン

FASTノードは次のように構成されます：
*  FASTソフトウェアを含む稼働中のDockerコンテナ。
    
    ここでトラフィックのプロキシング、セキュリティテストの作成、実行が行われます。
    
*  WallarmクラウドのFASTノード。

トークンは、稼働中のDockerコンテナとクラウド内のFASTノードとを結びつけます：

![FASTノード][img-fast-node]

FASTノードをデプロイするには、次の手順を実行します：
1.  [Wallarmポータル][link-wl-portal-node-tab]を使用して、Wallarmクラウド内にFASTノードを作成します。提供されたトークンをコピーします。
2.  ノードと一緒にDockerコンテナをデプロイし、トークン値をコンテナに渡します（このプロセスは[ここ][doc-node-deployment]で詳しく説明されています）。

トークンは、以下の目的でも使用されます：
* テストランをFASTノードに接続します。
* API呼び出しを行うことでテストランの実行プロセスを管理することができます。

必要なだけのFASTノードをWallarmクラウドに作成し、各ノードに対してトークンを取得することができます。例えば、FASTが必要なCI/CDジョブがいくつかある場合、各ジョブに対してクラウド内にFASTノードを作成することができます。

他のアクティブなDockerコンテナのFASTノード（同じトークンを使用するノードを含む任意のDockerコンテナが停止または削除されている）がそれを使用していない場合、以前に取得したトークンを再利用することが可能です：

![トークンを再利用する][img-reuse-token]