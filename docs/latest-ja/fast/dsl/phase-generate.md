[link-points]:          points/intro.md
[link-ruby-regexp]:     http://ruby-doc.org/core-2.6.1/doc/regexp_rdoc.html
[link-logic]:           logic.md
[link-markers]:         detect/markers.md
[link-ext-logic]:       logic.md

[img-generate-methods]:     ../../images/fast/dsl/en/phases/generate-methods.png
[img-generate-payload]:     ../../images/fast/dsl/en/phases/generate-payload.png

#  Generateフェーズ

!!! info "フェーズの範囲"
    このフェーズは変更を行う拡張で使用され、動作上は任意です（YAMLファイル内の`generate`セクションは存在していても存在していなくてもかまいません）。

    このフェーズは非変更系拡張のYAMLファイルには含めないでください。
    
    拡張の種類についての詳細は[こちら][link-ext-logic]をご覧ください。

!!! info "リクエスト要素の記述構文"
     FAST拡張を作成する際、ポイントを用いて操作対象とするリクエスト要素を正しく記述するために、アプリケーションへ送信されるHTTPリクエストの構造と、アプリケーションから受信するHTTPレスポンスの構造を理解しておく必要があります。 
     
     詳細は[こちら][link-points]をご覧ください。
 
このフェーズでは、ベースラインリクエストの特定のパラメータに挿入するペイロードを指定し、このリクエストに基づくテストリクエストを作成します。

`generate`セクションの構造は次のとおりです:

```
generate:
  - into:
    - parameter 1
    - parameter 2
    - …
    - parameter N
  - method:
    - postfix
    - prefix
    - random
    - replace
  - payload:
    - payload 1
    - payload 2
    - …
    - payload N
```

* `into`パラメータは、ペイロードを挿入する対象のリクエスト要素を1つまたは複数指定できます。このパラメータの値は文字列または文字列の配列です。`into`の値として[Ruby形式の正規表現][link-ruby-regexp]を使用できます。
    
    このパラメータは任意で、セクション内に省略されていてもかまいません。`into`パラメータが省略された場合、与えられたテストポリシーに従い変更可能とされているリクエスト要素にペイロードが挿入されます。
    
    仮に、テストポリシーに従ってベースラインリクエストから次の変更可能なリクエスト要素が抽出されたとします:
    
    * `GET_uid_value`
    * `HEADER_COOKIE_value`
    
    拡張はこれらすべての変更可能な要素（挿入ポイントとも呼びます）を順番に処理します。 
    
    `into`パラメータがない場合、`GET_uid_value`パラメータにペイロードが順に挿入され、生成されたテストリクエストで対象アプリケーションの脆弱性を検査します。その後、テストリクエストの結果を処理したのち、拡張は`HEADER_COOKIE_value`パラメータを処理し、同様にこのパラメータへペイロードを挿入します。
    
    次の例のように、`into`パラメータに`GET_uid_value`というリクエストパラメータを含めた場合、ペイロードは`GET_uid_value`パラメータにのみ挿入され、`HEADER_COOKIE_value`パラメータには挿入されません。
    
    ```
    into: 
      - 'GET_uid_value'
    ```
    次の例ではパラメータが1つだけなので、intoパラメータの値は1行で記述できます:
    
    `into: 'GET_uid_value'`

* `method` — 任意のパラメータで、ベースラインのリクエスト要素にペイロードを挿入する際に用いる方法の一覧を指定します。 
    * `prefix` — ベースラインのリクエスト要素の値の前にペイロードを挿入します。
    * `postfix` — ベースラインのリクエスト要素の値の後にペイロードを挿入します。
    * `random` — ベースラインのリクエスト要素の値の中のランダムな位置にペイロードを挿入します。
    * `replace` — ベースラインのリクエスト要素の値をペイロードで置き換えます。
    
    ![ペイロード挿入方法][img-generate-methods]
    
    `method`パラメータがない場合、既定で`replace`メソッドが使用されます。
    
    作成されるテストリクエストの数は指定した`method`の数に依存します。挿入方法1つにつきテストリクエスト1件です。
    
    たとえば、次の挿入方法を指定した場合:
    
    ```
    method:
      - prefix
      - replace
    ```
    
    このとき、ペイロードが1つならテストリクエストは2件、ペイロードが2つなら4件（各ペイロードにつき2件）というように作成されます。

* `payload`パラメータは、リクエストパラメータに挿入してテストリクエストを生成するためのペイロードの一覧を指定します。生成されたテストリクエストは対象アプリケーションの脆弱性を検査します。
    
    このパラメータは必須で、セクション内に常に存在している必要があります。一覧には少なくとも1つのペイロードを含めてください。複数のペイロードがある場合、FASTノードはリクエストパラメータへ順にペイロードを挿入し、作成された各テストリクエストを用いて対象アプリケーションの脆弱性を検査します。
    
    ![ペイロード生成][img-generate-payload]
    
    ペイロードは、リクエストの処理中にいずれかのパラメータへ挿入される文字列です。
    
    ??? info "複数ペイロードの例"
        ```
        payload:
          - "') or 1=('1"
          - "/%5c../%5c../%5c../%5c../%5c../%5c../%5c../etc/passwd/"
        ```
    
    脆弱性検出の可能性をさらに広げるために、ペイロードの一部として特別なマーカーを使用できます:

    * **`STR_MARKER`** — `STR_MARKER`が指定されている位置にランダムな文字列をペイロードへそのまま挿入します。 
        
        例として、`STR_MARKER`はアプリケーションのXXS脆弱性の確認に使用できます。
        
        ??? info "例"
            `'userSTR_MARKER'`
    
    * **`CALC_MARKER`** — `CALC_MARKER`が指定されている位置に、ランダムな算術式（例: `1234*100`）を含む文字列をペイロードへそのまま挿入します。
        
        例として、`CALC_MARKER`はアプリケーションのRCE脆弱性の確認に使用できます。
        
        ??? info "例"
            `'; bc <<< CALC_MARKER'`
    
    * **`DNS_MARKER`** — `DNS_MARKER`が指定されている位置に、ランダムなドメイン（例: `r4nd0m.wlrm.tl`）を含む文字列をペイロードへそのまま挿入します。
        
        例として、`DNS_MARKER`はDNS Out-of-Bound脆弱性の確認に使用できます。

        ??? info "例"
            `'; ping DNS_MARKER'`
    
    !!! info "マーカーの動作ロジック"
        Detectフェーズがサーバーのレスポンス内でいずれかのペイロード由来のマーカーを検出した場合、攻撃は成功したことになり、すなわち脆弱性の悪用に成功したことを意味します。マーカーを用いたDetectフェーズの動作の詳細は[こちら][link-markers]をご覧ください。