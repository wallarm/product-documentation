[link-points]:          points/intro.md
[link-ruby-regexp]:     http://ruby-doc.org/core-2.6.1/doc/regexp_rdoc.html
[link-ext-logic]:       logic.md

[img-collect-uniq]:    ../../images/fast/dsl/en/phases/collect-uniq.png

# Collectフェーズ

!!! info "フェーズのスコープ"
    このフェーズは変更を加える拡張で使用され、動作上は任意です（YAMLファイルの`collect`セクションは存在しても存在しなくてもかまいません）。
    
    また、変更を加えない拡張では一意性条件を利用するため、このフェーズは暗黙的に使用されます。
    
    拡張の種類の詳細は[こちら][link-ext-logic]をご覧ください。

!!! info "リクエスト要素の記述構文"
    FAST拡張を作成する際、ポイントを用いて操作する必要があるリクエスト要素を正しく記述するために、アプリケーションに送信されるHTTPリクエストの構造と、アプリケーションから受信するHTTPレスポンスの構造を理解しておく必要があります。
    
    詳細はこの[リンク][link-points]をご確認ください。

このフェーズは、指定された条件を満たすすべてのベースラインリクエストを収集します。リクエストを収集するかどうかの判断には、テスト実行中にすでに収集されたリクエストに関する情報を使用します。

ベースラインリクエストの収集処理はリアルタイムで行われます。各リクエストは、FASTノードがベースラインリクエストを書き出した順序で処理されます。Collectフェーズによる処理と収集のために、リクエスト書き出しプロセスの完了を待つ必要はありません。

## 一意性条件

一意性条件は、指定した基準に照らして一意でないベースラインリクエストが後続のフェーズで処理されるのを許可しません。フィルタリングされたリクエストに対してテストリクエストは生成されません。同一タイプのベースラインリクエストが多数届く場合に、対象アプリケーションの負荷を低減するのに役立ちます。

受信した各リクエストの一意性は、以前に受信したリクエスト内のデータに基づいて判定されます。

![一意性条件を伴うCollectフェーズ][img-collect-uniq]

ベースラインリクエストの一意性を判定するために使用すべきリクエスト内の要素一覧は、一意性条件で定義します。

ベースラインリクエストを受信すると、Collectフェーズにある拡張は、一覧内の各リクエスト要素に対して次の処理を行います:
1. その要素がベースラインリクエストに存在しない場合、一覧の次の要素に進みます。
2. その要素がベースラインリクエストに存在し、かつその要素のデータが一意である（言い換えると、これまでに受信したベースラインリクエストのいずれのデータとも一致しない）場合、このベースラインリクエストを一意と見なし、次のフェーズへ渡します。同時にこのリクエスト要素のデータを記録します。
3. その要素がベースラインリクエストに存在し、かつその要素のデータが一意でない（言い換えると、以前に受信したベースラインリクエストのデータと一致する）場合、このベースラインリクエストは一意性条件を満たさないため破棄します。対象のリクエストに対して拡張は実行されません。
4. 一覧の末尾に到達しても、一意性の判定に用いることができるリクエスト要素が見つからなかった場合、このベースラインリクエストは破棄します。このリクエストに対して拡張は実行されません。

拡張のYAMLファイルの`collect`セクションで、ベースラインリクエストの一意性を定義する要素を含む`uniq`リストを用いて、一意性条件を記述できます。

```
collect:
  - uniq:
    - [request element]
    - [request element 1, request element 2, …, request element N]
    - testrun
```  

一覧内のリクエスト要素には[Rubyの正規表現形式の正規表現][link-ruby-regexp]を含めることができます。

`uniq`による一意性条件は、ベースラインリクエストの一意性を確認するために使用するデータを含むリクエスト要素の配列で構成されます。`testrun`パラメータも使用できます。

一意性条件のパラメータは次のとおりです:

* **`- [request element]`**
    
    リクエストが一意と見なされるためには、そのリクエスト要素内のデータが一意である必要があります。
    
    ??? info "例"
        `- [GET_uid_value]` — リクエストの一意性は`uid` GETパラメータのデータによって定義されます（つまり、`uid` GETパラメータの値が一意な各ベースラインリクエストに対して拡張を実行します）。

        * `example.com/example/app.php?uid=1` は一意なリクエストです。
        * `example.com/demo/app.php?uid=1` は一意なリクエストではありません。
        * `example.com/demo/app.php?uid=` は一意なリクエストです。
        * `example.org/billing.php?uid=1` は一意なリクエストではありません。
        * `example.org/billing.php?uid=abc` は一意なリクエストです。

* **`- [request element 1, request element 2, …, request element N]`**
    
    リクエストはN個の要素の組を含み、かつ各組におけるリクエスト要素のデータが一意である場合に、一意なリクエストとして扱われます。
    
    ??? info "例1"
        `- [GET_uid_value, HEADER_COOKIE_value]` — リクエストの一意性は`uid` GETパラメータのデータと`Cookie` HTTPヘッダーのデータで決定されます（つまり、`uid` GETパラメータ値と`Cookie`ヘッダーの組が一意な各ベースラインリクエストに対して拡張を実行します）。

        * `example.org/billing.php?uid=1, Cookie: client=john` は一意なリクエストです。
        * `example.org/billing.php?uid=1, Cookie: client=ann` は一意なリクエストです。
        * `example.com/billing.aspx?uid=1, Cookie: client=john` は一意なリクエストではありません。
    
    ??? info "例2"
        `- [PATH_0_value, PATH_1_value]` — パスの第1要素と第2要素の組でリクエストの一意性を定義します（つまり、`PATH_0`と`PATH_1`パラメータの組の値が一意な各ベースラインリクエストに対して拡張を実行します）。
            
        Wallarmは要素の処理中にリクエスト要素のパースを行います。`/en-us/apps/banking/`のような形式のURIパスに対して、Pathパーサーは各パス要素をPATH配列に格納します。
            
        配列要素の値にはインデックスでアクセスできます。前述の`/en-us/apps/banking/`パスに対して、パーサーは次のデータを提供します:

        * `"PATH_0_value": "en-us"`
        * `"PATH_1_value": "apps"`
        * `"PATH_2_value": "banking"`
            
        したがって、`[PATH_0_value, PATH_1_value]`の一意性条件は、パスの第1要素と第2要素に異なる値が含まれるリクエストで満たされます。

        * `example.com/en-us/apps/banking/charge.php` は一意なリクエストです。
        * `example.com/en-us/apps/banking/vip/charge.php` は一意なリクエストではありません。
        * `example.com/de-de/apps/banking/vip/charge.php` は一意なリクエストです。
    
* **`- testrun`**
    
    テストリクエストの作成に成功した場合（つまり、他のすべてのフェーズを通過した場合）、テスト実行につき1回だけ拡張が実行されます。
    
    例えば、受信したベースラインリクエストがMatchフェーズで破棄されるためにテストリクエストを生成できない場合、Collectフェーズの拡張は、いずれかのベースラインリクエストがMatchフェーズを通過し、それに基づいて対象アプリケーション向けのテストリクエストが作成されるまで、ベースラインリクエストの収集を継続します。
    
    `testrun`パラメータを使用する場合、`uniq`リストでリクエスト要素を使用することはできません。`uniq`の一意性条件は単一の要素のみで構成されます。
    
    ```
    collect:
      - uniq:
        - testrun 
    ```
    
    `uniq`リストに複数の要素がある場合、ベースラインリクエストを一意と定義するためには、リクエストに`uniq`リストのうち少なくとも1つの一意なパラメータが含まれている必要があります。 



!!! info "Collectフェーズのパラメータ"
    現時点では、Collectフェーズでサポートされるのは受信したベースラインリクエストに対する一意性条件のみです。将来的に、このフェーズの機能が拡張される可能性があります。