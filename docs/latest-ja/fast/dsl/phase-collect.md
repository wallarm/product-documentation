```markdown
[link-points]:          points/intro.md
[link-ruby-regexp]:     http://ruby-doc.org/core-2.6.1/doc/regexp_rdoc.html
[link-ext-logic]:       logic.md

[img-collect-uniq]:    ../../images/fast/dsl/en/phases/collect-uniq.png

# 収集フェーズ

!!! info "フェーズの範囲"
    このフェーズは変更拡張で使用され、運用上は任意です（YAMLファイルの`collect`セクションは存在しない場合もありますし、存在する場合もあります）。

    また、このフェーズは一意性条件を利用する非変更拡張でも暗黙的に使用されます。

    拡張タイプの詳細については [こちら][link-ext-logic] をご覧ください。

!!! info "リクエスト要素記述の構文"
    FAST拡張を作成するにあたり、アプリケーションに送信されるHTTPリクエストの構造およびアプリケーションから受信されるHTTPレスポンスの構造を理解して、ポイントを使用して作業するリクエスト要素を正しく記述する必要があります。

    詳細については [こちら][link-points] をご参照ください。

このフェーズは、指定された条件を満たすすべてのベースラインリクエストを収集します。リクエストを収集するかどうかの判断には、テストラン中にすでに収集されたリクエストの情報が利用されます。

ベースラインリクエストの収集処理はリアルタイムで実施されます。各リクエストは、FASTノードがベースラインリクエストを書き込む順番に従って処理されます。リクエストの書き込み処理が完了するのを待たずに、各リクエストは収集フェーズで逐次処理・収集されます。

## 一意性条件

一意性条件は、指定された基準に従って一意でないベースラインリクエストが残りのフェーズの処理に進むことを許可しません。これらの除外されたリクエストに対してはテストリクエストは生成されません。同一タイプのベースラインリクエストが複数届いた場合、ターゲットアプリケーションの負荷軽減に有用です。

受信された各リクエストの一意性は、以前に受信されたリクエストのデータに基づいて判断されます。

![一意性条件付きのCollectフェーズ][img-collect-uniq]

ベースラインリクエストの一意性を判定するために使用されるリクエスト内の要素のリストは、一意性条件で定義されます。

ベースラインリクエストを受信すると、収集フェーズの拡張機能はリスト内の各リクエスト要素に対して以下の処理を行います：
1. ベースラインリクエストに該当する要素が存在しない場合は、リストの次の要素へ進みます。
2. ベースラインリクエストに該当する要素が存在し、その要素のデータが一意である場合（すなわち、以前に受信したベースラインリクエストのデータと一致しない場合）、このベースラインリクエストは一意と見なされ、次のフェーズへ移行されます。このリクエスト要素のデータは記憶されます。
3. ベースラインリクエストに該当する要素が存在し、その要素のデータが一意でない場合（すなわち、以前に受信したベースラインリクエストのデータと一致する場合）、このベースラインリクエストは一意性条件を満たさないため破棄されます。このリクエストに対しては拡張機能は実行されません。
4. リストの終端に達した時点で一意性を確認可能なリクエスト要素が見つからなかった場合、このベースラインリクエストは破棄されます。このリクエストに対しては拡張機能は実行されません。

拡張機能のYAMLファイルの`collect`セクション内で、ベースラインリクエストの一意性を定義するための要素を含む`uniq`リストを使用して、一意性条件を記述できます。

```
collect:
  - uniq:
    - [request element]
    - [request element 1, request element 2, …, request element N]
    - testrun
```  

リスト内のリクエスト要素には[Ruby正規表現形式の正規表現][link-ruby-regexp]を含めることができます。

`uniq`一意性条件は、ベースラインリクエストの一意性判定に使用されるデータを含むリクエスト要素の配列で構成されます。また、`testrun`パラメータも使用できます。

一意性条件のパラメータは以下の通りです：

* **`- [request element]`**
    
    リクエストが一意と見なされるためには、該当するリクエスト要素に一意なデータが含まれている必要があります。
    
    ??? info "例"
        `- [GET_uid_value]` — リクエストの一意性は`uid` GETパラメータのデータによって定義されます（すなわち、`uid` GETパラメータの一意な値を持つ各ベースラインリクエストに対して拡張機能が実行される必要があります）。

        * `example.com/example/app.php?uid=1` は一意なリクエストです。
        * `example.com/demo/app.php?uid=1` は一意なリクエストではありません。
        * `example.com/demo/app.php?uid=` は一意なリクエストです。
        * `example.org/billing.php?uid=1` は一意なリクエストではありません。
        * `example.org/billing.php?uid=abc` は一意なリクエストです。

* **`- [request element 1, request element 2, …, request element N]`**
    
    リクエストはN個の要素のセットを含み、これら各セットのリクエスト要素のデータが一意である必要があります。
    
    ??? info "例 1"
        `- [GET_uid_value, HEADER_COOKIE_value]` — リクエストの一意性は`uid` GETパラメータのデータおよび`Cookie` HTTPヘッダーのデータによって決定されます（すなわち、`uid` GETパラメータと`Cookie`ヘッダーの一意な値を持つ各ベースラインリクエストに対して拡張機能が実行される必要があります）。

        * `example.org/billing.php?uid=1, Cookie: client=john` は一意なリクエストです。
        * `example.org/billing.php?uid=1, Cookie: client=ann` は一意なリクエストです。
        * `example.com/billing.aspx?uid=1, Cookie: client=john` は一意なリクエストではありません。
    
    ??? info "例 2"
        `- [PATH_0_value, PATH_1_value]` — パスの最初と二番目の要素のペアによってリクエストの一意性を定義します（すなわち、`PATH_0`および`PATH_1`パラメータを含むペアの一意な値を持つ各ベースラインリクエストに対して拡張機能が実行される必要があります）。
            
        Wallarmは要素処理中にリクエスト要素の解析を行います。`/en-us/apps/banking/`のようなURIパスの場合、Pathパーサーは各パス要素をPATH配列に格納します。
            
        それぞれの配列要素の値にはインデックスを使用してアクセスできます。先述の`/en-us/apps/banking/`パスでは、パーサーは以下のデータを提供します：

        * `"PATH_0_value": "en-us"`
        * `"PATH_1_value": "apps"`
        * `"PATH_2_value": "banking"`
            
        したがって、`[PATH_0_value, PATH_1_value]`の一意性条件は、パスの最初および二番目の要素に異なる値が含まれるリクエストで満たされます。

        * `example.com/en-us/apps/banking/charge.php` は一意なリクエストです。
        * `example.com/en-us/apps/banking/vip/charge.php` は一意なリクエストではありません。
        * `example.com/de-de/apps/banking/vip/charge.php` は一意なリクエストです。
    
* **`- testrun`**
    
    テストリクエストが正常に作成された場合（すなわち、他のすべてのフェーズを通過した場合）、拡張機能はテストランで一度だけ実行されます。
    
    例えば、Matchフェーズでベースラインリクエストが破棄されたために、受信したベースラインリクエストに基づくテストリクエストが生成できない場合、収集フェーズの拡張機能はMatchフェーズを通過してターゲットアプリケーション向けのテストリクエストが作成されるまで、ベースラインリクエストの収集を続けます。
    
    すでに`testrun`パラメータを使用している場合、`uniq`リスト内のリクエスト要素と併用することはできません。`uniq`一意性条件は単一の要素となります。
    
    ```
    collect:
      - uniq:
        - testrun 
    ```
    
    もし`uniq`リストに複数の要素が存在する場合、ベースラインリクエストを一意と見なすためには`uniq`リスト内の少なくとも1つの一意なパラメータがリクエストに含まれている必要があります。

!!! info "Collectフェーズのパラメータ"
    現時点では、収集フェーズでは受信されたベースラインリクエストに対する一意性条件のみがサポートされています。将来的には、このフェーズの機能が拡張される可能性があります。
```