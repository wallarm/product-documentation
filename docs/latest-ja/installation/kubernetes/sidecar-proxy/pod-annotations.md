# Wallarm SidecarがサポートするPodのアノテーション

[Wallarm Sidecar solution](deployment.md)は、Podごとのアノテーションを通じて設定できます。本書には、当ソリューションがサポートするアノテーションの一覧が記載されています。

!!! info "グローバル設定とPodごとの設定の優先順位"  
    Podごとのアノテーションは、Helmチャートの値よりも[優先されます](customization.md#configuration-area).

## アノテーション一覧

| アノテーションと対応するチャート値                          | 説明                                                      | 
|-------------------------------------|------------------------------------------------------------------|
| **Annotation:** `sidecar.wallarm.io/sidecar-injection-schema`<br><br>`config.injectionStrategy.schema` | [Wallarmコンテナの展開パターン](customization.md#single-and-split-deployment-of-containers)：`single`（デフォルト）または`split`.                                                                                                                                                                                                                                                                     |
| **Annotation:** `sidecar.wallarm.io/sidecar-injection-iptables-enable`<br><br>`config.injectionStrategy.iptablesEnable` | [`iptables` init コンテナを起動するかどうか](customization.md#capturing-incoming-traffic-port-forwarding)：`true`（デフォルト）または`false`.                                                                                                                                                                                                                                |
| **Annotation:** `sidecar.wallarm.io/wallarm-application`<br><br>チャート値なし      | [WallarmアプリケーションID][applications-docs].                                                                                                                                                                                                                                                                           |
| **Annotation:** `sidecar.wallarm.io/wallarm-block-page`<br><br>チャート値なし | ブロックされたリクエストに返す[ブロックページとエラーコード][custom-blocking-page-docs].                                                                                                                                                        |
| **Annotation:** `sidecar.wallarm.io/wallarm-enable-libdetection`<br><br>`config.wallarm.enableLibDetection`                         | SQLインジェクション攻撃を[libdetection][libdetection-docs]ライブラリで追加検証するかどうか：`on`（デフォルト）または`off`.                                                                                                                                                                                                             |
| **Annotation:** `sidecar.wallarm.io/wallarm-fallback`<br><br>`config.wallarm.fallback`                                          | [Wallarmフォールバックモード][fallback-mode-docs]：`on`（デフォルト）または`off`. |
| **Annotation:** `sidecar.wallarm.io/wallarm-mode`<br><br>`config.wallarm.mode`                                              | [トラフィックフィルトレーションモード][wallarm-modes-docs]：`monitoring`（デフォルト）、`safe_blocking`、`block`または`off`.                                                                                                                                                                                                                                                                       |
| **Annotation:** `sidecar.wallarm.io/wallarm-mode-allow-override`<br><br>`config.wallarm.modeAllowOverride`                                 | [Cloudでの設定を介して`wallarm_mode`の値を上書きできるかどうかを管理します][filtration-mode-priorities-docs]：`on`（デフォルト）、`off`または`strict`.                                                                                                                                                                                       |
| <a name="wallarm-node-group"></a>**Annotation:** `sidecar.wallarm.io/wallarm-node-group`<br><br>`config.wallarm.api.nodeGroup`                                 | 新たに展開されるノードを追加するフィルタリングノードグループの名前を指定します。この方法によるノードのグルーピングは、**Deploy**ロールを持つAPIトークンを使用してCloudにノードを作成して接続する場合にのみ利用可能です（その値は`config.wallarm.api.token`パラメータに渡されます）。<br>この値はTarantool podには適用されず、Tarantool podのノードは常に`config.wallarm.api.nodeGroup` Helmチャート値で指定されたノードグループにリンクされます.                                                                                                                                                                                      |
| **Annotation:** `sidecar.wallarm.io/wallarm-parser-disable`<br><br>チャート値なし                                                               | [パーサ][parsers-docs]を無効化できます。ディレクティブの値は無効にするパーサの名前に対応し、例：`json`です。複数のパーサを指定する場合はセミコロンで区切ります。例：`json;base64`.                                                                                                                     |
| **Annotation:** `sidecar.wallarm.io/wallarm-parse-response`<br><br>`config.wallarm.parseResponse`                                     | 攻撃検出のためにアプリケーションのレスポンスを解析するかどうか：`on`（デフォルト）または`off`. レスポンス解析は、[パッシブ検出][passive-detection-docs]および[脅威再現テスト][active-threat-verification-docs]中の脆弱性検出に必要です.                                                                                                                                                                                                                                            |
| **Annotation:** `sidecar.wallarm.io/wallarm-acl-export-enable`<br><br>`config.wallarm.aclExportEnable`                                     | ノードからCloudへ[denylisted][denylist-docs] IPからのリクエストに関する統計情報を送信するかどうかを、有効`on`または無効`off`で設定します。<ul><li>`on`値（デフォルト）の場合、denylisted IPからのリクエストに関する統計情報が**Attacks**セクションに[表示されます][denylist-view-events-docs]。</li><li>`off`値の場合、denylisted IPからのリクエストに関する統計情報は表示されません。</li></ul>                                                                                                                                |
| **Annotation:** `sidecar.wallarm.io/wallarm-parse-websocket`<br><br>`config.wallarm.parseWebsocket`                                    | Wallarmは完全なWebSocketサポートを提供します。デフォルトではWebSocketメッセージは攻撃解析されません。機能を強制するには、API Securityの[サブスクリプションプラン][subscriptions-docs]を有効にし、このアノテーションを使用して`on`または`off`（デフォルト）を指定します.                                                                                                                                                                                                                                                 |
| **Annotation:** `sidecar.wallarm.io/wallarm-unpack-response`<br><br>`config.wallarm.unpackResponse`                                    | アプリケーションレスポンスで返される圧縮データの解凍を行うかどうか：`on`（デフォルト）または`off`.                                                                                                                                                                                                                          |
| **Annotation:** `sidecar.wallarm.io/wallarm-upstream-connect-attempts`<br><br>`config.wallarm.upstream.connectAttempts`                          | TarantoolまたはWallarm APIへの即時再接続の回数を定義します.                                                                                                                                                                                                                                         |
| **Annotation:** `sidecar.wallarm.io/wallarm-upstream-reconnect-interval`<br><br>`config.wallarm.upstream.reconnectInterval`                        | 即時再接続の回数の閾値を超えた後、TarantoolまたはWallarm APIへの再接続試行間隔を定義します.                                                                                                                                                                                                                                |
| **Annotation:** `sidecar.wallarm.io/application-port`<br><br>`config.nginx.applicationPort`                                     | 公開されているアプリケーションpodのポートが見つからない場合、Wallarmコンテナはこのポートへの着信リクエストを待機します（[詳細](customization.md#application-container-port-auto-discovery)）.                                                                                             |
| **Annotation:** `sidecar.wallarm.io/nginx-listen-port`<br><br>`config.nginx.listenPort`                                          | Wallarmコンテナがリッスンするポートです。このポートはWallarm sidecar solution専用であり、`application-port`と同じにはできません.                                                                                                                                                                 |
| **Annotation:** `sidecar.wallarm.io/nginx-http-include`<br><br>チャート値なし                                                               | NGINXの設定ファイルのパスの配列で、[NGINX構成の`http`レベルにインクルード](customization.md#using-custom-nginx-configuration)されるものです。ファイルはコンテナにマウントされ、このパスはコンテナ内のファイルを指す必要があります.                                                                                                            |
| **Annotation:** `sidecar.wallarm.io/nginx-http-snippet`<br><br>チャート値なし                                                               | NGINX構成の`http`レベルに含める[追加のインライン設定](customization.md#using-custom-nginx-configuration)です.                                                                                                                                      |
| **Annotation:** `sidecar.wallarm.io/nginx-server-include`<br><br>チャート値なし                                                               | NGINXの設定ファイルのパスの配列で、[NGINX構成の`server`レベルにインクルード](customization.md#using-custom-nginx-configuration)されるものです。ファイルはコンテナにマウントされ、このパスはコンテナ内のファイルを指す必要があります.                                                                                                            |
| **Annotation:** `sidecar.wallarm.io/nginx-server-snippet`<br><br>チャート値なし                                                               | NGINX構成の`server`レベルに含める[追加のインライン設定](customization.md#using-custom-nginx-configuration)です.                                                                                                                                      |
| **Annotation:** `sidecar.wallarm.io/nginx-location-include`<br><br>チャート値なし                                                               | NGINXの設定ファイルのパスの配列で、[NGINX構成の`location`レベルにインクルード](customization.md#using-custom-nginx-configuration)されるものです。ファイルはコンテナにマウントされ、このパスはコンテナ内のファイルを指す必要があります.                                                                                                            |
| **Annotation:** `sidecar.wallarm.io/nginx-location-snippet`<br><br>チャート値なし                                                               | NGINX構成の`location`レベルに含める[追加のインライン設定](customization.md#using-custom-nginx-configuration)です.                                                                                                                                      |
| **Annotation:** `sidecar.wallarm.io/nginx-extra-modules`<br><br>チャート値なし                                                               | 有効にする[追加のNGINXモジュール](customization.md#enabling-additional-nginx-modules)の配列です.                                                                                                                                                                                                                  |
| **Annotation:** `sidecar.wallarm.io/nginx-worker-connections`<br><br>`config.nginx.workerConnections`                                                   | NGINXワーカープロセスが開くことのできる同時接続の最大数（[詳細](http://nginx.org/en/docs/ngx_core_module.html#worker_connections)）。デフォルトでは、チャート値は`4096`に設定されています.                                                                                                                                                                                                                    |
| **Annotation:** `sidecar.wallarm.io/nginx-worker-processes`<br><br>`config.nginx.workerProcesses`                                                   | [NGINXワーカープロセス数](http://nginx.org/en/docs/ngx_core_module.html#worker_processes)。デフォルトでは、チャート値は`auto`に設定されており、これはワーカーの数がCPUコア数に合わせて設定されることを意味します.                                                                                                                                                                                                                    |
| **Annotation:** `sidecar.wallarm.io/proxy-extra-volumes`<br><br>チャート値なし                                                               | Podに追加する[カスタムボリューム](customization.md#include)の配列。アノテーション値はシングルクォート`''`で囲む必要があります.                                                                                                                                                                                  |
| **Annotation:** `sidecar.wallarm.io/proxy-extra-volume-mounts`<br><br>チャート値なし                                                               | `sidecar-proxy`コンテナに追加する[カスタムボリュームマウント](customization.md#include)のJSONオブジェクト。アノテーション値はシングルクォート`''`で囲む必要があります.                                                                                                                                                                              |
| **Annotation:** `sidecar.wallarm.io/proxy-cpu`<br><br>`config.sidecar.containers.proxy.resources.requests.cpu`           | `sidecar-proxy`コンテナの[要求CPU](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                                |
| **Annotation:** `sidecar.wallarm.io/proxy-memory`<br><br>`config.sidecar.containers.proxy.resources.requests.memory`        | `sidecar-proxy`コンテナの[要求メモリ](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                             |
| **Annotation:** `sidecar.wallarm.io/proxy-cpu-limit`<br><br>`config.sidecar.containers.proxy.resources.limits.cpu`             | `sidecar-proxy`コンテナの[CPU制限](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                                    |
| **Annotation:** `sidecar.wallarm.io/proxy-memory-limit`<br><br>`config.sidecar.containers.proxy.resources.limits.memory`          | `sidecar-proxy`コンテナの[メモリ制限](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                                 |
| **Annotation:** `sidecar.wallarm.io/helper-cpu`<br><br>`config.sidecar.containers.helper.resources.requests.cpu`          | `sidecar-helper`コンテナの[要求CPU](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                               |
| **Annotation:** `sidecar.wallarm.io/helper-memory`<br><br>`config.sidecar.containers.helper.resources.requests.memory`       | `sidecar-helper`コンテナの[要求メモリ](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                            |
| **Annotation:** `sidecar.wallarm.io/helper-cpu-limit`<br><br>`config.sidecar.containers.helper.resources.limits.cpu`            | `sidecar-helper`コンテナの[CPU制限](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                                  |
| **Annotation:** `sidecar.wallarm.io/helper-memory-limit`<br><br>`config.sidecar.containers.helper.resources.limits.memory`         | `sidecar-helper`コンテナの[メモリ制限](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                                |
| **Annotation:** `sidecar.wallarm.io/init-iptables-cpu`<br><br>`config.sidecar.initContainers.iptables.resources.requests.cpu`    | `sidecar-init-iptables`コンテナの[要求CPU](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                        |
| **Annotation:** `sidecar.wallarm.io/init-iptables-memory`<br><br>`config.sidecar.initContainers.iptables.resources.requests.memory` | `sidecar-init-iptables`コンテナの[要求メモリ](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                     |
| **Annotation:** `sidecar.wallarm.io/init-iptables-cpu-limit`<br><br>`config.sidecar.initContainers.iptables.resources.limits.cpu`      | `sidecar-init-iptables`コンテナの[CPU制限](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                            |
| **Annotation:** `sidecar.wallarm.io/init-iptables-memory-limit`<br><br>`config.sidecar.initContainers.iptables.resources.limits.memory`   | `sidecar-init-iptables`コンテナの[メモリ制限](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                         |
| **Annotation:** `sidecar.wallarm.io/init-helper-cpu`<br><br>`config.sidecar.initContainers.helper.resources.requests.cpu`      | `sidecar-init-helper`コンテナの[要求CPU](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                          |
| **Annotation:** `sidecar.wallarm.io/init-helper-memory`<br><br>`config.sidecar.initContainers.helper.resources.requests.memory`   | `sidecar-init-helper`コンテナの[要求メモリ](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                       |
| **Annotation:** `sidecar.wallarm.io/init-helper-cpu-limit`<br><br>`config.sidecar.initContainers.helper.resources.limits.cpu`        | `sidecar-init-helper`コンテナの[CPU制限](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                              |
| **Annotation:** `sidecar.wallarm.io/init-helper-memory-limit`<br><br>`config.sidecar.initContainers.helper.resources.limits.memory`     | `sidecar-init-helper`コンテナの[メモリ制限](customization.md#per-pod-settings)です.                                                                                                                                                                                                                                                                           |
| **Annotation:** `sidecar.wallarm.io/profile`<br><br>チャート値なし | このアノテーションは、[TLS/SSL終端](customization.md#ssltls-termination)のためにアプリケーションpodに特定のTLSプロファイルを割り当てるために使用されます。<br><br>このアノテーションとTLS/SSL終端はHelmチャート4.6.1以降でサポートされています. |

Wallarmがサポートする[NGINXディレクティブ][nginx-directives-docs]には直接のアノテーションでカバーされていないものもありますが、[`nginx-*-snippet`および`nginx-*-include`アノテーション](customization.md#using-custom-nginx-configuration)を使用してこれらも設定可能です。

## アノテーションの使用方法

アプリケーション構成の該当するDeploymentオブジェクトの設定にアノテーションを指定してPodに適用します。例:

```bash
kubectl edit deployment -n <APPLICATION_NAMESPACE> <APP_LABEL_VALUE>
```

```yaml hl_lines="17"
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
        wallarm-sidecar: enabled
      annotations:
        sidecar.wallarm.io/wallarm-mode: block
    spec:
      containers:
        - name: application
          image: kennethreitz/httpbin
          ports:
            - name: http
              containerPort: 80
```