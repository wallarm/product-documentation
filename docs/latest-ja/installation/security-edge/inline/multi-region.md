# Security Edge Inlineのマルチクラウドおよびマルチリージョンデプロイメント <a href="../../../../about-wallarm/subscription-plans/#security-edge-paid-plan"><img src="../../../../images/security-edge-tag.svg" style="border: none;"></a>

インラインEdge Nodeを複数リージョンおよび複数クラウドプロバイダにデプロイして、地理的冗長性と低レイテンシを実現できます。

[Security Edgeを構成](deployment.md)する際、サポートされているクラウドプロバイダ（AWSとAzure）にまたがって1つ以上のリージョンを選択できます。

## マルチリージョンデプロイメント

単一のクラウドプロバイダ内で複数リージョンを選択した場合、トラフィックはレイテンシに基づいてルーティングされ、各リクエストは最寄りの利用可能なリージョンに送られます。

これは最も一般的な構成であり、複数の場所からリクエストを処理する場合に推奨されます。

![!](../../../images/waf-installation/security-edge/inline/multi-region-edge-nodes.png)

利用可能なリージョンはご利用の[Wallarm Cloud](../../../about-wallarm/overview.md#cloud)に依存します（US→USリージョン、EU→EUリージョン）。

## マルチクラウドデプロイメント

複数のクラウドプロバイダにまたがる複数リージョンを選択した場合、レイテンシに関係なく、すべてのリクエストは選択したリージョンとプロバイダ間で[ラウンドロビン](https://en.wikipedia.org/wiki/Round-robin_DNS)方式により分散されます。

この構成は次のケースで推奨されます:

* クラウドプロバイダの冗長化: トラフィックが選択したすべてのプロバイダに分散され、1つが利用不能になっても（例: AWS）、他のプロバイダ（例: Azure）が中断なくトラフィック処理を継続します。
* リージョンの高可用性: 例えば、`AWS US East 1`と`Azure East US`の両方を選択すると、リージョン間でトラフィックのバランスが維持され、いずれかのリージョンまたはプロバイダが利用不能になってもサービスが継続します。

![!](../../../images/waf-installation/security-edge/inline/multi-cloud-edge-nodes.png)

## オリジンアクセスのためのWallarm IP範囲

Security Edgeからオリジンへの接続は[mTLS](mtls.md)で保護することを推奨します。これにより、WallarmのIPが変更された際にIP許可リストを更新する必要がなくなります。

mTLSを使用できない場合は、選択したリージョンのWallarm IPアドレスからの受信トラフィックを許可してください。

* AWS

    === "米国東部1"
        ```
        18.215.213.205
        44.214.56.120
        44.196.111.152
        ```
    === "米国西部1"
        ```
        52.8.91.20
        13.56.117.139
        54.177.237.34
        50.18.177.184
        ```
    === "EU中部1（フランクフルト）"
        ```
        18.153.123.2
        18.195.202.193
        3.76.66.246
        3.79.213.212
        ```
    === "EU中部2（チューリッヒ）"
        ```
        51.96.131.55
        16.63.191.19
        51.34.0.90
        51.96.67.145
        ```

* Azure

    === "米国東部2"
        ```
        20.65.88.253
        20.65.88.252
        ```
    === "米国西部3"
        ```
        20.38.2.233
        20.38.2.232
        ```
    === "ドイツ西中部"
        ```
        20.79.250.104
        20.79.250.105
        ```
    === "スイス北部"
        ```
        20.203.240.193
        20.203.240.192
        ```

## CNAMEレコード

保護対象ホストが第3レベル以上のドメイン（例: `api.example.com`）である場合、DNSゾーンに[Wallarmが提供するFQDNを指すCNAMEレコードを指定](deployment.md#6-routing-traffic-to-the-edge-node)する必要があります。このレコードは**Traffic CNAME**として返されます。

* 単一クラウドのデプロイメント: 選択したクラウドプロバイダ用の**Traffic CNAME**を使用します。
* マルチクラウドデプロイメント: すべての選択したリージョンとプロバイダにトラフィックを自動分散するために**Traffic CNAME (Global)**を使用します。

    特定のプロバイダにルーティングを固定する必要がある場合は、プロバイダ別のCNAMEも利用できます。例えば、プロバイダ間のレイテンシやパフォーマンスをテストする目的です。

![](../../../images/waf-installation/security-edge/inline/traffic-cname.png)

## Aレコード

保護対象ホストがApexドメイン（例: `example.com`）の場合、CNAMEは使用できません。この場合、DNS設定では**Aレコード**を使用する必要があり、デプロイメントが[**Active**](upgrade-and-management.md#statuses)になると返されます。

Edge Nodeのデプロイメントに複数のリージョンまたはプロバイダを選択した場合は、返されたすべてのAレコードをDNSゾーンに設定する必要があります。

![](../../../images/waf-installation/security-edge/inline/a-records.png)

この場合のトラフィックのルーティングはDNSプロバイダによって管理されます。既定では、ほとんどのDNSプロバイダは[ラウンドロビン](https://en.wikipedia.org/wiki/Round-robin_DNS)のロジックを使用しますが、レイテンシベースのルーティングをサポートしている場合もあります。

## クラウドプロバイダまたはリージョンの削除

* クラウドプロバイダを削除する前に、DNS設定を[残存プロバイダのTraffic CNAME](#cname-records)を使用するよう切り替えてください。

    クラウドプロバイダを削除すると、その**Traffic CNAME**は削除されます。
    
    プロバイダが1つだけ残る場合、**Traffic CNAME (Global)**も削除され、使用できなくなります。
* リージョンを削除する前に、該当する[Aレコード](#a-records)を更新してください。

    リージョンを削除すると、関連するAレコードは利用できなくなります。