# アクティブ脅威検証モジュールのカスタマイズ <a href="../../../about-wallarm/subscription-plans/#subscription-plans"><img src="../../../images/api-security-tag.svg" style="border: none;"></a>

カスタムルールセットは、[アクティブ脅威検証](../../about-wallarm/detecting-vulnerabilities.md#active-threat-verification)モジュールの次の設定を変更するために使用できます：

* アプリケーション全体またはその一部のモジュールを無効にします（モジュールがWallarm Console → **スキャナー**の全てのアプリケーションで有効になっている場合に限ります）。
* 攻撃の再生前にリクエストを書き換えます。

## アクティブ脅威検証モジュールの無効化/有効化

### ルールの概要

**アクティブ脅威検証のモード設定**ルールは、特定のアプリケーション、ドメイン、またはURLの[アクティブ脅威検証](../../about-wallarm/detecting-vulnerabilities.md#active-threat-verification)モジュールのモードを変更するために使用されます。このモジュールがWallarm Console → **脆弱性** → **設定**で全体的に有効になっている場合、この設定が可能です。

### ルールの作成と適用

ルールを作成して適用するには：

1. Wallarm Consoleの**ルール**セクションで、**アクティブ脅威検証のモード設定**ルールを作成します。このルールは、以下のコンポーネントで構成されます：

      * **Condition** [は、ルールを適用するエンドポイントを](add-rule.md#branch-description)説明します。
      * **無効化/有効化**は、指定されたエンドポイントへ送信される攻撃に対する**アクティブ脅威検証**モジュールのモードを設定します。

        モジュールを無効化するルールの例外を設定するためにのみ**有効化**モードを使用してください（例：`https://example.com/module/user/*`で既に無効になっている場合に、`https://example.com/module/user/create`のモジュールを有効にするため）。
2. [カスタムルールセットのコンパイルが完了する](compiling.md)のを待つ。

### ルールの例

`https://example.com/module/user/*`の**アクティブ脅威検証**モジュールを無効化する**アクティブ脅威検証のモード設定**ルールは以下のようになります：

![!アクティブ脅威検証のモード設定ルールの例](../../images/user-guides/rules/disable-active-threat-verification-example.png)

上記のルールがすでに設定されている場合、次のルールでは`https://example.com/module/user/create`の**アクティブ脅威検証**モジュールを有効にします：

![!アクティブ脅威検証のモード設定ルールの例](../../images/user-guides/rules/disable-active-threat-verification-deeper-path-example.png)

## 攻撃再生前のリクエストの書き換え

### ルールの概要

**攻撃再生前の書き換え**ルールは、[攻撃の再生](../../about-wallarm/detecting-vulnerabilities.md#active-threat-verification)前にオリジナルのリクエスト要素を変更するために使用されます。次の要素を変更することができます：

* リクエスト認証データを含むヘッダーを[オリジナルの認証データをテストデータで置き換える](#オリジナルの認証データをテストデータで置き換える)。
* ヘッダー`HOST`。たとえば、ヘッダー`HOST`は攻撃を再生するために[ステージングまたはテスト環境](#攻撃再生のためのアプリケーションアドレスの変更)に変更することができます。
* パスを[攻撃の再生に使用されるアプリケーションアドレスを書き換える](#攻撃再生のためのアプリケーションアドレスの変更)。

!!! warning "オリジナルリクエスト要素の任意の変更"
    **攻撃再生前の書き換え**ルールはオリジナルリクエストのヘッダー(`header`)とパス(`uri`)のみを変更することができます。他のリクエスト要素は変更または追加することはできません。

#### オリジナルの認証データをテストデータで置き換える

認証パラメーターがオリジナルのリクエストで渡された場合、**攻撃再チェッカー**モジュールはこれらのパラメーターを削除し、それらなしで攻撃を再生します。認証パラメーターが保護されたアプリケーションAPIにアクセスするために必要な場合、コード`401`または他のコードが再生された攻撃への応答として返されます。返されたコードが脆弱性の兆候を示さないため、**攻撃再チェッカー**モジュールはリクエストに認証パラメーターが渡されていれば検出できる脆弱性を検出することができません。

必要な認証パラメーターを含むオリジナルのリクエストを再生するために、**攻撃再生前の書き換え**ルールを使用して、これらのパラメーターのテスト値を追加することができます。例：APIキー、トークン、パスワード、または他のパラメーター。

!!! info "テスト認証データの再利用"
    Wallarmモジュール**攻撃再チェッカー**のみが使用するテスト認証資格情報を生成することをお勧めします。

#### 攻撃再生のためのアプリケーションアドレスの変更

デフォルトでは、再生される攻撃はオリジナルのリクエストで渡されたアプリケーションアドレスとパスに送信されます。オリジナルのアドレスとパスを、攻撃の再生時に使用される他の値で置き換えることができます。**攻撃再生前の書き換え**ルールを使用して、値は以下のように置き換えられます：

* ヘッダー`HOST`のオリジナルの値を、別のアプリケーションインスタンスアドレスで置き換えます。例えば、別のアプリケーションインスタンスはステージングまたはテスト環境である可能性があります。
* オリジナルのリクエストのパスを、テスト環境またはステージングへのパス、または攻撃の再生時にプロキシサーバーをバイパスするターゲットサーバーへのパスで置き換えます。

`HOST`ヘッダーの値とオリジナルのリクエストのパスの両方を置き換えるには、アクションタイプが**攻撃再生前の書き換え**の2つの別々のルールを作成する必要があります。

### ルールの作成と適用

--8<-- "../include/waf/features/rules/rule-creation-options.md"

**规则**セクションでルールを作成して適用するには：

1. Wallarm Consoleの**ルール**セクションで、**攻撃再生前の書き換え**ルールを作成します。このルールは以下のコンポーネントを含みます：

      * **Condition** [は、ルールを適用するエンドポイントを](add-rule.md#branch-description)説明します。
      * **Rules**は、**リクエストの一部**フィールドで選択されたパラメーターの新しい値を設定します。セットした値は攻撃の再生時に使用されます。

        値をデコードし、[テンプレート言語Liquid](https://shopify.github.io/liquid/)を使用して次のように設定する必要があります：二重カーリーブレース`{{}}`と単引用符`''`で囲まれた状態で。例：`{{'example.com'}}`。

        オリジナルのリクエスト(`uri`)のパスを置き換える場合、新しいパスの全値を渡す必要があります。

      * **Part of request**は攻撃の再生前に変更されるべきオリジナルのリクエスト要素を指定します。

        !!! warning "**Part of request**フィールドの可能な値"
            **Part of request**フィールドの可能な値は`header`（リクエストヘッダー）と`uri`（リクエストパス）です。

2. [ルールのコンパイルが完了する](compiling.md)のを待つ。

オリジナルのリクエストの変更に対するいくつかの条件を設定するため、またはいくつかのリクエスト要素の値を置き換えるために、いくつかのルールを作成することが可能です。

### ルールの例

* `example.com`へ送信された攻撃を再生するとき、`COOKIE`ヘッダーで`PHPSESSID=mntdtbgt87j3auaq60iori2i63; security=low`の値を渡します。

    ヘッダー値の形式は`{{'PHPSESSID=mntdtbgt87j3auaq60iori2i63; security=low'}}`です。

    ![!COOKIEを変更するルールの例](../../images/user-guides/rules/rewrite-request-example-cookie.png)

* 元々`example.com`に送信された攻撃をテスト環境の`example-test.env.srv.loc`で再生します。

    アドレスの形式は`{{'example-test.env.srv.loc'}}`です。

    ![!HOSTを変更するルールの例](../../images/user-guides/rules/rewrite-request-example-host.png)
