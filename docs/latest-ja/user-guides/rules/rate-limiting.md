# レート制限の設定

レートの制限がないことは、[OWASP API Top 10 2019](https://github.com/OWASP/API-Security/blob/master/editions/2019/en/0xa4-lack-of-resources-and-rate-limiting.md) に記載されている最も深刻な API セキュリティリスクの一つに含まれています。適切なレート制限措置がないと、API は DoS（Denial-of-Service：サービス拒否）、ブルートフォース攻撃やAPIの過剰使用などの攻撃に対して脆弱となります。本記事は、Wallarm のレート制限規則でAPIとユーザーを保護する方法について説明します。

Wallarm は、APIへの過度なトラフィックを防ぐための**レート制限設定**ルールを提供しています。このルールを使用すると、特定の範囲に対して接続できる最大数を指定し、同時に入力リクエストが均等に分散されることを保証することができます。リクエストが定義された制限を超える場合、Wallarmはそれを拒否し、ルールで選択したコードを返します。

WallarmはクッキーやJSONフィールドなどのさまざまなリクエストパラメーターを調査します。これにより、制限を設定する際に、発信元IPアドレスだけでなく、セッション識別子、ユーザー名、またはメールアドレスに基づいて接続を制限することも可能になります。このような追加の粒度レベルは、任意の起源データに基づいてプラットフォームの全体的なセキュリティを強化するのに役立ちます。

## ルールの作成と適用

レート制限を設定し適用するには：

1. Wallarmコンソール → **ルール** → **ルールの追加**へ進んでください。
1. **リクエストが** で、ルールを適用する範囲を[記述](rules.md#rule-branches)します。
1. **そのとき**で、**レート制限を設定**を選び、範囲への接続に対する希望の制限を設定します：

    * 秒または分あたりのリクエストの最大数。
    * **バースト** -指定されたRPS/RPMを超えた際にバッファリングする過剰なリクエストの最大数。これは、レートが通常に戻った際に処理するためです。デフォルトは `0`。

        値が `0` と異なる場合、バッファリングした過剰なリクエストの実行間で定義されたRPS/RPMを保つかどうかを制御できます。

        **遅延なし**は、すべてのバッファリングされた過剰なリクエストを同時に処理することを指し、レート制限遅延はありません。 **遅延**は、指定された数の過剰なリクエストを同時に処理し、他のリクエストはRPS/RPMで設定した遅延で処理されます。

    * **レスポンスコード** -拒否されたリクエストに対する応答として返すコード。デフォルトは `503`。
1. **リクエストのこの部分で**制限を設定したいリクエストポイントを指定します。Wallarmは、選択したリクエストパラメーターの値が同じであるリクエストを制限します。

    利用可能なすべてのポイントは[ここ](request-processing.md)に記述されています。特定のユースケースに適応するものを選択できます。例えば：
    
    * `remote_addr`による起源IPでの制限
    * `json` → `json_doc` → `hash` → `api_key` による `api_key` JSONボディパラメータでの接続制限

    !!! info "値の長さの制限"
        制限を測定するためのパラメータ値の最大許容長は8000文字です。
1. [ルールのコンパイルが完了する](rules.md)のを待ちます。

## ルールの例

### 高いAPI可用性を確保するためのIPによる接続の制限

例えば、医師が患者情報をPOSTリクエストを通じて提出することを許可する医療会社のREST APIがあります。このエンドポイントは `/patients` で、`https://example-host.com` ホストにあります。このエンドポイントには、個人の健康情報が含まれており、大量のリクエストによって乱用または圧倒されないようにすることが重要です。

特定期間内で `/patients` エンドポイントに対するIPによる接続を制限することでこれを防ぎます。これにより、すべての医師に対するエンドポイントの安定性と可用性を確保し、DoS攻撃を防ぎながら患者の情報のセキュリティを保護します。

たとえば、以下のように、各IPアドレスあたりの分ごとのPOSTリクエストを5に制限することができます：

![Example](../../images/user-guides/rules/rate-limit-by-ip-for-patients.png)

### セッションによる接続の制限で認証パラメータへのブルートフォース攻撃を防止

ユーザーセッションに対してレート制限を適用することで、リソースへの不正なアクセスを得るために、実際のJWTその他の認証パラメータを探すためのブルートフォース試行を制限できます。例えば、セッションごとに1分あたり10リクエストのみを許可することで、攻撃者が異なるトークン値で複数のリクエストを出して有効なJWTを見つけようとする試みは、すぐにレート制限に達し、そのリクエストがレート制限期間が終了するまで拒否されるでしょう。

アプリケーションが各ユーザーセッションに固有のIDを割り当て、それを `X-SESSION-ID` ヘッダーに反映していると仮定します。APIエンドポイントは `https://example.com/api/login` URLで、 `Authorization`ヘッダーにBearer JWTを含むPOSTリクエストを受け付けます。このシナリオでは、セッションによる接続制限のルールが次のように表示されます：

![Example](../../images/user-guides/rules/rate-limit-for-jwt.png)

`Authorization` の値に使用される[正規表現](rules.md#condition-type-regex)は ``^Bearer\s+([a-zA-Z0-9-_]+[.][a-zA-Z0-9-_]+[.][a-zA-Z0-9-_]+)$`` です。

ユーザーセッションを管理するためにJWT（JSON Web Tokens）を使用している場合、ルールを調整してJWTを[復号](request-processing.md#jwt)し、そのペイロードからセッションIDを抽出することができます：

![Example](../../images/user-guides/rules/rate-limit-for-session-in-jwt.png)

### User-Agentによるレート制限でAPIエンドポイントへの攻撃を防止

ある古いバージョンのアプリケーションが存在しており、そのアプリケーションには既知のセキュリティの脆弱性があり攻撃者たちが脆弱なアプリケーションのバージョンを使ってAPIエンドポイント `https://example-domain.com/login` にブルートフォース攻撃を行うことが可能だとします。通常、`User-Agent` ヘッダーはブラウザ/アプリケーションのバージョンを渡すために使用されます。古いアプリケーションのバージョンを介したブルートフォース攻撃を防ぐために、`User-Agent` ベースのレート制限を導入できます。

例えば、各 `User-Agent` ごとに分あたり10リクエストの制限を設定できます。特定の `User-Agent` からのリクエストが分あたり10リクエスト以上、均等に分散して送信された場合、その `User-Agent` からのさらなるリクエストは新たな期間が開始するまで拒否されます。

![Example](../../images/user-guides/rules/rate-limit-by-user-agent.png)

### カスタマーIDによる接続の制限でサーバーへの負担を防止

オンラインショッピングプラットフォームの注文データへのアクセスを提供するウェブサービスを考えてみましょう。顧客IDによるレート制限は、顧客が短期間に多数の注文を行うのを防ぐのに役立ち、これにより在庫管理や注文の充足に負担がかかることがあります。

たとえば、顧客IDが `data.customer_id` JSON本文オブジェクトで[渡される](request-processing.md#json_doc)と仮定して、各顧客が `https://example-domain.com/orders` に対して1分あたり10 POSTリクエストを行うことだけを許可するルールは、以下のようになります：

![Example](../../images/user-guides/rules/rate-limit-by-customer-id.png)

## 制限事項と注意点

レート制限機能には以下のような制限事項と注意点があります：

* レート制限ルールは、Envoy ベースの Docker イメージを除くすべての [Wallarm展開形式](../../installation/supported-deployment-options.md)でサポートされています。
* 制限を測定するためのパラメータ値の最大許容長は8000文字です。
* 複数のWallarmノードを持っていて、それぞれのノードでの受信トラフィックがレート制限ルールを満たしている場合、それらは独立して制限されます。
* 複数のレート制限ルールが受信リクエストに適用される場合、最も低いレート制限を持つルールがリクエストを制限するために使用されます。
* 受信リクエストが **このリクエストの部分で** ルールセクションで指定されたポイントを持っていない場合、そのリクエストに対してこのルールは制限として適用されません。
* Webサーバーが接続を制限するように設定されている場合（例えば、 [`ngx_http_limit_req_module`](http://nginx.org/en/docs/http/ngx_http_limit_req_module.html) NGINXモジュールを使用している場合）、且つWallarmルールも適用されている場合、Webサーバーは設定ルールによりリクエストを拒否しますが、Wallarmはそうはしません。
* Wallarmはレート制限を超えるリクエストを保存せず、ルールで選択したコードを返すことでこれらを拒否します。例外は、[攻撃の兆候](../../about-wallarm/protecting-against-attacks.md)があるリクエストで、それらはレート制限ルールによって拒否されてもWallarmによって記録されます。