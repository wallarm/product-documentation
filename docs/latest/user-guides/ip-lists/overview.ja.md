# IPリストのタイプとコアロジック

Wallarm Consoleの**IPリスト**セクションでは、許可リスト、拒否リスト、グレーリストのIPアドレスを使用してアプリケーションへのアクセスを制御できます。

* **許可リスト**は、攻撃の兆候を含むリクエストが送信された場合でもアプリケーションにアクセスが許可される信頼できるIPアドレスのリストです。
* **拒否リスト**は、アプリケーションへのアクセスが許可されないIPアドレスのリストです。フィルタリングノードは拒否リストのIPアドレスからのすべてのリクエストをブロックします。
* **グレーリスト**は、攻撃の兆候を含まないリクエストが送信された場合にのみアプリケーションへのアクセスが許可されるIPアドレスのリストです。

![!すべてのIPリスト](../../images/user-guides/ip-lists/ip-lists-home-apps.png)

## IPリスト処理のアルゴリズム

フィルタリングノードは、受信リクエストのソースIPがIPリストのエントリと一致するかどうかを以下のように検査します。

* リクエストのフィルタリングは、**オフ[モード](../../admin-en/configure-wallarm-mode.md)で実行されます。

    1. 受信リクエストのソースIPが許可リストに追加されている場合、フィルタリングノードは受信リクエストをアプリケーションに転送します。IPアドレスがリストにない場合は、次のステップが実行されます。
    1. 受信リクエストのソースIPが拒否リストに追加されている場合、フィルタリングノードは受信リクエストをブロックします。
    1. 受信リクエストのソースIPが拒否リストにも許可リストにもない場合、フィルタリングノードは攻撃を検索せずに受信リクエストをアプリケーションに転送します。

    ノードはグレーリストを分析しません。
* リクエストのフィルタリングは、**監視モードで実行されます。

    1. 受信リクエストのソースIPが許可リストに追加されている場合、フィルタリングノードは受信リクエストをアプリケーションに転送します。IPアドレスがリストにない場合は、次のステップが実行されます。
    1. 受信リクエストのソースIPが拒否リストに追加されている場合、フィルタリングノードは受信リクエストをブロックします。IPアドレスがリストにない場合は、次のステップが実行されます。
    1. 受信リクエストのソースIPが拒否リストにも許可リストにもない場合、フィルタリングノードは受信リクエストに攻撃の兆候があってもアプリケーションに転送します。

    ノードはグレーリストを分析しません。
* リクエストのフィルタリングは、**安全ブロッキングモードで実行されます。

    1. 受信リクエストのソースIPが許可リストに追加されている場合、フィルタリングノードは受信リクエストをアプリケーションに転送します。IPアドレスがリストにない場合は、次のステップが実行されます。
    2. 受信リクエストのソースIPが拒否リストに追加されている場合、フィルタリングノードは受信リクエストをブロックします。IPアドレスがリストにない場合は、次のステップが実行されます。
    3. 受信リクエストのソースIPがグレーリストに追加され、受信リクエストに攻撃の兆候がある場合、フィルタリングノードは受信リクエストをブロックします。受信リクエストに攻撃の兆候がない場合は、フィルタリングノードはそれをアプリケーションに転送します。IPアドレスがリストにない場合は、次のステップが実行されます。
    4. 受信リクエストのソースIPがリストのいずれにもない場合、フィルタリングノードは受信リクエストに攻撃の兆候があってもアプリケーションに転送します。
* リクエストのフィルタリングは、**ブロッキングモードで実行されます。

    1. 受信リクエストのソースIPが許可リストに追加されている場合、フィルタリングノードは受信リクエストをアプリケーションに転送します。IPアドレスがリストにない場合は、次のステップが実行されます。
    2. 受信リクエストのソースIPが拒否リストに追加されている場合、フィルタリングノードは受信リクエストをブロックします。IPアドレスがリストにない場合は、次のステップが実行されます。
    3. 受信リクエストのソースIPが拒否リストにも許可リストにもなく、受信リクエストに攻撃の兆候がある場合、フィルタリングノードはそれをブロックします。受信リクエストに攻撃の兆候がない場合は、フィルタリングノードはそれをアプリケーションに転送します。

    ノードはグレーリストを分析しません。

フィルタリングノードは、許可リストを開始し、拒否リストを続行し、グレーリストで終了するIPリストを分析します。例えば、IPアドレスが許可リストと拒否リストの両方に追加されている場合、フィルタリングノードはこのIPアドレスを信頼できるソースと見なし、受信リクエストに攻撃の兆候があるかどうかに関係なく、それをアプリケーションに転送します。

## IPリストの設定

IPリストを設定するには：

1. WallarmノードがロードバランサーまたはCDNの背後にある場合は、WallarmノードがエンドユーザーのIPアドレスを適切に報告するように設定してください。

    * [NGINXベースのWallarmノード用の手順](../../admin-en/using-proxy-or-balancer-en.md) (AWS / GCPイメージおよびDockerノードコンテナを含む)
    * [Wallarm Kubernetes Ingressコントローラとして展開されたフィルタリングノード用の手順](../../admin-en/configuration-guides/wallarm-ingress-controller/best-practices/report-public-user-ip.md)
2. IPリストにリクエストソースを追加してください。

    * [許可リスト](allowlist.md)
    * [拒否リスト](denylist.md)
    * [グレーリスト](graylist.md)

!!! warning "追加のトラフィックフィルタリング設備の使用"
    追加の設備(ソフトウェアまたはハードウェア)を使用して自動的にトラフィックをフィルタリングおよびブロックする場合は、[Wallarmスキャナ](../../about-wallarm/detecting-vulnerabilities.md#vulnerability-scanner)のIPアドレスを許可リストに設定することをお勧めします。これにより、Wallarmコンポーネントがシームレスにリソースの脆弱性をスキャンできます。

    * [Wallarm US Cloudに登録されたスキャナのIPアドレス](../../admin-en/scanner-address-us-cloud.md)
    * [Wallarm EU Cloudに登録されたスキャナのIPアドレス](../../admin-en/scanner-address-eu-cloud.md)