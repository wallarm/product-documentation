# レート制限の設定

レート制限の不足は、[OWASP API Top 10 2019](https://github.com/OWASP/API-Security/blob/master/editions/2019/en/0xa4-lack-of-resources-and-rate-limiting.md)の最も深刻なAPIセキュリティリスクのリストに含まれています。適切なレート制限対策がないと、APIはサービス拒否（DoS）、ブルートフォース攻撃、APIの過度な使用といった攻撃に対して脆弱となります。この記事では、Wallarmのレート制限規則を用いて、あなたのAPIとユーザーを保護する方法を説明します。

Wallarmは、APIへの過度なトラフィックを防ぐための**レート制限を設定**するルールを提供しています。このルールでは、特定のスコープに対して接続可能な最大数を設定できるだけでなく、着信リクエストが均等に分配されることも保証します。リクエストが定義した制限を超えると、Wallarmはそれを拒否し、ルールで選択したコードを返します。

Wallarmは、クッキーまたはJSONフィールドなどのさまざまなリクエストパラメーターを調べ、ソースIPアドレスだけでなく、セッション識別子、ユーザー名、またはメールアドレスに基づいて接続を制限することができます。この追加の詳細レベルは、任意のオリジンデータに基づいてプラットフォームの全体的なセキュリティを強化することができます。

## ルールの作成と適用

レート制限を設定し適用するには：

1. Wallarmコンソールに進み、**ルール** → **ルールの追加**を選択します。
1. **リクエストが** の部分で、ルールを適用するスコープを[記述します](add-rule.md#branch-description)。
1. **次に**で、**レート制限の設定**を選び、スコープへの接続における希望する限度を設定します。
    * 秒または分ごとのリクエストの最大数。
    * **バースト** - 指定されたRPS/RPMを超えてバッファされるべき過度なリクエストの最大数、およびレートが正常に戻ったときに処理されるリクエスト。デフォルトでは`0`。

        値が`0`と異なる場合、バッファされた過度なリクエストの実行間に定義されたRPS/RPMを維持するかどうかを制御できます。
        
        **遅延なし**は、すべてのバッファされた過度なリクエストの同時処理を意味し、レート制限による遅延はありません。**遅延あり**は、指定された数の過度なリクエストの同時処理を意味し、それ以外のリクエストはRPS/RPMで設定した遅延を伴って処理されます。

    * **応答コード** - 拒否されたリクエストに返答するコード。デフォルトでは`503`。
1. **リクエストのこの部分で**という部分で、制限を設定したいリクエストポイントを指定します。Wallarmは、選択したリクエストパラメーターの値が同じであるリクエストを制限します。

    利用可能なすべてのポイントは[ここに](request-processing.md)記載されており、特定の利用ケースに合うものを選ぶことができます。例えば：

    * オリジンIPによる接続の制限には`remote_addr`
    * `api_key` JSON本文パラメータによる接続の制限には `json` → `json_doc` → `hash` → `api_key`

    !!! info "値長の制限について"
        あなたが制限を測定するパラメータ値の許容最大長は、8000文字です。
1. [ルールのコンパイルが完了する](compiling.md)のを待ちます。

## ルールの例

### APIの可用性を確保するためにIPによる接続を制限する

医療会社のREST APIが、医師が患者情報をPOSTリクエストを通じて`https://example-host.com`ホストの`/patients`エンドポイントに提出することを許可しているとします。このエンドポイントは、患者の個人的な健康情報が含まれており、多くのリクエストによって過負荷になったり、乱用されたりすることを防ぐことが重要です。

特定の期間内に、特定のエンドポイントに対してIPによる接続を制限することで、これを防ぐことができます。これにより、すべての医師に対してエンドポイントの安定性と可用性を確保するとともに、DoS攻撃による患者情報のセキュリティ侵害を防ぐことができます。

例えば、各IPアドレスに対して1分あたり5つのPOSTリクエストという制限を以下のように設定することができます：

![!Example](../../images/user-guides/rules/rate-limit-by-ip-for-patients.png)

### 認証パラメーターへのブルートフォース攻撃を防ぐためにセッションによる接続を制限する

ユーザーセッションにレート制限を適用することで、保護されたリソースへの不正なアクセスを得るために、実際のJWTを見つけるためのブルートフォース試行を制限することができます。たとえば、セッションごとに分あたり10リクエストしか許可しないレート制限が設定されていると、攻撃者が異なるトークン値を持つ複数のリクエストを行って有効なJWTを発見しようとする試みはすぐにレート制限に達し、そのリクエストはレート制限期間が終了するまで拒否されます。

あなたのアプリケーションが各ユーザーセッションにユニークなIDを割り当て、それを`X-SESSION-ID`ヘッダーに反映しているとしましょう。URL `https://example.com/api/login`のAPIエンドポイントは、`Authorization`ヘッダ内のBearer JWTを含むPOSTリクエストを受け付けます。このシナリオでは、セッションごとに接続を制限するルールは以下のようになります：

![!Example](../../images/user-guides/rules/rate-limit-for-jwt.png)

`Authorization`の値に使用される[正規表現](add-rule.md#condition-type-regex)は`^Bearer\s+([a-zA-Z0-9-_]+[.][a-zA-Z0-9-_]+[.][a-zA-Z0-9-_]+)$`です。

ユーザーセッションを管理するためにJWT（JSON Web Tokens）を使用している場合、ルールを調整して、JWTを[復号化して](request-processing.md#jwt)そのペイロードからセッションIDを抽出するようにできます：

![!Example](../../images/user-guides/rules/rate-limit-for-session-in-jwt.png)

### APIエンドポイントへの攻撃を防ぐためのUser-Agentベースのレート制限

アプリケーションの古いバージョンには、攻撃者が脆弱なアプリケーションバージョンを使ってAPIエンドポイント `https://example-domain.com/login`にブルートフォース攻撃を行うことを可能にする既知のセキュリティ脆弱性が存在するとします。通常、`User-Agent`ヘッダはブラウザ/アプリケーションのバージョンを伝えるために使用されます。古いアプリケーションバージョンを通じたブルートフォース攻撃を防ぐために、`User-Agent`ベースのレート制限を実装することができます。

たとえば、各 `User-Agent`について分あたり10リクエストの制限を設定することができます。特定の `User-Agent`が分あたり10リクエスト以上を均等に分散して発行すると、その`User-Agent`からのさらなるリクエストは新しい期間が始まるまで拒否されます。

![!Example](../../images/user-guides/rules/rate-limit-by-user-agent.png)

### サーバーの過負荷を防ぐために顧客IDによる接続を制限する

オンラインショッピングプラットフォームの顧客の注文データへのアクセスを提供するウェブサービスを考えてみましょう。顧客IDによるレート制限は、顧客が短時間に多くの注文を出すのを防ぎ、在庫管理や注文の履行に負担をかけることを防ぐのに役立ちます。

たとえば、各顧客が分あたり10回のPOSTリクエストを `https://example-domain.com/orders`に制限するルールは、以下のようになります。この例では、顧客IDが`data.customer_id`のJSON本文オブジェクトを[経由して](request-processing.md#json_doc)渡されると仮定しています。

![!Example](../../images/user-guides/rules/rate-limit-by-customer-id.png)
## 制限と特性

レート制限機能には以下の制限と特性があります：

* レート制限ルールは、すべての [Wallarmのデプロイメント形式](../../installation/supported-deployment-options.md)でサポートされていますが、EnvoyベースのDockerイメージを除きます。
* 制限を測定するためのパラメータ値の最大許容長さは8000文字です。
* 複数のWallarmノードがあり、それぞれのノードで受信したトラフィックがレート制限ルールを満たした場合、それらは独立して制限されます。
* 複数のレート制限ルールが受信リクエストに適用される場合、レート制限が最も低いルールがリクエストを制限するために使用されます。
* 受信したリクエストが**In this part of request**ルールセクションに指定された項目を持っていない場合、そのリクエストに対する制限としてこのルールは適用されません。
* Webサーバーが接続を制限するように設定されている場合（例えば、 [`ngx_http_limit_req_module`](http://nginx.org/en/docs/http/ngx_http_limit_req_module.html) NGINXモジュールを使用して）とWallarmルールも適用している場合、Webサーバーは設定したルールによりリクエストを拒否しますが、Wallarmはそれを行いません。
* Wallarmはレート制限を超えるリクエストを保存せず、ルールで選択したコードを返すことでそれらを拒否します。例外は[攻撃の兆候](../../about-wallarm/protecting-against-attacks.md)を持つリクエスト - レート制限ルールにより拒否されてもWallarmにより記録されます。