# アクティブな脅威検証モジュールのカスタマイズ <a href="../../../about-wallarm/subscription-plans/#subscription-plans"><img src="../../../images/api-security-tag.svg" style="border: none;"></a>

カスタムルールセットを使用すると、[アクティブ脅威検証](../../about-wallarm/detecting-vulnerabilities.md#active-threat-verification)モジュールの以下の構成を変更することができます。

* アプリケーション全体または一部のモジュールを無効にする（Wallarmコンソール → **スキャナ**で全てのアプリケーションに対してモジュールが有効になっている場合のみ）。
* アタック再生前にリクエストを書き換える。

## アクティブ脅威確認モジュールの無効化／有効化

### ルールの概要

ルール **アクティブ脅威確認のモードを設定** は、Wallarm コンソール → **スキャナ** でグローバルに有効になっている場合、特定のアプリケーション、ドメイン、または URL の [アクティブ脅威確認](../../about-wallarm/detecting-vulnerabilities.md#active-threat-verification) モジュールのモードを変更するために使用されます。

### ルールの作成と適用

ルールを作成して適用するには:

1. Wallarmコンソールの **ルール** セクションで、ルール **アクティブ脅威確認のモードを設定** を作成します。ルールは以下のコンポーネントで構成されています。

      * **条件** は、ルールを適用するエンドポイントを[説明](add-rule.md#branch-description)します。
      * **無効化／有効化** は、指定されたエンドポイントに送信される攻撃の **アクティブ脅威検証** モジュールのモードを設定します。

        モード **有効化** を、モジュールを無効にするルールの例外設定にのみ使用してください（例： `https://example.com/module/user/*` で既に無効になっている場合、`https://example.com/module/user/create` のモジュールを有効にする）。
2. [カスタムルールセットのコンパイルが完了する](compiling.md)のを待ちます。

### ルール例

`https://example.com/module/user/*` の **アクティブ脅威検証** モジュールを無効化する **アクティブ脅威確認のモードを設定**ルールは次のようになります。

![!アクティブ脅威確認のモード設定ルールの例](../../images/user-guides/rules/disable-active-threat-verification-example.png)

上記のルールがすでに設定されている場合、次のルールは`https://example.com/module/user/create`の**アクティブ脅威確認**モジュールを有効にします。

![!アクティブ脅威確認のモード設定ルールの例](../../images/user-guides/rules/disable-active-threat-verification-deeper-path-example.png)

## アタック再生前のリクエストの書き換え

### ルールの概要

ルール **アクティブ検証前のアタックの書き換え** は、[アタック再生](../../about-wallarm/detecting-vulnerabilities.md#active-threat-verification) の前に、元のリクエストの要素を変更するために使用されます。以下の要素を変更することができます。

* リクエスト認証データのヘッダーを、[元の認証データをテストデータに置き換える](#replacing-original-authentication-data-with-test-data)。
* ヘッダー `HOST` 。例えば、ヘッダー `HOST` を変更して、[ステージングまたはテスト環境](#modifying-the-application-address-for-attack-replaying)でアタックを再生できます。
* [アタック再生に使用されるアプリケーションアドレスの書き換え](#modifying-the-application-address-for-attack-replaying)フォルダ。

!!! warning "元のリクエスト要素の任意の変更"
    ルール **アクティブ検証前のアタックの書き換え** は、元のリクエストのヘッダー（`header`）とパス（`uri`）のみを変更できます。他のリクエスト要素を変更したり追加したりすることはできません。

#### 元の認証データをテストデータに置き換える

認証パラメータが元のリクエストで渡された場合、モジュール **アタックリチェッカー** はこれらのパラメータを削除し、アタックを再生します。保護されたアプリケーションAPIにアクセスするために認証パラメータが必要な場合、リプレイアタックに対する応答でコード `401` または他のコードが返されます。返されるコードが脆弱性の徴候を示していないため、リクエストで認証パラメータが渡されると実際に検出できる脆弱性がある場合でも、モジュール **アタックリチェッカー** は脆弱性を検出しません。

元のリクエストと必要な認証パラメータで再生するには、**アクティブ検証前のアタック書き換え**ルールを使ってテスト値を​​これらのパラメータに追加できます。例： APIキー、トークン、パスワードなど。

!!! info "テスト認証データの再利用"
    Wallarmモジュール **アタックリチェッカー** でのみ使用されるテスト認証資格情報を生成することをお勧めします。

#### アタック再生のアプリケーションアドレス変更

デフォルトでは、再生されたアタックは、元のリクエストで渡されたアプリケーションアドレスおよびパスに送信されます。元のアドレスおよびパスを、アタック再生時に使用される他の値に置き換えることができます。値は、次の方法で **アクティブ検証前のアタックの書き換え** ルールを使用して置き換えます。

* ヘッダー `HOST` の元の値を別のアプリケーションインスタンスアドレスに置き換えます。例えば、別のアプリケーションインスタンスは、ステージングやテスト環境である場合があります。
* プロキシサーバーをバイパスしてターゲットサーバーへのパスにアタックを再生するために、元のリクエストのパスをテスト環境やステージングのパスに置き換えます。

`HOST`ヘッダーの値と元のリクエストのパスの両方を置き換えるには、アクションタイプ **アクティブ検証前のアタックの書き換え** の 2 つの別々のルールを作成する必要があります。

### ルールの作成と適用

--8<-- "../include/waf/features/rules/rule-creation-options.ja.md"

**ルール** セクションでルールを作成および適用するには：

1. Wallarmコンソールの**ルール**セクションで、**アクティブ検証前のアタック書き換え**ルールを作成します。ルールは以下のコンポーネントで構成されています。

      * **条件** は、ルールを適用するエンドポイントを[説明](add-rule.md#branch-description)します。
      * **ルール** は、**リクエストのパート** フィールドで選択されたパラメータに新しい値を設定します。設定された値はアタック再生時に使用されます。

        値は、[テンプレート言語 Liquid](https://shopify.github.io/liquid/) を使ってデコードして設定する必要があります。つまり、二重中括弧 `{{}}` と シングルクォート `''`で囲みます。例： `{{'example.com'}}`。

        元のリクエストのパス（`uri`）を置き換えるには、新しいパスの完全な値を渡す必要があります。

      * **リクエストの一部** は、アタック再生前に変更されるべき元のリクエスト要素を指します。

        !!! warning "**リクエストの一部** フィールドの可能な値"
            **リクエストの一部** フィールドの可能な値は、`header`（リクエストヘッダー）と `uri`（リクエストパス）です。

2. [ルールのコンパイルが完了する](compiling.md) のを待ちます。

元のリクエストの変更に対する複数の条件を設定するか、または複数のリクエスト要素の値を置き換えるには、複数のルールを作成できます。

### ルール例

* `example.com` に送信されるアタックを再生する際に、`COOKIE` ヘッダーに `PHPSESSID=mntdtbgt87j3auaq60iori2i63; security=low` の値を渡します。

    ヘッダー値の形式は `{{'PHPSESSID=mntdtbgt87j3auaq60iori2i63; security=low'}}` です。

    ![!COOKIE を変更するルールの例](../../images/user-guides/rules/rewrite-request-example-cookie.png)

* 元々 `example.com` に送信されたアタックを、テスト環境の `example-test.env.srv.loc` で再生します。

    アドレスの形式は `{{'example-test.env.srv.loc'}}` です。

    ![!ホストを変更するルールの例](../../images/user-guides/rules/rewrite-request-example-host.png)