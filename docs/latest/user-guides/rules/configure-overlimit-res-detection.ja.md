# `overlimit_res` 攻撃検出の微調整

Wallarmノードは、単一の受信リクエストの処理に限られた時間を費やし、時間制限が超過した場合、リクエストを[リソースのオーバーリミット（`overlimit_res`）](../../attacks-vulns-list.md#overlimiting-of-computational-resources)攻撃としてマークします。**overlimit_res 攻撃検出の微調整**ルールを使用すると、単一のリクエスト処理に割り当てられる時間制限と、制限が超過したときのデフォルトのノード動作をカスタマイズできます。

リクエスト処理時間を制限することで、Wallarmノードを対象としたバイパス攻撃を防ぐことができます。場合によっては、`overlimit_res`としてマークされたリクエストは、Wallarmノードのモジュールに割り当てられたリソースが不足していることを示すことがあり、リクエスト処理に時間がかかってしまいます。

!!! info "異なるノードバージョンでのルールのサポート"
    **overlimit_res 攻撃検出の微調整** ルールは、Wallarmノード 3.6 以降でのみサポートされています。

    バージョン 3.4 およびそれ以前では：

    * 単一のリクエスト処理に対するカスタム時間制限は、 [`wallarm_process_time_limit`](../../admin-en/configure-parameters-en.md#wallarm_process_time_limit) NGINX ディレクティブおよび、 [`process_time_limit`](../../admin-en/configuration-guides/envoy/fine-tuning.md#process_time_limit) Envoy のパラメータを介して設定されます。
    * `overlimit_res` 攻撃処理モードは、 [`wallarm_process_time_limit_block`](../../admin-en/configure-parameters-en.md#wallarm_process_time_limit_block) NGINX ディレクティブおよび、 [`process_time_limit_block`](../../admin-en/configuration-guides/envoy/fine-tuning.md#process_time_limit_block) Envoy パラメータを介して設定されます。

    Wallarmモジュールを最新バージョンまでアップグレードする際に、ディレクティブからルールに `overlimit_res` 攻撃検出の設定を移行することをお勧めします。各[ノード展開オプション](../../updating-migrating/general-recommendations.md#update-process)に関連する指示が提供されています。

## デフォルトのノード動作

Wallarmノードは、デフォルトで単一の受信リクエスト処理に **1,000ミリ秒** を超えないように設定されています。

もし時間制限が超過された場合、Wallarmノードは：

1. リクエストの処理を停止。
1. リクエストを `overlimit_res` 攻撃としてマークし、Wallarm Cloud に攻撃の詳細をアップロード。

    処理されたリクエストの一部に他の[攻撃タイプ](../../attacks-vulns-list.md)も含まれている場合、Wallarmノードはそれらの詳細もCloudにアップロードします。

    対応するタイプの攻撃は、Wallarmコンソールの[イベントリスト](../events/check-attack.md)に表示されます。
1. <a name="request-blocking"></a>**モニタリング**[モード](../../admin-en/configure-wallarm-mode.md)では、ノードが元のリクエストをアプリケーションのアドレスに転送します。その結果アプリケーションは、処理されたリクエストと未処理のリクエストの両方に含まれる攻撃の被害にあるリスクがあります。

    **セーフブロッキング**モードでは、リクエストが[グレーリスト](../ip-lists/graylist.md)IPアドレスから発信された場合、ノードはリクエストをブロックします。それ以外の場合は、ノードは元のリクエストをアプリケーションのアドレスに転送します。アプリケーションは、処理済みおよび未処理のリクエストの両方に含まれる攻撃に関与するリスクがあります。

    **ブロック**モードではノードがリクエストをブロックします。

!!! info "「無効」モードでのリクエストの処理"
    **無効** [モード](../../admin-en/configure-wallarm-mode.md)では、ノードは受信トラフィックを解析せず、そのためリソースのオーバーリミットを狙った攻撃は検出されません。

## デフォルトのノード動作の変更

!!! warning "保護のバイパスまたはシステムメモリ切れのリスク"
    * デフォルトのノード動作の変更は、例えば大きなファイルのアップロードが行われ、保護のバイパスおよび脆弱性の悪用のリスクがない場所でのみ行われることをお勧めします。
    * 高い時間制限および/または制限が超過した後のリクエスト処理の継続は、メモリの枯渇や処理時間の遅れを引き起こす可能性があります。

**overlimit_res 攻撃検出の微調整** ルールを使用すると、デフォルトのノード動作を以下のように変更できます。

* 単一リクエスト処理のカスタム制限を設定する
* 時間制限が超過した際にリクエスト処理を停止または継続する

    時間制限を超えた後にノードがリクエスト処理を続ける場合、リクエスト処理が完全に終了した後に、検出された攻撃に関するデータをクラウドにアップロードします。
* リクエスト処理時間制限が超過した場合、`overlimit_res` 攻撃を登録するかどうか

    ノードが攻撃を登録するように設定されている場合、フィルタリングモードに応じてリクエストを[ブロックするか、アプリケーションアドレスに転送します](#request-blocking)。

    ノードが攻撃を登録するように設定されていなくて、リクエストが他の攻撃タイプを含まない場合、ノードは元のリクエストをアプリケーションアドレスに転送します。リクエストが他の攻撃タイプを含む場合、ノードはリクエストをフィルタリングモードに応じてブロックするか、アプリケーションアドレスに転送します。

このルールでは、以下のようなことは許可されません。

* `overlimit_res`攻撃に対するブロッキングモードを他の設定とは別に設定する。**イベントで登録および表示**オプションが選択されている場合、ノードは、対応するエンドポイントに設定された[フィルタリングモード](../../admin-en/configure-wallarm-mode.md)に応じて、`overlimit_res`攻撃をブロックするか、アプリケーションアドレスに転送します。

## ルールの例

* このルールは、`https://example.com/upload` への各 POST リクエストの処理時間制限を 1,020 ミリ秒まで増やします。指定されたエンドポイントは大きなファイルのアップロードを実行します。
* ノードの動作の他のパラメータはデフォルトのままです。ノードはリクエストを 1,020 ミリ秒以上処理すると、リクエストの処理を停止し、`overlimit_res` 攻撃を登録します。

![!「登録およびイベント表示」ルールの例](../../images/user-guides/rules/fine-tune-overlimit-detection-example.png)