# Enabling Active Threat Verification <a href="../../../about-wallarm/subscription-plans/#subscription-plans"><img src="../../../images/api-security-tag.svg" style="border: none;"></a>

This article explains how to securely enable and configure Wallarm's [Active Threat Verification](overview.md) that transforms initial attacks into penetration tests to identify vulnerabilities even the attackers might have missed.

To ensure secure Active Threat Verification, follow these steps:

1. Enable Active Threat Verification.
1. Configure a non-production environment host.
1. Configure a non-production authentication cookie or API key.

## 1. Enable the module

Active threat verification is disabled by default. To enable:

1. Proceed to Wallarm Console → **Vulnerabilities** → **Configure**.
1. Toggle on the **Active threat verification** switch.

This action enables the module for all resources where the filtering node is configured.

![!Vuln scan settings](../../images/user-guides/vulnerabilities/vuln-scan-settings.png)

## 2. Configure a non-production environment host

Testing on a production environment with real data can lead to downtime or data breaches. By testing in a non‑production setting like staging or development, you can assess vulnerabilities using similar data without such risks, ensuring system safety and early vulnerability detection.

The **Rewrite attack before active verification** rule lets you modify the attack replay address by replacing either the original `HOST` header value or the request paths. To achieve this:

1. Proceed to Wallarm Console → **Rules** → create the rule **Rewrite attack before active verification**.
1. Complete the rule creation form as follows:

      * **Condition**: [specify](../../user-guides/rules/add-rule.md#branch-description) the endpoints where the rule is applied.
      * **Rules**: specify the new value for the `HOST` header or for the request path (URL segment without the domain, e.g., `/test-blogs/new`).
      
        The value must be decoded and set using the [template language Liquid](https://shopify.github.io/liquid/) as follows: placed in double curly braces `{{}}` and single quotes `''`. For example: `{{'example.com'}}`.
      
      * **Part of request**: select either `header: HOST` or `uri`, based on the segment of the request you intend to modify.

        !!! warning "Possible values"
            The only acceptable values for the **Part of request** field are `header` and `uri`. No other values are permitted.
1. Wait for the [rule compilation to complete](../../user-guides/rules/compiling.md).

To change both the `HOST` header value and the original request path, set up two distinct **Rewrite attack before active verification** rules.

The following is the rule for running attacks initially aimed at `example.com` on the test environment `example-test.env.srv.loc`. The format of the address is `{{'example-test.env.srv.loc'}}`.

![!Example of the rule modyfying HOST](../../images/user-guides/rules/rewrite-request-example-host.png)

## 3. Configure a non-production authentication cookie or API key

Your application's APIs might require authentication. However, since the module strips this data before replaying attacks, vulnerabilities may go undetected. To address this, consider creating specific authentication parameters for active threat verification when this data is passed in request headers. This approach not only grants the necessary access but also lets you control and secure the replay process.

To furnish the replayed requests with necessary authentication details:

1. Proceed to Wallarm Console → **Rules** → create the rule **Rewrite attack before active verification**.
1. Complete the rule creation form as follows:

    * **Condition**: [specify](../../user-guides/rules/add-rule.md#branch-description) the endpoints where the rule is applied.
    * **Rules**: provide the cookie or token value designed for active threat verification requests.
    
        The value must be decoded and set using the [template language Liquid](https://shopify.github.io/liquid/) as follows: placed in double curly braces `{{}}` and single quotes `''`. For example: `{{'example.com'}}`.

    * **Part of request**: select `header` and indicate the header name for passing authentication data. Ensure this header is present in original requests as original values will be substituted.

    !!! warning "Possible values"
        The only acceptable value for the **Part of request** field in this case is `header`. No other values are permitted.
1. Wait for the [rule compilation to complete](../../user-guides/rules/compiling.md).

For instance, the following is the rule to ensure attacks replayed on `example.com` carry the value `PHPSESSID=mntdtbgt87j3auaq60iori2i63; security=low` in the `COOKIE` header. The format of the header value is `{{'PHPSESSID=mntdtbgt87j3auaq60iori2i63; security=low'}}`.

![!Example of the rule modifying COOKIE](../../images/user-guides/rules/rewrite-request-example-cookie.png)

## Additional configiration

### Notification and escalation rules for detected security vulnerabilities

Wallarm provides [integrations with third-party messaging and incident management services](../../user-guides/settings/integrations/integrations-intro.md) like Slack, Telegram, PagerDuty, Opsgenie and others. It is highly recommended to configure your Wallarm Cloud instance to use the integrations to dispatch notifications about discovered security vulnerabilities to your information security team.

### Masking sensitive data

By default, the standard authentication headers `Cookie`, `Authorization: Basic`, and `Viewstate` are automatically omitted when replaying attacks, ensuring the tests are safe.

For applications using non-standard authentication methods, such as custom HTTP headers or JSON attributes, it is recommended to set up a [data masking rule](../../user-guides/rules/sensitive-data-rule.md). This ensures that such details are not forwarded to Wallarm Cloud, keeping **Active Threat Verification** requests safe from potential unauthorized actions.

### Disabling the module for specific endpoints

For endpoints that lack a [staging environment](running-test-on-staging.md) and especially those that are non-idempotent or without an authentication mechanism, it is recommended to disable attack replay. Without these protections, the module might accidentally repeat harmful actions, such as processing monetary transactions multiple times or repeatedly registering new accounts.

You can disable attack replaying for such endpoints using the corresponding rule:

1. Proceed to Wallarm Console → **Rules** → create the rule **Set mode of active threat verification**.
1. Fill in the rule creation form following the instructions:

    * **Condition** [specifies](../../user-guides/rules/add-rule.md#branch-description) the endpoints to apply the rule to.
    * **Disable / Enable** sets the mode of the module for attacks sent to the specified endpoints.

    Use the **Enable** setting to make exceptions for a rule that disables the module (e.g., enabling for `https://example.com/module/user/create` while it is disabled for `https://example.com/module/user/*`).
1. Wait for the [custom ruleset compilation to complete](../../user-guides/rules/compiling.md).

For instance, here is how the rule looks when disabling the **Active Threat Verification** for `https://example.com/module/user/*`:

![!Example of the rule "Set mode of active threat verification"](../../images/user-guides/rules/disable-active-threat-verification-example.png)

If the rule mentioned above is already active, the following rule would enable the module for `https://example.com/module/user/create`:

![!Example of the rule "Set mode of active threat verification"](../../images/user-guides/rules/disable-active-threat-verification-deeper-path-example.png)
