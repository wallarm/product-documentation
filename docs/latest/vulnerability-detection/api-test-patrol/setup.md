# API Test Patrol Setup

This article describes how to enable and configure Wallarm's [API Test Patrol](overview.md).

## Enable

API Test Patrol is disabled by default. To enable:

1. If in Wallarm Console you do not see the **API Security Testing** → **API Test Patrol** section, contact the [Wallarm support team](https://support.wallarm.com/) to enable.
1. Go to the **API Test Patrol** → **Test policies** tab and create [at least one policy](#configure-test-policies).

## Configure test policies

You can configure test policy [based](overview.md#test-basis) on OpenAPI specification (OAS) or Postman collection. Note that one test policy is aimed at only one type of testing (either OAS or Postman-based).

Note that OAS and Postman collection-based scannings perform different checks:

* OAS is more focused on input validation, injection, misconfiguration detection
* Postman - on complex business logic and access control vulnerabilities

### OAS-based

OpenAPI specification (OAS)-based test policy defines persistently:

* Application's **OpenAPI specification**
* Tests to run

Besides persistent parameters that are the same for any test run, each test policy may optionally include parameters that can be re-defined during each next test run (**Runtime parameters**). Re-defining the runtime parameters can be useful for embedding of Docker into the CI/CD pipelines:

* Application's **Target URL**

    (although can be redefined during each run, some initial value is required)

* Authentication parameters

To configure test policy:

1. Go to Wallarm Console → **API Security Testing** → **API Test Patrol** → **Test policies**.
1. Click **Add policy**, set **Source** to **OpenAPI spec**.
1. Attach OpenApi specification file.
1. Select [test types](overview.md#test-types) to run.
1. Set **Target URL** (can be re-defined dynamically during each test run).
1. Optionally, add authentication **Runtime parameters**.

    ![API Test Patrol - creating test policy based on OpenAPI specification](../../images/vulnerability-detection/apitp-policy-create.png)

### Postman collection-based

With Postman-based security testing you can automate security scans alongside your regular API tests, ensuring that each API run is thoroughly tested for vulnerabilities.

!!! info "API functional tests as basis"
    API Test Patrol utilizes your functional tests to inform the security tests it runs. The broader and more comprehensive your functional tests, the more security coverage API Test Patrol will provide. More APIs, users, and requests mean richer security testing.

#### Pre-check of Postman collection

Before using Postman data for security testing with API Test Patrol:

1. Ensure that you collection and environment files contain:

    * functional tests for API endpoints
    * location of the target application
    * all environment variables set
    * necessary credentials to authenticate in the target application

1. (Recommended) Check whether the Postman collection is working at all (working). For example, this can be done by running the command:

    ```
    newman run my_collection.json -e my_environment.json
    ```

    This can tell you in advance whether there are any problems, for example, related to the quality of the Postman collection, the availability of the target URL, or that all the necessary variables are specified.

!!! warning "Valid Postman collection"
    If the Postman collection itself cannot work, then the Test Patrol API will not work either.

#### Configuring test policy in Wallarm

In Wallarm, Postman collection-based test policy defines:

* Application's **Postman collection**.
* **Postman environment file(s)** (optional if all configuration is stored in the main collection file).

    !!! info "Target URL and authentication"
        Application's **Target URL** and authentication parameters are defined in the Postman collection or environment files.

* Test case selection is not currently supported for security testing based on Postman collections.

To configure test policy:

1. Go to Wallarm Console → **API Security Testing** → **API Test Patrol** → **Test policies**.
1. Click **Add policy**, set **Source** to **Postman collection**.
1. Attach Postman collection file.
1. Optionally, attach Postman environment file(s). Attaching 2 files allows running testing twice with different variable values (for example, different credentials) and then comparing results.

    ![API Test Patrol - creating test policy based on Postman collection](../../images/vulnerability-detection/apitp-policy-create-postman.png)

#### Business logic security testing

For business logic testing ([OWASP API1:2023 Broken Object Level Authorization (BOLA)](https://github.com/OWASP/API-Security/blob/master/editions/2023/en/0xa1-broken-object-level-authorization.md) and [OWASP API5:2023 Broken Function Level Authorization (BFLA)](https://github.com/OWASP/API-Security/blob/master/editions/2023/en/0xa5-broken-function-level-authorization.md)) API Test Patrol requires API traffic from at least two different authenticated users, preferably with varying privileges (e.g., admin and regular users). This diversity in traffic enables Wallarm's API Test Patrol to conduct better business logic-related security tests, providing a more thorough assessment.

| Business logic vulnerability | Input requirements |
| ---- | ---- |
| [OWASP API1:2023 Broken Object Level Authorization (BOLA)](https://github.com/OWASP/API-Security/blob/master/editions/2023/en/0xa1-broken-object-level-authorization.md) | Testing for this vulnerability requires multiple authenticated users to demonstrate whether proper object-level authorization checks are in place. |
| [OWASP API5:2023 Broken Function Level Authorization (BFLA)](https://github.com/OWASP/API-Security/blob/master/editions/2023/en/0xa5-broken-function-level-authorization.md) | Testing for this vulnerability requires requests from users with different privilege levels to evaluate whether function-level authorization is enforced consistently. |

##### Example 1: Using Postman collections with requests from two users

Do the following:

1. Create a Postman collection containing requests from two authenticated users. For example, in the target application, include login and activity requests from `User A` and `User B` in the same collection.

    ![Postman collection - 2 users transactions](../../images/vulnerability-detection/posman-collection-2-users.png)

1. Verify that all requests are executed correctly. 
1. Create API Test Patrol test policy with the created postman collection.

##### Example 2: Using Postman environments for multiple users

Do the following:

1. Create two Postman environment files, each containing the credentials of one authenticated user:

    * `env1.json` for `User A`
    * `env2.json` for `User B`

1. Create API Test Patrol test policy with Postman collection and both environment files. In this setup API Test Patrol runs the collection twice, once per user.

### Editing existing policy

You can edit previously created policies: while clicking policy itself opens its Docker command info, you can click the edit button to access the edit dialog:

![API Test Patrol - editing test policy](../../images/vulnerability-detection/apitp-policy-edit.png)

## Docker run

As test policy is [created](#configure-test-policies), it provides you with the Docker run command which allows you start tests for your application:

1. Go to Wallarm Console → **API Security Testing** → **API Test Patrol** → **Test policies**.
1. Click you policy. The policy's Docker command will be displayed.

    ![API Test Patrol - test policy Docker command](../../images/vulnerability-detection/apitp-policy-docker-command.png)

1. If necessary, redefine Docker log level and format.
1. Copy command and run it or embed into your CI/CD pipeline. This will run security tests selected in the policy for your application.

    Remember that, for OAS-based run, you can re-define the policy's **Runtime parameters** on each run by adding the corresponding `-e` parameters to the Docker `run` command, for example:

    ```
    -e TARGET_URL="http://dvapi.st.wallarm.tools" 
    -e AUTH_HEADER="Authorization: Bearer <VALUE>"
    ```

    You can simplify re-defining these parameters by selecting the **Rewrite authentication data** and/or **Rewrite target URL** checkboxes that add to the command:

    ```
    -e AUTH_HEADER="${AUTH_HEADER}" -e TARGET_URL="${TARGET_URL}"
    ```
    
1. View run statistics and [test run results](explore.md) on the **Test runs** tab.

## Deleting policies

You can delete a test policy. If you do so:

* Information on previous test runs will remain untouched
* You will not be able to run Docker's command based on the deleted policy
* If policy's Docker containers are running, they will continue to do so
* When policy's Docker containers stop, you will not be able to re-run them
