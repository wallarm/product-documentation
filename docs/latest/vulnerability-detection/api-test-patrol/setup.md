# API Test Patrol Setup

This article describes how to enable and configure Wallarm's [API Test Patrol](overview.md).

## Enable

API Test Patrol is disabled by default. To enable:

1. If in Wallarm Console you do not see the **API Security Testing** → **API Test Patrol** section, contact the [Wallarm support team](https://support.wallarm.com/) to enable.
1. Go to the **API Test Patrol** → **Test policies** tab and create [at least one policy](#configure-test-policies).

## Configure test policies

You can configure test policy [based](overview.md#test-basis) on OpenAPI specification (OAS) or Postman collection.

### OAS-based

OpenAPI specification (OAS)-based test policy defines persistently:

* Application's **OpenAPI specification**
* Tests to run

Besides persistent parameters that are the same for any test run, each test policy may optionally include parameters that can be re-defined during each next test run (**Runtime parameters**). Re-defining the runtime parameters can be useful for embedding of Docker into the CI/CD pipelines:

* Application's **Target URL**

    (although can be redefined during each run, some initial value is required)

* Authentication parameters

To configure test policy:

1. Go to Wallarm Console → **API Security Testing** → **API Test Patrol** → **Test policies**.
1. Click **Add policy**, set **Source** to **OpenAPI spec**.
1. Attach OpenApi specification file.
1. Select [test types](overview.md#test-types) to run.
1. Set **Target URL** (can be re-defined dynamically during each test run).
1. Optionally, add authentication **Runtime parameters**.

    ![API Test Patrol - creating test policy based on OpenAPI specification](../../images/vulnerability-detection/apitp-policy-create.png)

### Postman collection-based

Postman collection-based test policy defines persistently:

* Application's **Postman collection**
* **Postman environment file**
* Test case selection is not currently supported for security testing based on Postman collections.

Besides persistent parameters that are the same for any test run, each test policy may optionally include parameters that can be re-defined during each next test run (**Runtime parameters**). Re-defining the runtime parameters can be useful for embedding of Docker into the CI/CD pipelines:

* Application's **Target URL** (defined in the Postman collection or environment files).

    (although can be redefined during each run, some initial value is required)

* Authentication parameters (defined in the Postman collection or environment files).

To configure test policy:

1. Go to Wallarm Console → **API Security Testing** → **API Test Patrol** → **Test policies**.
1. Click **Add policy**, set **Source** to **Postman collection**.
1. Attach Postman collection file.
1. Attach Postman environment file.

    ![API Test Patrol - creating test policy based on Postman collection](../../images/vulnerability-detection/apitp-policy-create-postman.png)

### Editing existing policy

You can edit previously created policies: while clicking policy itself opens its Docker command info, you can click the edit button to access the edit dialog:

![API Test Patrol - editing test policy](../../images/vulnerability-detection/apitp-policy-edit.png)

## Docker run

As test policy is [created](#configure-test-policies), it provides you with the Docker run command which allows you start tests for your application:

1. Go to Wallarm Console → **API Security Testing** → **API Test Patrol** → **Test policies**.
1. Click you policy. The policy's Docker command will be displayed.

    ![API Test Patrol - test policy Docker command](../../images/vulnerability-detection/apitp-policy-docker-command.png)

1. Copy command and run it or embed into your CI/CD pipeline. This will run security tests selected in the policy for your application.

    Remember that you can re-define the policy's **Runtime parameters** on each run by adding the corresponding `-e` parameters to the Docker `run` command, for example:

    ```
    -e TARGET_URL="http://dvapi.st.wallarm.tools" 
    -e AUTH_HEADER="Authorization: Bearer <VALUE>"
    ```
    
1. View run statistics and [test run results](explore.md) on the **Test runs** tab.

## Deleting policies

You can delete a test policy. If you do so:

* Information on previous test runs will remain untouched
* You will not be able to run Docker's command based on the deleted policy
* If policy's Docker containers are running, they will continue to do so
* When policy's Docker containers stop, you will not be able to re-run them
