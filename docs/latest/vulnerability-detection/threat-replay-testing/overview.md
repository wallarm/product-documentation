[al-brute-force-attack]:      ../../attacks-vulns-list.md#brute-force-attack
[al-forced-browsing]:         ../../attacks-vulns-list.md#forced-browsing
[al-bola]:                     ../../attacks-vulns-list.md#broken-object-level-authorization-bola
[img-verification-statuses]:    ../../images/user-guides/events/attack-verification-statuses.png
[img-verified-icon]:            ../../images/user-guides/events/verified.png
[img-error-icon]:               ../../images/user-guides/events/error.png#mini
[img-forced-icon]:              ../../images/user-guides/events/forced.png#mini
[img-sheduled-icon]:            ../../images/user-guides/events/sheduled.png#mini
[img-cloud-icon]:               ../../images/user-guides/events/cloud.png#mini
[img-skip-icon]:                ../../images/user-guides/events/skipped.png#mini
[img-happening-icon]:           ../../images/user-guides/events/happening.png#mini

# Overview of Threat Replay Testing <a href="../../../about-wallarm/subscription-plans/#waap-and-advanced-api-security"><img src="../../../images/api-security-tag.svg" style="border: none;"></a>

By replaying incoming real-world attacks as unharmful security tests, Wallarm's Threat Replay Testing addresses the challenge of finding vulnerabilities in applications and APIs that traditional security testing tools might miss.

The Threat Replay Testing capabilities:

* **Real-time analysis**: It uses actual attack data to identify vulnerabilities that are being actively exploited or have the potential to be exploited in the future.   
* **Comprehensive testing**: By [generating variations](#how-it-works) of real attacks, it explores different attack vectors and exposes weaknesses the original attackers may have missed.    
* **Safe simulation**: It [removes](#test-request-security) harmful code and sensitive authentication details from the test requests, ensuring that the testing process doesn't cause any damage or compromise systems.   
* **Non-production testing**: It allows testing applications and APIs in a safe environment (typically staging) without risking production data or system stability. 

![TRT - Tests tab](../../images/vulnerability-detection/trt-tests.png)

## How it works

The Threat Replay Testing module operates on the Wallarm Cloud. Initially, the module gathers detailed information about malicious requests that the [Wallarm filtering node](../../installation/supported-deployment-options.md) detected and uploaded to the Cloud. Leveraging this acquired data, the module dynamically generates a set of approximately 100-150 test requests. These test requests target the same vulnerability types as the malicious ones but employ different payloads.

The resulting set of attack simulations is directed to the same address as the original malicious request. However, the module offers the flexibility to [redirect these test requests to alternative destinations](setup.md#configure-test-policies), such as staging or development environments or both.

By analyzing responses to the test requests, the module determines vulnerability to specific [attack types](../../attacks-vulns-list.md). Discovered vulnerabilities are cataloged in the Wallarm Console UI's [**Vulnerabilities**](../../user-guides/vulnerabilities.md) section. Additionally, you have the option to receive [notifications](../../user-guides/settings/integrations/integrations-intro.md) about these findings.

The following diagram demonstrates how the module works:

![ATV scheme](../../images/vulnerability-detection/active-threat-verification-scheme-prod.png)

The generated requests carry the `User-Agent: Wallarm Threat-Verification (v1.x)` header, helping differentiate them from other requests.

### Test request security

The Threat Replay Testing module is designed to create test requests in the most secure manner possible, featuring the following key characteristics:

* Malicious payloads of generated requests do not include real malicious syntax, they are intended just to imitate the attack principle. As a result, they do not harm your resources.
* Authentication headers like `Cookie`, `Authorization: Basic`, and `Viewstate` are excluded from replayed requests. Further, as guided by the [custom authentication headers](setup.md#rewrites) and [masking rule](../../user-guides/rules/sensitive-data-rule.md), any additional headers may be adapted or removed as required.

### Example

Consider the following real-world-like GET request initially detected by the Wallarm filtering node and uploaded to the Cloud:

```bash
https://example.com/login?user=UNION SELECT username, password
```

From the request, the module learns the following details:

* The attacked URL is `https://example.com/login`
* The type of used attack is SQLi (according to the `UNION SELECT username, password` payload)
* The attacked query string parameter is `user`
* Additional piece of information provided in the request is the request string parameter `token=IyEvYmluL3NoCg` (it is probably used by the application to authenticate the user)

Leveraging this data, the module crafts a series of test requests. These requests focus on potential SQL injection vulnerabilities using varied payloads, such as:

```bash
https://example.com/login&user=1')+WAITFOR+DELAY+'0 indexpt'+AND+('wlrm'='wlrm
https://example.com/login&user=1+AND+SLEEP(10)--+wlrm
https://example.com/login&user=1);SELECT+PG_SLEEP(10)--
https://example.com/login&user=1'+OR+SLEEP(10)+AND+'wlrm'='wlrm
https://example.com/login&user=1+AND+1=(SELECT+1+FROM+PG_SLEEP(10))
https://example.com/login&user=%23'%23\x22%0a-sleep(10)%23
https://example.com/login&user=1';+WAITFOR+DELAY+'0code:10'--
https://example.com/login&user=1%27%29+OR+SLEEP%280%29+AND+%28%27wlrm%27%3D%27wlrm
https://example.com/login&user=SLEEP(10)/*'XOR(SLEEP(10))OR'|\x22XOR(SLEEP(10))OR\x22*/
```

## Limitations

Threat Replay Testing is unavailable for:

* [Brute-force][al-brute-force-attack]
* [Forced browsing][al-forced-browsing]
* [BOLA][al-bola]
* Attacks with a request processing limit
* Attacks for which the vulnerabilities have already been closed
* Attacks that do not contain enough data for verification
* [Attacks that consist of hits grouped by originating IPs](../../admin-en/configuration-guides/protecting-with-thresholds.md)

See the list of the supported attack types in [setup](setup.md#configure-test-policies) documentation.
