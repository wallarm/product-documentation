					# 別々の環境でのフィルタリングノードの動作方法

アプリケーションは、本番環境、ステージング環境、テスト環境、開発環境など、いくつかの異なる環境にデプロイされることがあります。これらの指示では、異なる環境のフィルタノードを管理するための推奨方法について説明しています。

## 環境とは何か
環境の定義は会社ごとに異なることがありますが、この指示の目的のために、以下の定義が使用されます。

**環境**とは、異なる目的(本番環境、ステージング環境、テスト環境、開発環境など)のために使用される、分離された計算リソースのセットまたはサブセットであり、同じまたは異なるポリシーセット(ネットワーク/ソフトウェア設定、ソフトウェアのバージョン、監視、変更管理など)で管理され、同じまたは異なるチーム(SRE、QA、開発など)が担当します。

ベストプラクティスの観点からは、1つの製品縦のすべての環境(開発、テスト、ステージング、本番環境)でWallarmノードの設定を同期させることが推奨されます。

## 関連するWallarmの機能

異なる環境に対する異なるフィルタノードの設定を管理し、フィルタノードの変更を段階的に展開するのに役立つ3つの主要な機能があります。

* [リソース識別](#リソース識別)
* [別々のWallarmアカウントとサブアカウント](#別々のwallarmアカウントとサブアカウント)
* [フィルタノード操作モード](../../configure-wallarm-mode.ja.md)

### リソース識別

識別を使用して特定の環境のフィルターノードを設定するには、以下の2つの方法があります。

* 各環境のWallarmユニークID
* 環境の異なるURLドメイン名(あなたのアーキテクチャで既に設定されている場合)

#### IDによる環境識別

アプリケーションの概念により、異なる保護環境に対して異なるIDを割り当て、各環境のフィルタノードのルールを個別に管理することができます。

フィルタノードの設定時に、アプリケーションの概念を使用して、環境のWallarm IDを追加できます。IDを設定するには：

1. Wallarmアカウント→ **設定** → **アプリケーション**セクションにて、環境名とそのIDを追加します。

    ![!環境を追加](../../../images/admin-guides/configuration-guides/waf-in-separate-environments/added-applications.png)
2. フィルタノードでID設定を指定します:

    * Linuxベース、Kubernetesサイドカー、Dockerベースのデプロイメント用の [`wallarm_application`](../../configure-parameters-en.ja.md#wallarm_application) ディレクティブを使用してください。
    * Kubernetes NGINX Ingressコントローラデプロイメント用の [`nginx.ingress.kubernetes.io/wallarm-application`](../../configure-kubernetes-en.ja.md#ingress-annotations) アノテーションを使用してください。これで、新しいフィルタノードルールを作成する際に、特定のアプリケーションIDのセットにルールが割り当てられるように指定できます。属性がない場合、新しいルールは自動的にWallarmアカウント内のすべての保護対象リソースに適用されます。

![!ID用のルールを作成](../../../images/admin-guides/configuration-guides/waf-in-separate-environments/create-rule-for-id.png)

#### ドメインによる環境識別

各環境が `HOST` HTTPリクエストヘッダーに渡す異なるURLドメイン名を使用している場合、ドメイン名を各環境のユニークな識別子として使用することができます。

この機能を使用するには、設定されたフィルタノードルールごとに適切な `HOST` ヘッダーポインタを追加してください。次の例では、 `HOST` ヘッダーが `dev.domain.com` に等しいリクエストに対してのみルールがトリガーされます。

![!HOST用のルールを作成](../../../images/admin-guides/configuration-guides/waf-in-separate-environments/create-rule-for-host.png)

### 別々のWallarmアカウントとサブアカウント

異なる環境のフィルタノードの設定を隔離する簡単な方法の1つは、各環境または環境のグループに対して別々のWallarmアカウントを使用することです。このベストプラクティスは、Amazon AWSなどの多くのクラウドサービスベンダーによって推奨されています。

複数のWallarmアカウントの管理を簡素化するために、 `master` Wallarmアカウントを作成し、他の使用中のWallarmアカウントを `master` アカウントのサブアカウントとして割り当てることができます。この方法では、組織内のすべてのWallarmアカウントを管理するために1つのコンソールUIおよびAPI認証情報のセットを使用できます。

`master` アカウントとサブアカウントを有効化するには、 [Wallarmのサポート](mailto:support@wallarm.com) チームにお問い合わせください。この機能には別途Wallarmエンタープライズライセンスが必要です。

!!! warning "既知の制限事項"
    * 同じWallarmアカウントに接続されたすべてのフィルタリングノードは、同じトラフィックフィルタリングルールのセットを受信します。適切な [アプリケーションIDまたはユニークなHTTPリクエストヘッダー](#リソース識別) を使用して、異なるアプリケーションに対して異なるルールを適用することができます。
    * フィルタリングノードがIPアドレスを自動的にブロックすることを決定した場合(例：IPアドレスから3つ以上の攻撃ベクターが検出された場合)、システムはWallarmアカウント内のすべてのアプリケーションに対してIPをブロックします。