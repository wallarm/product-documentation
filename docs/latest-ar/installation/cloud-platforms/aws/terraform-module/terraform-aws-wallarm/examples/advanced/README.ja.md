# مثال على تنشيط وحدة Terraform الخاصة بوالآرم في AWS: حل البروكسي المتقدم

يوضح هذا المثال كيفية استخدام وحدة Terraform لتنشيط Wallarm كبروكسي مضمن مع إعدادات متقدمة في الشبكة الخاصة الافتراضية لـ AWS (VPC). يُشبه إلى حد ما [تنشيط البروكسي البسيط](https://github.com/wallarm/terraform-aws-wallarm/tree/main/examples/proxy)، ولكنه يُظهر خيارات الإعدادات المتقدمة المستخدمة بشكل شائع.

إذا وجدت صعوبة في بدأ هذا المثال، من الأفضل أن ترى أولاً [مثال البروكسي البسيط](https://github.com/wallarm/terraform-aws-wallarm/tree/main/examples/proxy).

تقدم حلول Wallarm البروكسي المتقدمة (بما في ذلك البروكسي البسيط) طبقة شبكية إضافية تعمل كموجه لحركة HTTP الخاصة بك مزودة بميزات الواجهة النهائية للتطبيقات الويب (WAF) وأمان API.

## الخصائص الرئيسية

تختلف الحل البروكسي المتقدم عن السهل كما يلي:

* هذا الحل لا ينشئ موزعا للأحمال (`lb_enabled=false`)، ولكنه ينشئ مجموعة أهداف يمكن أن تتكاثف مع موزع الأحمال الموجود.

    هذا يتيح لك التحويل ألية معالجة أكثر تزامنًا لحركة البيانات .
* يتم تحديد إعدادات NGINX ووالآرم ليست فقط عبر المتغيرات القياسية، ولكن أيضًا من خلال المقتطفات NGINX لـ `global_snippet`، `http_snippet`، و `server_snippet`.
* عند انتهاء تنفيذ سكريبت تهيئة العقدة wallarm (cloud-init)، ينشر السكريبت الخاص `post-cloud-init.sh` صفحة فهرس HTML مخصصة في دليل النسخة `/var/www/mysite/index.html`.
* يرتبط المكدس المنتشر بسياسة IAM إضافية في AWS تتيح وصولًا فقط للقراءة لـ AWS S3.

    إذا استخدمت هذا المثال "كما هو"، فإن الوصول المتاح ليس ضروريًا. بالرغم من ذلك، يتضمن الملف `post-cloud-init.sh` مثال غير نشط لطلبات الملفات من AWS S3 التي تتطلب عادةً الوصول الخاص. إذا كنت ترغب في تنشيط الشيفرة S3 من الملف `post-cloud-init.sh`، ستحتاج إلى تحديد سياسة وصول AWS S3 في المتغير `extra_policies`.
* تتيح لك هذه الحلول اتصالات داخلية متأتية من المنفذ الشبكي الداخلي الإضافي 7777 إلى عينة Wallarm. يتم تعيين هذا عبر المتغير `extra_ports` و `http_snippet.conf`.

    للسماح للمنفذ 7777 بـ `0.0.0.0/0`, يمكن استخدام المتغير `extra_public_ports`الإضافي بشكل اختياري.
* العقدة Wallarm تعالج البيانات في وضع الحجب.

## بناء الحلول

![مخطط البروكسي Wallarm](https://github.com/wallarm/terraform-aws-wallarm/blob/main/images/wallarm-as-proxy.png?raw=true)

يشتمل الحل البروكسي المتقدم لوالآرم على المكونات التالية:

* مجموعة أهداف متصلة بمجموعة Auto Scaling التي لا تحتوي على موزع للأحمال.
* عينات العقدة Wallarm تحلل حركة البيانات وتحجب الطلبات الخبيثة وتحول الطلبات المشروعة إلى البروكسي.

    في هذا المثال، يتم تشغيل العقدة Wallarm في وضع الحجب الذي يسير السلوك الموصوف أعلاه. يمكن لعقدة Wallarm التشغيل أيضا في أوضاع أخرى تستهدف فقط مراقبة حركة البيانات دون حجب الطلبات الخبيثة. لمزيد من التفاصيل حول وضع العقدة Wallarm، يرجى الرجوع لـ[وثائقنا](https://docs.wallarm.com/admin-en/configure-wallarm-mode/).
* العقدة Wallarm تحوّل حركة البيانات إلى `https://httpbin.org`.

    أثناء تنفيذ هذا المثال، يمكنك تحديد نطاقات أو مسارات خدمات أخرى قابلة للوصول من الشبكة الخاصة الافتراضية لـ AWS (VPC) لتحويل حركة البيانات إليها.

تنشط جميع المكونات المدرجة (باستثناء الخادم الموجه إليه حركة البيانات) عبر عينة `wallarm` الموفرة.

## مكونات الشيفرة

يتضمن هذا المثال المكونات البرمجية التالية:

* `main.tf`: الإعدادات الرئيسية لوحدة `wallarm` التي ستنشط كحل بروكسي متقدم.
* `global_snippet.conf`: مثال إعدادات NGINX الخاصة المضافة إلى الإعداد العام NGINX عبر المتغير `global_snippet`. المكونات المضافة يمكن أن تتضمن توجيهات تشمل `load_module` ، و`stream` ،و`mail`، و`env`.
* `http_snippet.conf`: شيفرة NGINX خاصة تضاف إلى نص NGINX `http` عبر المتغير `http_snippet`. المكونات المضافة يمكن أن تتضمن توجيهات تشمل `map` ، و `server`.
* `server_snippet.conf`: شيفرة NGINX خاصة تضاف إلى `server` في نص NGINX عبر المتغير `server_snippet`. المكونات المضافة يمكن أن تتضمن منطق NGINX `if` والإعداد اللازم لـ`location`.

    يُطبق التكوين المقطعي هذا فقط على المنفذ 80. لفتح المنافذ الأخرى، عيّن توجيه `server` المقابل في `http_snippet`.

    في الملف `server_snippet.conf`، يمكنك أيضًا العثور على أمثلة لإعدادات أكثر تعقيدًا.
* `post-cloud-init.sh`: سكريبت خاص تقوم بتنشيط صفحة فهرس HTML خاصة في الدليل النسخة `/var/www/mysite/index.html`. يتم تنفيذ هذا السكريبت بعد تهيئة عقدة Wallarm (سكريبت cloud-init).

    في الملف `post-cloud-init.sh`, يمكنك العثور أيضًا على أوامر تمثّل مثال لوضع محتوى AWS S3 في الدليل النسخة. إذا كنت ترغب في استخدام هذا الخيار، لا تنسى تحديد السياسة الخاصة بالوصول لـ S3 في المتغير `extra_policies`.

## تشغيل الحل البروكسي لوالآرم في AWS

1. قم بالاشتراك في واجهة التحكم Wallarm في [السحابة الأوروبية](https://my.wallarm.com/nodes) أو [السحابة الأمريكية](https://us1.my.wallarm.com/nodes).
1. افتح **العقد** في واجهة التحكم Wallarm وأنشئ عقدة **والآرم**.
1. انسخ الرمز المميز للعقدة المنشأة.
1. انسخ المستودع الذي يتضمن الشيفرة المثال:

    ```
    git clone https://github.com/wallarm/terraform-aws-wallarm.git
    ```
1. تعيين قيم المتغيرات في الخيار `default` داخل ملف `variables.tf` في المستودع النسخة `examples/advanced/`، وحفظ التغييرات.
1. تحديد البروتوكول وعنوان الخادم الذي سيتم توجيه حركة البيانات إليها في `proxy_pass` في ملف `examples/advanced/main.tf`.

    بشكل افتراضي، والآرم تحويل حركة البيانات إلى `https://httpbin.org`. إذا كانت القيمة الافتراضية تناسب حاجاتك، فابقِها كما هي.
1. شغّل الأوامر التالية من الدليل `examples/advanced` لتنشيط المكدس:

    ```
    terraform init
    terraform apply
    ```

لاستخدم البيئة المنشطة قم بشغيل الأمر التالي:

```
terraform destroy
```

## المراجع

* [ربط موزع الأحمال في AWS بمجموعة Auto Scaling](https://docs.aws.amazon.com/autoscaling/ec2/userguide/attach-load-balancer-asg.html)
* [شبكة الخاصة الافتراضية (VPC) في AWS بوجود شبكات فرعية ذات وصول للجمهور وخاصة مع جدار حماية الشبكة (NAT)](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Scenario2.html)
* [وثائق والآرم](https://docs.wallarm.com)
