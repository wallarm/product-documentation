# أمثلة على تنفيذ وحدة Terraform لـ AWS في Wallarm: حل الوكيل المتقدم 

يشرح هذا النموذج كيفية تطبيق Wallarm كوكيل على الخط مع إعدادات متقدمة في الخاص بك AWS السحابة الخاصة الافتراضية (VPC) باستخدام وحدة Terraform. يشابه ذلك [نشر الوكيل البسيط](https://github.com/wallarm/terraform-aws-wallarm/tree/main/examples/proxy) ، ولكنه يظهر خيارات التكوين المتقدمة الشائعة.

إذا واجهت صعوبة في بدء هذا النموذج، يرجى مراجعة [مثال الوكيل البسيط](https://github.com/wallarm/terraform-aws-wallarm/tree/main/examples/proxy) أولًا.

توفر حلول الوكيل المتقدمة لـ Wallarm (بما في ذلك الوكيل البسيط) طبقة شبكية إضافية بوظائف WAF وأمان API كموجه لحركة الشبكة HTTP المتقدمة.

## الخصائص الرئيسية

تختلف الحل المتقدم للوكيل عن البسيط كما يلي:

* هذا الحل لا يقوم بإنشاء موزع الحمولة(`lb_enabled=false`) ، لكنه ينشئ مجموعة الهدف التي يمكنك مرفقتها بموزع الحمولة الموجود بالفعل.

    يتيح لك هذا التحول بسهولة إلى نهج معالجة المرور المتزامنة.
* يتم تحديد التهيئة لـNGINX وWallarm ليس فقط من خلال المتغيرات القياسية، ولكن أيضا من خلال قصاصات NGINX `global_snippet`، `http_snippet` ، `server_snippet`.
* بمجرد اكتمال البرنامج النصي لتهيئة العقدة Wallarm (تهيئة السحابة cloud-init)، يتم توزيع البرنامج النصي `post-cloud-init.sh` المخصص لوضع صفحة فهرس HTML مخصصة في دليل الكائن `/var/www/mysite/index.html`.
* تكون المكدس المنشأ مرتبطًا بسياسة IAM إضافية من AWS تتيح الوصول للقراءة فقط إلى S3 على AWS.

    إذا كان ستستخدم هذا النموذج "كما هو"، الوصول المقدم غير ضروري. ومع ذلك، يحتوي الملف `post-cloud-init.sh` على أمثلة غير نشطة لطلبات الملفات من AWS S3، والتي تتطلب عادةً وصولًا خاصًا. إذا كنت ستقوم بتنشيط الكود من S3 في ملف `post-cloud-init.sh`، سيتعين عليك تحديد سياسة الوصول لـ IAM الخاصة بـ AWS S3 في المتغير `extra_policies`.
* يتيح لك هذا الحل الوصول الشبكي الداخلي الإضافي من المنفذ شبكة 7777 إلى عقدة Wallarm. يتم تعيين هذا في المتغير `extra_ports` و `http_snippet.conf`.

    يمكنك أيضًا استخدام المتغير `extra_public_ports` للسماح بالمنفذ 7777 لـ `0.0.0.0/0` (اختياري).
* تعالج العقدة Wallarm حركة البيانات بنمط الحظر.

## هيكلية الحل

![مخطط الوكيل Wallarm](https://github.com/wallarm/terraform-aws-wallarm/blob/main/images/wallarm-as-proxy.png?raw=true)
تحتوي حلول الوكيل المتقدمة الخاصة بـ Wallarm في هذا النموذج على المكونات التالية:

*مجموعة الهدف المرتبطة بمجموعة Auto Scaling بدون موزع حمولة.
* عقدة Wallarm تحلل حركة البيانات، وتحظر الطلبات الخبيثة وتعيد توجيه الطلبات الشرعية.

    في هذا النموذج، تعمل العقدة Wallarm في نمط الحظر لتحرك السلوك المذكور. يمكن أن تعمل العقدة Wallarm أيضا في أنماط أخرى ، وتهدف إلى مراقبة حركة المرور فقط وبدون حظر الطلبات الخبيثة. يرجى الرجوع إلى [توثيقاتنا](https://docs.wallarm.com/admin-en/configure-wallarm-mode/) لمزيد من التفاصيل حول أنماط العقدة Wallarm.
تعيد توجيه العقدة Wallarm حركة البيانات إلى `https://httpbin.org`.
يمكنك تحديد نطاقات خدمة أخرى متاحة من VPC AWS الخاص بك أو مسارات لإعادة توجيه حركة البيانات أثناء تشغيل هذا النموذج.

تنصب جميع المكونات المدرجة (باستثناء الخادم الذي تم توجيهه) بواسطة وحدة `wallarm` المقدمة في النموذج.

## المكونات البرمجية

يحتوي هذا النموذج على المكونات البرمجية التالية:

* `main.tf`:التكوين الرئيسي لوحدة `wallarm` يتم تنصيبه كحل الوكيل المتقدم.
*  `global_snippet.conf`: امثلة التكوين المخصص لـ NGINX التي يتم إضافتها إلى التكوين العام لـ NGINX بواسطة المتغير `global_snippet`. يمكن تضمين توجيهات `load_module` ، `stream` ، `mail` ، `env` وما إلى ذلك في التهيئة المثبتة.
* `http_snippet.conf`: التكوين المخصص لـ NGINX يتم إضافته إلى سياق NGINX `http` بواسطة المتغير `http_snippet` . يمكن تضمين التوجيهات مثل `map` و `server` في التكوين المثبت.
* `server_snippet.conf`: التكوين المخصص لـ NGINX يتم إضافته إلى سياق `server` NGINX بواسطة المتغير `server_snippet`. يمكن للتكوين المثبت أن يقدم منطق NGINX `if` وتكوين `location` المطلوب.
هذا التكوين للقصاصات ينطبق فقط على المنفذ 80. لفتح منافذ أخرى، يجب عليك تحديد التوجيه `server` المناسب في `http_snippet`.
في ملف `server_snippet.conf`، يمكنك أيضًا العثور على أمثلة لإعدادات أكثر تعقيدًا.
* `post-cloud-init.sh`: البرنامج النصي المخصص لوضع صفحة فهرس HTML مخصصة في دليل `/var/www/mysite/index.html` الخاص بالكائن. يتم تشغيل هذا البرنامج النصي بعد التهيئة الأولية للعقدة Wallarm (السحابة النصية السحابية cloud-init).
في ملف `post-cloud-init.sh`، يمكنك أيضا العثور على أوامر لوضع محتوى من AWS S3 في دليل الكائن. إذا كنت ستستخدم هذا الخيار، فلا تنس تحديد سياسة الوصول لـ S3 في المتغير `extra_policies`.

## تشغيل حل الوكيل AWS من Wallarm

1. قم بالتسجيل في وحدة التحكم Wallarm على ال[Cloud الأوروبي](https://my.wallarm.com/nodes) أو ال[Cloud الأمريكي](https://us1.my.wallarm.com/nodes).
1. افتح Wallarm Console → **Nodes**, وأنشئ عقدة من نوع **Wallarm Node**.
1. انسخ الرمز التوكين المولدة للعقدة.
1. انسخ المستودع الذي يحتوي على الكود البرمجي إلى جهازك.

    ```
    git clone https://github.com/wallarm/terraform-aws-wallarm.git
    ```
1. ضبط قيم الأمثلة في خيار `default` في ملف `variables.tf` بداخل المستودع المنسوخ `examples/advanced` ثم حفظ التغييرات.
1. في ملف `examples/advanced/main.tf`, قم بتحديد بروتوكول وعنوان الخادم الذي ستتم إعادة توجيهه في `proxy_pass`.
من المحتمل أن يقوم Wallarm باعادة توجيه حركة الشبكة إلى `https://httpbin.org` بشكل افتراضي. إذا كانت القيم الافتراضية تناسب احتياجاتك، فاتركها كما هي.
1. قم بتنفيذ الأوامر التالية من داخل الدليل `examples/advanced` لتنصيب المكدس:

    ```
    terraform init
    terraform apply
    ```

إذا أردت حذف البيئة المنصبة، استخدم الأوامر التالية :

```
terraform destroy
```

## مراجع

* [ربط موزع الحمولة الخاص بـ AWS بمجموعة Auto Scaling](https://docs.aws.amazon.com/autoscaling/ec2/userguide/attach-load-balancer-asg.html)
* [شبكة AWS الافتراضية الخاصة مع الشبكات الفرعية العامة والخاصة (NAT)](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Scenario2.html)
* [توثيقات Wallarm](https://docs.wallarm.com)