# تنصيب Wallarm كبروكسي في AWS VPC

المثال التالي يوضح كيفية تنصيب Wallarm كبروكسي داخلي ضمن AWS Virtual Private Cloud (VPC) القائم، باستخدام [وحدة Terraform](https://registry.terraform.io/modules/wallarm/wallarm/aws/).

هالبروكسي من Wallarm بيقدم طبقة شبكة إضافية، بتعمل كموجه لحركة البيانات HTTP المتقدمة، مع ميزات WAF وأمان الواجهة البرمجية للتطبيق.

بتجربة [البروكسي المتقدم](https://github.com/wallarm/terraform-aws-wallarm/tree/main/examples/advanced)، بإمكانك التأكد من مرونته.

## الخصائص الرئيسية

* Wallarm بيتعامل مع حركة البيانات في الوضع المتزامن، وبيمكنه التخفيف الفوري من التهديدات بدون أي قيود على ميزات Wallarm (`preset=proxy`).
* حل Wallarm يمكن تنصيبه كطبقة في الشبكة بشكل مستقل عن الطبقات الأخرى، ويمكنه أن يتم تركيبه في أي موضع ضمن البنية التحتية للشبكة. الموضع الموصى به هو خلف موزع الحمل الخاص بالإنترنت.

## الهيكل العماري للحل

![مخطط البروكسي من Wallarm](https://github.com/wallarm/terraform-aws-wallarm/blob/main/images/wallarm-as-proxy.png?raw=true)

البروكسي من Wallarm بيحتوي على المكونات الأتية:

* موزع الحمل للتطبيقات يتعامل مع الإنترنت ويوجه حركة البيانات لنسخ Wallarm.
* نسخ Wallarm التي تحلل حركة البيانات وتوجه أي طلب لها كبروكسي. العناصر المقابلة هي النسخ A، B، C في المخطط.
  
  في هذا المثال، Wallarm بتعمل في الوضع المراقب اللي بينشأ تصرفات معينة. Wallarm بيمكنه أيضًا العمل في الوضعيات الأخرى، مثل حجب الطلبات الخبيثة وتوجيه الطلبات الشرعية فقط. لمعرفة المزيد حول أوضاع Wallarm، تفضل بزيارة [توثيقاتنا](https://docs.wallarm.com/admin-en/configure-wallarm-mode/).
* الخدمة التي تتعامل Wallarm معها كبروكسي. الخدمة يمكن أن تكون من أي نوع. على سبيل المثال:
  * تطبيق AWS API Gateway المتصل بـ VPC عبر نقاط النهاية للVPC تم تغطيته في [مثال بوابة الـ API](https://github.com/wallarm/terraform-aws-wallarm/tree/main/examples/apigateway)).
  * AWS S3
  * نسخة EKS التي تعمل داخل الكتلة الEKS (لهذه الحالة، الإعداد المفضل هو استخدام موزع حمل داخلي أو خدمة NodePort).
  * الخدمات الخلفية الأخرى
  
  نسخة Wallarm بيتعامل كبروكسي مع `https://httpbin.org` بشكل افتراضي. بإمكانك أن تحدد أي عنوان ضمن التطبيق الخاص بك، أو طريق ما، ليتم العمل عليها كبروكسي خلال التجربة.

  بإمكانك استخدام خيار الموديول `https_redirect_code = 302` للقيام بتحويل طلبات HTTP إلى HTTPS بشكل آمن عن طريق AWS ALB.

المكونات المدرجة (ما عدا الخادم اللي بيتعاملو كبروكسي) بيتم تنصيبها من قبل وحدة `wallarm` المعتبرة مثلا.

## مكونات الكود

هذا المثال يحتوي على المكونات الكود التالية:

* `main.tf`: هو الإعداد الرئيسي لوحدة `wallarm` المتم تنصيبها كبروكسي. الإعداد بيولد AWS ALB ونسخة Wallarm.
* `ssl.tf`: بتجهز إعدادات SSL/TLS لموديول ACM الخاص بAWS الذي يتم إصداره تلقائيا للنطاق المحدد بـ `variable_name`، وبيتم ربطه مع AWS ALB.
  
  لتعطيل هذه الخاصية، يرجى التعليق على ملفات `ssl.tf` و `dns.tf`، وكذلك على الخيارات `lb_ssl_enabled`، `lb_certificate_arn`، `https_redirect_code`، `depends_on` في تعريف الموديول `wallarm`. بتعطيل هذه الخاصية، بيمكن فقط استخدام المنفذ HTTP (80).
* `dns.tf`: بيحدد إعدادات DNS لـ AWS Route 53 لتجهيز سجلات DNS لـ AWS ALB.

  لتعطيل هذه الخاصية، يرجى اتباع التعليمات السابقة.

## المتطلبات

* تنصيب Terraform 1.0.5 أو أعلى في مكانك [محليًا](https://learn.hashicorp.com/tutorials/terraform/install-cli).
* القدرة على الوصول إلى حساب له دور **اداري** في [السحابة الأوروبية](https://my.wallarm.com/) أو [السحابة الأمريكية](https://us1.my.wallarm.com/) لـ Wallarm.
* القدرة على الوصول إلى `https://api.wallarm.com` إذا كانت السحابة الأوروبية متعاونة مع Wallarm، أو إلى `https://us1.api.wallarm.com` إذا كانت السحابة الأمريكية متعاونة مع Wallarm. أكد أن الحائط الناري لم يحجب الوصول.
* إذا كنت تنوي شغّل المثال الذي يتضمن ميزات SSL و DNS، الرجاء تجهيز [منطقة استضافة Route 53](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zones-working-with.html).

## تنفيذ مثال البروكسي من Wallarm

1. سجل في [السحابة الأوروبية](https://my.wallarm.com/nodes) أو [السحابة الأمريكية](https://us1.my.wallarm.com/nodes) لـ Wallarm.
1. افتح القائمة Wallarm → **النسخ**، وأنشئ نسخة من نوع **Wallarm**.
1. انسخ الرمز الخاص بالنسخة.
1. قم بنسخ المستودع الذي يحتوي على كود المثال إلى جهازك:

    ```
    git clone https://github.com/wallarm/terraform-aws-wallarm.git
    ```
1. قم بتعيين القيم الخاصة بالمتغيرات في ملف `variables.tf` الذي يوجد ضمن المستودع المنسوخ في الخيار `default`، واحفظ التغييرات.
1. قم بتعيين بروتوكول البروكسي وعنوانه في `examples/proxy/main.tf`→`proxy_pass`.

  بشكل افتراضي، Wallarm بيتعامل كبروكسي مع `https://httpbin.org`. أذا كانت القيمة الافتراضية تلبي احتياجاتك، بامكانك تركها كما هي.
1. قم بتنفيذ الأوامر التالية من داخل الدليل `examples/proxy` لتركيب الجدول:

    ```
    terraform init
    terraform apply
    ```

لإزالة البيئة المنصبة، استخدم الأمر التالي:

```
terraform destroy
```

## حل المشكلات

### Wallarm بيكرر إنشاء النسخ ومسحها

تم تنظيم إعدادات مجموعة ال Auto Scaling المستخرجة بمركز الاهتمام على أعلى معدل موثوقية وبسلاسة للخدمة. إذا كانت النسخ الEC2 مكررة وتتم إزالتها أكثر من مرة أثناء بداية تشغيل مجموعة ال Auto Scaling، فقد يكون السبب هو فشل فحوصات الحالة الخاصة بك.

أخطائك بيتم حلها عبر التحقق من الإعدادات التالية وتعديلها:

* تأكد أن الرمز الخاص بنسخة Wallarm يمثل قيمة صحيحة ومنسوخة من واجهة المستخدم الخاصة بك لوحدة التحكم في Wallarm.
* التحقق من صحة اعدادات NGINX.
* التحقق من أن الاسم النطاقي الذي تم تحديده في إعدادات NGINX يتم حله بشكل صحيح (على سبيل المثال، القيمة `proxy_pass`).

**الحل الأخير** إذا استمرت المشكلة حتى مع توفرك للإعدادات الصحيحة، أطفىء فحوصات الحالة الخاصة بـ ELB يدويًا في إعدادات مجموعة ال Auto Scaling لتعرف سبب المشكلة. وبهالطريقة، هتكون النسخ مستمرة في العمل، حتى لو كانت الإعدادات للخدمة غير صالحة، والنسخ ما هتعاد تشغيلها. هتأخذ وقت أطول للبحث عن الأخطاء في السجلات، ولتترجم الخدمة، وممكن تحل المشكلة خلال دقائق.

## المراجع

* [شهادات AWS ACM](https://docs.aws.amazon.com/acm/latest/userguide/gs.html)
* [AWS VPC له نقاط نهاية عامة وخاصة (NAT)](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Scenario2.html)