# تحديد معدل الطلبات

تشمل [استهلاك الموارد دون قيود](https://github.com/OWASP/API-Security/blob/master/editions/2023/en/0xa4-unrestricted-resource-consumption.md) في قائمة [أوساب لأمن الواجهة البرمجية أبي ٢٠٢٣](../../user-guides/dashboards/owasp-api-top-ten.md#owasp-api-top-10-2023-dashboard) لأخطر مخاطر أمن الواجهة البرمجية. lack of rate limiting هو من أهم أسباب هذا المخاطر. بدون تدابير تحديد معدل الطلبات المناسبة، الواجهات البرمجية عرضة للهجمات مثل denial-of-service (DoS)، القوى العمياء و استخدام الواجهة الزائد. هذه المقالة تشرح كيفية حماية واجهتك البرمجية ومستخدميها بقاعدة تنظيم تحديد معدل الطلبات لـ Wallarm.

Wallarm توفر قاعدة **تحديد معدل الطلبات** [rule](../../user-guides/rules/rules.md) للمساعدة في منع الزيادة المفرطة في حركة المرور لواجهتك البرمجية. تمكنك هذه القاعدة من تحديد الحد الأقصى لعدد الاتصالات التي يمكن إجراؤها بنطاق معين، مع ضمان توزيع الطلبات الواردة بالتساوي. إذا تجاوز طلب الحد المحدد، يرفضه Wallarm ويعيد الكود الذي اخترته في القاعدة.

Wallarm يفحص معايير الطلب المختلفة مثل الكوكيز أو حقول JSON، مما يسمح لك بتحديد الاتصالات بناءً ليس فقط على عنوان IP المصدر، ولكن أيضاً على معرفات الجلسات، أسماء المستخدمين، أو عناوين البريد الإلكتروني. هذا المستوى الإضافي من التفصيل يمكنك من تعزيز الأمان العام لمنصة بناءً على أي بيانات مصدر.

لاحظ أن تحديد معدل الطلبات الموضح في هذه المقالة هو واحد من طرق التحكم في الحمل المقدمة بواسطة Wallarm - كبديل، يمكنك تطبيق [حماية ضد القوى العمياء](../../admin-en/configuration-guides/protecting-against-bruteforce.md). استخدم تحديد معدل الطلبات لإبطاء حركة المرور الواردة وحماية القوى العمياء لحظر الهجوم بالكامل.

## إنشاء وتطبيق القاعدة

لتعيين وتطبيق تحديد معدل الطلبات:

1. انتقل إلى وحدة التحكم Wallarm → **القواعد** → **إضافة قاعدة**.
1. في **إذا كان الطلب هو**, [وصف](rules.md#branch-description) النطاق لتطبيق القاعدة عليه.
1. في **ثم**, اختر **تحديد معدل الطلبات** واضبط حدًا مرغوبًا للاتصالات بنطاقك:

    * الحد الأقصى لعدد الطلبات في الثانية أو الدقيقة.
    * **الترف** - الحد الأقصى لعدد الطلبات الزائدة التي يتم تخزينها مؤقتًا بمجرد تجاوز RPS/RPM المحدد ومعالجتها بمجرد عودة المعدل إلى طبيعته. `0` بشكل افتراضي.

        إذا كانت القيمة مختلفة عن `0`، يمكنك التحكم في حفظ RPS/RPM المحدد بين تنفيذ الطلبات الزائدة المخزنة مؤقتًا.
        
        **بدون تأخير** يشير إلى معالجة كل الطلبات الزائدة المخزنة مؤقتًا في نفس الوقت، بدون تأخير تحديد المعدل. **التأخير** يعني معالجة عدد محدد من الطلبات الزائدة المخزنة مؤقتًا في نفس الوقت، ويتم معالجة الآخرين بتأخير محدد في RPS/RPM.
    
    * **رمز الاستجابة** - الكود المراد إرجاعه في استجابة للطلبات المرفوضة. `503` بشكل افتراضي.

        أدناه مثال على سلوك تحديد معدل الطلبات مع حد 5 ط/ث، برَف 12 وتأخير 8.
        
        ![كيفية عمل تحديد معدل الطلبات](../../images/user-guides/rules/rate-limit-schema.png)

        الطلبات الثمانية الأولى (قيمة التأخير) تنقل عبر عقدة Wallarm بدون تأخير. الطلبات الأربعة التالية (الترف - التأخير) مؤخرة حتى لا يتم تجاوز المعدل المحدد 5 ط/ث. الطلبات الثلاثة التالية مرفوضة لأنه قد تم تجاوز الحجم الإجمالي للترف. الطلبات التالية مؤخرة.

1. في **في هذا الجزء من الطلب**, حدد نقاط الطلب التي ترغب في تعيين حدود لها. سيقيد Wallarm الطلبات التي لها نفس القيم لمعايير الطلب المختارة.

    كل النقاط المتاحة موصوفة [هنا](request-processing.md)، يمكنك اختيار تلك التي تتوافق مع حالتك الخاصة، مثل:
    
    * `remote_addr` لتحديد الاتصالات بواسطة IP المنشأ
    * `json` → `json_doc` → `hash` → `api_key` لتحديد الاتصالات بواسطة معامل `api_key` في جسم JSON

    !!! info "قيود على طول القيمة"
        الطول الأقصى المسموح به لقيم المعايير التي يتم بواسطتها قياس الحدود هو 8000 رمز.
1. انتظر حتى [اكتمال تجميع القاعدة](rules.md#ruleset-lifecycle).

## أمثلة على القواعد

### تحديد الاتصالات بواسطة IP لضمان توفر الواجهة البرمجية بشكل عالي

لنفترض أن شركة رعاية صحية واجهتها البرمجية REST تسمح للأطباء بتقديم معلومات عن المرضى من خلال طلب POST إلى نقطة النهاية `/patients` لمضيف `https://example-host.com`. توفر هذه النقطة أمر بالغ الأهمية، ولذلك لا ينبغي أن تثقل بعدد كبير من الطلبات.

تحديد الاتصالات بواسطة IP خلال فترة معينة خصيصًا لنقطة النهاية `/patients` يمكن أن يمنع هذا. يضمن هذا الاستقرار وتوفر النقطة لجميع الأطباء، مع حماية أمان معلومات المرضى أيضًا بمنع هجمات DoS.

على سبيل المثال، يمكن تعيين حد لـ 5 طلبات POST في الدقيقة لكل عنوان IP كما يلي:

![مثال](../../images/user-guides/rules/rate-limit-by-ip-for-patients.png)

### تحديد الاتصالات بواسطة الجلسات لمنع هجمات القوة العمياء على معايير المصادقة

بتطبيق تحديد معدل الطلبات على جلسات المستخدمين، يمكنك تقييد محاولات القوة العمياء للعثور على JWTs صحيحة أو معايير مصادقة أخرى للوصول غير المصرح به إلى الموارد المحمية. على سبيل المثال، إذا تم تعيين تحديد معدل الطلبات للسماح بـ 10 طلبات فقط في الدقيقة تحت جلسة، فإن المهاجم الذي يحاول اكتشاف JWT صالح عن طريق إجراء عدة طلبات بقيم رمز مختلفة سيصل بسرعة إلى حد تحديد معدل الطلبات، وسيتم رفض طلباته حتى تنتهي فترة تحديد معدل الطلبات.

لنفترض أن تطبيقك يخصص لكل جلسة مستخدم رقمًا فريدًا ويعكسه في رأس `X-SESSION-ID`. نقطة الواجهة البرمجية على URL `https://example.com/api/login` تقبل طلبات POST التي تشمل Bearer JWT في رأس `Authorization`. لهذا السيناريو، ستظهر القاعدة لتحديد الاتصالات بالجلسات على النحو التالي:

![مثال](../../images/user-guides/rules/rate-limit-for-jwt.png)

ال[regexp](rules.md#condition-type-regex) المستخدم لقيمة `Authorization` هو ``^Bearer\s+([a-zA-Z0-9-_]+[.][a-zA-Z0-9-_]+[.][a-zA-Z0-9-_]+)$``.

إذا كنت تستخدم JWT (رموز الويب جسون) لإدارة جلسات المستخدمين، يمكنك تعديل القاعدة ل[فك التشفير](request-processing.md#jwt) للJWT واستخراج معرف الجلسة من حملها كما يلي:

![مثال](../../images/user-guides/rules/rate-limit-for-session-in-jwt.png)

### تحديد الاتصالات بواسطة معرفات العملاء لمنع إغراق الخادم

لنأخذ في الاعتبار خدمة ويب توفر الوصول إلى بيانات طلبات العملاء لمنصة التسوق عبر الإنترنت. يمكن أن يساعد تحديد معدل الطلبات بواسطة معرف العميل في منع العملاء من وضع العديد من الطلبات في فترة قصيرة من الزمن، مما يمكن أن يؤدي إلى ضغط على إدارة المخزون وتنفيذ الطلبات.

على سبيل المثال، قد يبدو الحد لكل عميل بـ 10 طلبات POST في الدقيقة إلى `https://example-domain.com/orders` على النحو التالي. هذا المثال يعتبر أن معرف العميل يتم [تمريره](request-processing.md#json_doc) في كائن JSON الخاص بالجسم `data.customer_id`.

![مثال](../../images/user-guides/rules/rate-limit-by-customer-id.png)

## القيود والخصوصيات

وظيفة تحديد معدل الطلبات لها القيود والخصوصيات التالية:

* قاعدة تحديد معدل الطلبات مدعومة بجميع [أشكال نشر Wallarm](../../installation/supported-deployment-options.md) باستثناء صورة Docker المبنية على Envoy.
* الطول الأقصى المسموح به لقيم المعايير التي يتم بواسطتها قياس الحدود هو 8000 رمز.
* إذا كان لديك عقد Wallarm متعددة وكانت الحركة الواردة على كل عقدة تلبي قاعدة تحديد معدل الطلبات، يتم تحديدها بشكل مستقل.
* عندما تنطبق قواعد تحديد معدل الطلبات المتعددة على الطلبات الواردة، يتم استخدام القاعدة ذات معدل التحديد الأقل لتحديد الطلبات.
* إذا لم يكن للطلب الوارد النقطة المحددة في قسم **في هذا الجزء من الطلب** من القاعدة، فلا يتم تطبيق هذه القاعدة كقيد لذلك الطلب.
* إذا كان خادم الويب الخاص بك