[link-regex]:                   https://github.com/yandex/pire
[link-request-processing]:      request-processing.md
[img-add-rule]:                 ../../images/user-guides/rules/section-rules-add-rule.png

# القواعد

تُستخدم القواعد لضبط [السلوك الافتراضي](../../about-wallarm/protecting-against-attacks.md#tools-for-attack-detection) لـ Wallarm أثناء تحليل الطلبات ومعالجتها بعد ذلك. وبالتالي، باستخدام القواعد، يمكنك تغيير الطريقة التي يكتشف بها النظام الطلبات الخبيثة وكيف يتصرف عند اكتشاف طلبات خبيثة مثل هذه.

يتم تكوين القواعد في قسم **القواعد** في السحابة [الأمريكية](https://us1.my.wallarm.com/rules) أو السحابة [الأوروبية](https://my.wallarm.com/rules).

![القسم القواعد](../../images/user-guides/rules/section-rules.png)

!!! warning "تأخير تطبيق القاعدة"
    عند إجراء تغييرات على القواعد، فإنها لا تسري فورا بحيث يستغرق بعض الوقت لـ [تجميع القواعد](#ruleset-lifecycle) وتحميلها إلى العقد الفاصلة.

## ما يمكنك القيام به بالقواعد

باستخدام القواعد، يمكنك توفير تدابير الحماية المتعددة لتطبيقاتك وواجهات برمجة التطبيقات، وكذلك ضبط كيفية اكتشاف الهجمات وكيف يعمل عقد Wallarm وبعض مكونات Wallarm:

* [تعيين معدل الحد](../../user-guides/rules/rate-limiting.md)
* [تطبيق رقعة افتراضية](../../user-guides/rules/vpatch-rule.md)
* [إنشاء قاعدة كشف خاصة بك](../../user-guides/rules/regex-rule.md)
* [تغطية البيانات الحساسة](../../user-guides/rules/sensitive-data-rule.md)
* ضبط وظيفة العقدة بواسطة [تحديد وقت معالجة الطلب](../../user-guides/rules/configure-overlimit-res-detection.md)
* ضبط معالجة الطلب بواسطة [إدارة محللات الطلب](../../user-guides/rules/request-processing.md#managing-parsers)
* تكوين الطبقة الإضافية لأمان التطبيق بواسطة [تغيير رؤوس استجابة الخادم](../../user-guides/rules/add-replace-response-header.md)
* ضبط كشف الهجمات عن طريق الضبط على [تجاهل أنواع الهجمات المعينة](../../about-wallarm/protecting-against-attacks.md#ignoring-certain-attack-types) وإلى [تجاهل بعض علامات الهجمات في البيانات الثنائية](../../about-wallarm/protecting-against-attacks.md#ignoring-certain-attack-signs-in-the-binary-data)

## فروع القاعدة

تتم تجميع القواعد تلقائياً إلى فروع متداخلة حسب نقاط النهاية لـ URIs والأحكام الأخرى. هذا يبني بنية شجرية حيث تُرَث القواعد تحت. المبادئ:

* تُرث جميع الفروع [القواعد الافتراضية](#default-rules).
* في فرع، ترث نقاط النهاية الفرعية القواعد من الأب.
* له الجدة أولوية عن المُرثى.
* لديه المُحدَّد مباشرة أولوية على [regex](rules.md#condition-type-regex).
* حالات [الحساسة](rules.md#condition-type-equal) لها الأولوية على [غير الحساسة](rules.md#condition-type-iequal-aa).

![نظرة عامة على علامة القواعد](../../images/user-guides/rules/rules-overview.png)

### القواعد الافتراضية

يمكنك إنشاء قواعد بإجراء محدّد ولكنها ليست مرتبطة بنقطة نهاية – وهي تُسمى **القواعد الافتراضية**. تُطبق مثل هذه القواعد على جميع النقاط النهائية.

* لإنشاء قاعدة افتراضية، اتبع [الإجراء القياسي](#configuring) ولكن اترك URI فارغا. ستتم إنشاء قاعدة جديدة غير مرتبطة بأي نقطة نهاية.
* لعرض قائمة القواعد الافتراضية المنشأة، انقر على الزر **القواعد الافتراضية**.
* القواعد الافتراضية مُرثى بواسطة جميع الفروع.

!!! info "قاعدة الوضع الافتراضي لترشيح حركة المرور"
    تُنشئ Wallarm تلقائياً قاعدة "تحديد وضع الترشيح" الافتراضية لجميع العملاء وتضبط قيمتها على أساس [إعداد الوضع العام للتصفية](../../admin-en/configure-wallarm-mode.md#setting-up-the-general-filtration-rule-in-wallarm-console).

### عرض قواعد الفرع

هذه بعض تفاصيل كيفية العمل مع فروع القاعدة:

* لتوسيع نقطة النهاية، انقر على الدائرة الزرقاء.
* النقاط النهائية التي ليست لديها قواعد متميزة مظللة وغير قابلة للنقر.
    
    ![فرع من النقاط النهائية](../../images/user-guides/rules/rules-branch.png)

* لعرض القواعد لنقطة النهاية، انقر عليها. أولا، ستتم عرض القواعد المميزة لهذه النقطة النهائية.
* عند عرض قائمة القواعد لنقطة النهاية المحددة، انقر على **قواعد مميزة ومُرثى** لعرض تلك المُرثى. ستتم عرض القواعد المُرثى مع المميزة؛ ستكون غامقة مقارنة بالمميزة.

    ![قواعد مميزة ومُرثى لنقطة النهاية](../../images/user-guides/rules/rules-distinct-and-inherited.png)

## التكوين

لإضافة قاعدة جديدة، انتقل إلى قسم **القواعد** في السحابة [الأمريكية](https://us1.my.wallarm.com/rules) أو السحابة [الأوروبية](https://my.wallarm.com/rules). يمكن إضافة القواعد إلى كلاً من [الفروع](#rule-branches) الموجودة ومن الألف والى الياء والتي ستنشئ فرعا جديدا إذا لم يكن موجودا.

![إضافة قاعدة جديدة][img-add-rule]

لاحظ أنه يتم تطبيق القاعدة على الطلب فقط إذا تم استيفاء بعض الشروط (مثل نقطة النهاية المستهدفة، الوسيلة، وجود بعض المعلمات أو القيم، إلخ.). أيضا، غالباً ما يتم تطبيقه فقط على بعض أجزاء الطلب. للحصول على فهم أفضل لتفاعل بنية الطلب مع القواعد، من الجيد أن تتعلم كيف يقوم العقدة الفاصلة [بتحليل الطلبات][link-request-processing].

يمكن تحديد شروط القاعدة باستخدام:

* [منشئ URI](#uri-constructor) - يتيح تكوين شروط القاعدة عن طريق تحديد الطريقة الطلب والنقطة النهائية في سلسلة واحدة فقط.
* [نموذج التحرير المتقدم](#advanced-edit-form) - يوسع المنشئ URI للسماح بتكوين طريقة النقطة النهائية / النقطة النهائية وشروط القاعدة الإضافية، مثل التطبيق، الرؤوس، معلمات سلسلة الاستعلام وغيرها.

### منشئ URI

يتيح منشئ URI تكوين شروط القاعدة عن طريق تحديد طريقة الطلب والنقطة النهائية في سلسلة واحدة فقط.

#### الاستخدام العام

يقدم منشئ URI:

* المحدد لطريقة الطلب. إذا لم يتم تحديد الوسيلة، سيتم تطبيق القاعدة على الطلبات بأي وسيلة.
* حقل لنقطة النهاية للطلب الذي يقبل تنسيقات القيمة التالية:

    | التنسيق | المثال |
    | ------ | ------ |
    | الـ URI الكامل بما في ذلك المكونات التالية:<ul><li>البرنامج (يتم تجاهل القيمة، يمكنك تحديد البرنامج بصراحة باستخدام النموذج المتقدم)</li><li>النطاق أو العنوان IP</li><li>المنفذ</li><li>المسار</li><li>معلمات سلسلة الاستعلام</ul> | `https://example.com:3000/api/user.php?q=action&w=delete`<br><ul><li>`[header, 'HOST']` - `example.com:3000`</li><li>`[path, 0]` - `api`</li><li>`[path, 1]` - `∅`</li><li>`[action_name]` - `user`</li><li>`[action_ext]` - `php`</li><li>`[query, 'q']` - `action`</li><li>`[query, 'w']` - `delete`</li></ul>|
    | URI مع بعض المكونات مفقودة | `example.com/api/user`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[path, 0]` - `api`</li><li>`[path, 1]` - `∅`</li><li>`[action_name]` - `user`</li><li>`[action_ext]` - `∅`</li></ul><br>`http://example.com/api/clients/user/?q=action&w=delete`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[path, 0]` - `api`</li><li>`[path, 1]` - `clients`</li><li>`[path, 2]` - `∅`</li><li>`[action_name]` - `user`</li><li>`[query, 'q']` - `action`</li><li>`[query, 'w']` - `delete`</li></ul><br>`/api/user`<br><ul><li>``[header, 'HOST']` - أي قيمة</li><li>`[path, 0]` - `api`</li><li>`[path, 1]` - `∅`</li><li>`[action_name]` - `user`</li><li>`[action_ext]` - `∅`</li></ul>|
    | URI مع `*` تعني أي قيمة غير فارغة للمكون | `example.com/*/create/*.*`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[path, 0]` - أي قيمة غير فارغة (مخفية في النموذج المتقدم)</li><li>`[path, 1]` - `create`</li><li>`[path, 2]` - `∅`</li><li>`[action_name]` - أي قيمة غير فارغة (مخفية في النموذج المتقدم)</li><li>`[action_ext]` - أي قيمة غير فارغة (مخفية في النموذج المتقدم)</li>تتطابق القيمة مع `example.com/api/create/user.php`<br>ولا تطابق `example.com/create/user.php` و `example.com/api/create`.</ul>|
    | URI مع `**` يعني أي عدد من المكونات بما في ذلك غيابها | `example.com/**/user`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[action_name]` - `user`</li><li>`[action_ext]` - `∅`</li>القيمة تطابق `example.com/api/create/user` و `example.com/api/user`.<br>القيمة لا تطابق `example.com/user`, `example.com/api/user/index.php` and `example.com/api/user/?w=delete`.</ul><br>`example.com/api/**/*.*`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[path, 0]` - `api`</li><li>`[action_name]` - أي قيمة غير فارغة (مخفية في النموذج المتقدم)</li><li>`[action_ext]` - أي قيمة غير فارغة (مخفية في النموذج المتقدم)</li>تتطابق القيمة مع `example.com/api/create/user.php` و `example.com/api/user/create/index.php`<br>ولا تطابق `example.com/api`, `example.com/api/user` و `example.com/api/create/user.php?w=delete`.</ul> |
    | URI مع [التعبير العادي](#condition-type-regex) لتطابق قيم المكونات معينة (يجب أن يكون التعبير العادي محاطا بـ `{{}}`) | `example.com/user/{{[0-9]}}`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[path, 0]` - `user`</li><li>`[path, 1]` - `∅`</li><li>`[action_name]` - `[0-9]`</li><li>`[action_ext]` - `∅`</li>القيمة تتطابق `example.com/user/3445`<br>ولا تتطابق `example.com/user/3445/888` و `example.com/user/3445/index.php`.</ul> |

تُحلل السلسلة المحددة في منشئ الـ URI تلقائياً في عدد من [الشروط](#conditions):

* `method`
* `header`. يتيح منشئ الـ URI تحديد رأس الـ `HOST` فقط.
* `path`, `action_name`, `action_ext`. قبل تأكيد إنشاء القاعدة، من فضلك تأكد من أن قيم هذه أجزاء الطلب محللة بطريقة واحدة من الطرق التالية:
    * قيمة صريحة لعدد معين من `path` + `action_name` + `action_ext` (اختياري)
    * قيمة صريحة لـ `action_name` + `action_ext` (اختياري)
    * قيمة صريحة لعدد معين من `path` بدون `action_name` وبدون `action_ext`
* `query`

يمكن إكمال القيمة المحددة في منشئ URI بشروط أخرى متاحة فقط في [نموذج التحرير المتقدم](#advanced-edit-form).

#### استخدام الرموز الخاصة

هل يمكنك استخدام الرموز الخاصة عند العمل مع منشئ URI في Wallarm؟ لا ونعم. "لا" يعني أنك لا يمكنك استخدامها [بطريقة كلاسيكية](https://en.wikipedia.org/wiki/Wildcard_character)، "نعم" تعني أنك يمكنك تحقيق نفس النتيجة بالعمل مثل هذا:

* ضمن المكونات المحللة لـ URI، بدلاً من الرموز الخاصة، استخدم التعابير العادية.
* ضع الرمز `*` أو `**` في حقل URI نفسه لاستبدال مكون واحد أو أي عدد من المكونات (انظر الأمثلة في القسم [أعلاه](#working-with-uri-constructor)).

**بعض التفاصيل**

تعتبر صيغة التعبير العادي مختلفة عن الرموز الخاصة الكلاسيكية، ولكن يمكن تحقيق نفس النتائج. على سبيل المثال، أنت تريد الحصول على قناع يتوافق مع:

* `something-1.example.com/user/create.com` و
* `anything.something-2.example.com/user/create.com`

...والتي في الرموز الكلاسيكية الخاصة ستحاول الحصول عليها بكتابة شيء مثل:

* `*.example.com/user/create.com`

ولكن في Wallarm، سيتم تحليل `something-1.example.com/user/create.com` إلى:

![مثال على تحليل URI إلى المكونات](../../images/user-guides/rules/something-parsed.png)

...حيث `something-1.example.com` هو شرط `header`-`HOST`. ذكرنا أن الرموز الخاصة لا يمكن استخدامها ضمن الشرط، لذا بدلاً من ذلك نحتاج إلى استخدام التعبير العادي: حدد نوع الشرط في REGEX ومن ثم استخدم صيغة التعبير العادي الخاصة بـ Wallarm [صيغة محددة](#condition-type-regex):

1. لا تستخدم `*` في معنى "أي عدد من الرموز".
1. ضع كل `.` التي نريدها أن تُفسر على أنها "نقاط فعلية" في أقواس مربعة:

    `something-1[.]example[.]com`

1. استخدم `.` بدون أقواس كبديل لـ "أي رمز" و `*` بعدها كمعدل "0 أو أكثر من التكرارات للسابقة"، لذا `.*` و:
    
    `.*[.]example[.]com`

1. أضف `$` في نهاية التعبير للقول بأن ما أنشأناه يجب أن ينهي المكون الخاص بنا:
    
    `.*[.]example[.]com$`

    !!! info "الطريقة الأبسط"
        يمكنك تجاهل `.*` وترك `[.]example[.]com$` فقط. في كلا الحالتين، ستفترض Wallarm أن أي حرف يمكن أن يظهر قبل `[.]example[.]com$` أي عدد من المرات.

    ![استخدام التعبير العادي في مكون العنوان](../../images/user-guides/rules/wildcard-regex.png)

### النموذج المتقدم للتحرير

النموذج المتقدم للتحرير يوسع إمكانيات [منشئ URI](#uri-constructor) (method و URI) للسماح بتكوين كلاً من هذه الشروط وشروط القاعدة الإضافية، مثل التطبيق، الرؤوس، معلمات سلسلة الاستعلام وغيرها.

#### الشروط

تشير الشروط إلى القيم التي يجب أن تكون موجودة في أي أجزاء من الطلب. يتم تطبيق القاعدة عند استيفاء جميع شروطها. تُدرج الشروط في قسم **If request is** القاعدة.

تدعم الشروط التالية حاليا:

* **التطبيق**: معرف التطبيق.
* **proto**: نسخة بروتوكول HTTP (1.0, 1.1, 2.0, ...).
* **scheme**: http أو https.
* **uri**: جزء من URL الطلب بدون النطاق (على سبيل المثال، `/blogs/123/index.php?q=aaa` للطلب المرسل إلى `http://example.com/blogs/123/index.php?q=aaa`).
* **path**, **action_name**, **action_ext** هي تسلسل مكونات URI الهرمية حيث: 

    * **path**: مصفوفة بأجزاء URI مفصولة بالرمز `/` (الجزء الأخير من URI ليس مدرجا في المصفوفة). إذا كان هناك جزء واحد فقط في الـ URI، ستكون المصفوفة فارغة.
    * **action_name**: الجزء الأخير من الـ URI بعد الرمز `/` وقبل الفترة الأولى (`.`). هذا الجزء من الـ URI موجود دائماً في الطلب، حتى لو كانت قيمته سلسلة فارغة.
    * **action_ext**: جزء الـ URI بعد النقطة الأخيرة (`.`). قد يكون مفقودا في الطلب.
* **query**: معلمات سلسلة الاستعلام.
* **header**: رؤوس الطلب. عند إدخال اسم رأس، يتم عرض القيم الأكثر شيوعًا في قائمة منسدلة. على سبيل المثال: `HOST`, `USER-AGENT`, `COOKIE`, `X-FORWARDED-FOR`, `AUTHORIZATION`, `REFERER`, `CONTENT-TYPE`.

    !!! info "إدارة قواعد الرأس `HOST` لـ FQDNs والعناوين IP"
        إذا تم تعيين رأس الـ `HOST` على FQDN، فلن يتأثر الطلبات المستهدفة لعنوان IP المرتبط بها بالقاعدة. لتطبيق القاعدة على هذه الطلبات، اضبط قيمة رأس الـ `HOST` على الـ IP المحدد في شروط القاعدة، أو أنشئ قاعدة منفصلة لكل من FQDN و IP.

        عند وضعها بعد تحميل الرصد الذي يعدل رأس الـ `HOST`، يطبق العقدة Wallarm القواعد بناءً على القيمة المُحدَّثة، وليس الأصلية. على سبيل المثال، إذا قام التوازن بالتحميل بتحويل الـ `HOST` من IP إلى نطاق، يتبع العقدة القواعد لهذا النطاق.

* **method**: طرق الطلب. إذا لم يتم تحديد القيمة بشكل صريح، ستتم تطبيق القاعدة على الطلبات بأي وسيلة.

#### نوع الشرط: EQUAL (`=`)

يجب أن تتطابق القيمة بدقة مع وسيطة المقارنة. على سبيل المثال، الـ `example` فقط تتطابق مع القيمة `example`.

!!! info "نوع الشرط EQUAL لقيمة رأس الـ HOST"
    لتغطية المزيد من الطلبات مع القواعد، قمنا بتقييد نوع الشرط EQUAL لـ الرأس الـ HOST. بدلاً من نوع EQUAL، نوصي باستخدام النوع IEQUAL الذي يسمح بقيم المعلمات في أي سجل.
    
    إذا كنت قد استخدمت النوع EQUAL من قبل، سيتم استبداله تلقائياً بنوع الـ IEQUAL.

#### نوع الشرط: IEQUAL (`Aa`)

يجب أن تتطابق القيمة مع وسيطة المقارنة في أي حالة. على سبيل المثال: `example`, `ExAmple`, `exampLe` تتطابق مع القيمة `example`.

#### نوع الشرط: REGEX (`.*`)

يجب أن تتطابق القيمة مع التعبير العادي. 

**صيغة التعبير العادي**

لتطابق الطلبات مع التعابير العادية، يتم استخدام مكتبة PIRE. في معظم الأحيان، صيغة التعبيرات هي القياسية ولكن لديها بعض التفاصيل الخاصة كما هو موضح أدناه وفي ملف README من [مستودع PIRE][link-regex].

??? info "إظهار صيغة التعبير العادي"
    الأحرف التي يمكن استخدامها كما هي:

    * الأحرف اللاتينية الصغيرة: `a b c d e f g h i j k l m n o p q r s t u v w x y z`
    * الأحرف اللاتينية الكبيرة: `A B C D E F G H I J K L M N O P Q R S T U V W X Y Z`
    * الأرقام: `0 1 3 4 5 6 7 8 9`
    * الأحرف الخاصة: <code>! " # % ' , - / : ; < = > @ ] _ ` }</code>
    * المساحات البيضاء

    الأحرف التي يجب وضعها في أقواس مربعة `[]` بدلاً من الهروب مع `\`:

    * `. $ ^ { [ ( | ) * + ? \ & ~`

    الأحرف التي يجب تحويلها إلى ASCII وفقا لـ ISO‑8859:

    * أحرف UTF‑8 (على سبيل المثال، الحرف `ʃ` المحول إلى ASCII هو `Ê`)

    مجموعات الحروف:

    * `.` لأي حرف باستثناء سطر جديد
    * `()` لتجميع التعابير العادية، البحث عن الرموز المتواجدة داخل `()` أو تأسيس ترتيب أولوية
    * `[]` لحرف واحد متواجد داخل `[]` (حساسة الأحوال); يمكن استخدام المجموعة للحالات المعينة:
        * لتجاهل الحالة (على سبيل المثال، `[cC]`)
        * `[a-z]` لتطابق واحد من الأحرف اللاتينية الصغيرة
        * `[A-Z]` لتطابق واحد من الأحرف اللاتينية الكبيرة
        * `[0-9]` لتطابق واحد من الأرقام
        * `[a-zA-Z0-9[.]]` لتطابق واحد من الأحرف اللاتينية الصغيرة، أو الأحرف اللاتينية الكبيرة، أو الأرقام، أو النقطة

    الأحرف المنطقية:

    * `~` هو مساوٍ لـ NOT. يجب وضع التعبير المعكوس والحرف في `()`,<br>على سبيل المثال: `(~(a))`
    * `|` هو مساوٍ لـ OR
    * `&` هو مساوٍ لـ AND

    الأحرف لتحديد حدود السلسلة:

    * `^` لبداية السلسلة
    * `$` لنهاية السلسلة

    المعدلات:

    * `*` ل0 أو أكثر من التكرارات للتعبير العادي السابق
    * `+` ل1 أو أكثر من التكرارات للتعبير العادي السابق
    * `?` ل0 أو 1 من التكرارات للتعبير العادي السابق
    * `{m}` لـ `m` التكرارات من التعبير العادي السابق
    * `{m,n}` لـ `m` إلى `n` التكرارات من التعبير العادي السابق; تجاهل `n` يحدد حداً علوياً لا نهائياً

    الأحرف التي تعمل مع التفاصيل:

    * `^.*$` مساوٍ لـ `^.+$` (القيم الفارغة لا تتطابق مع `^.*$`)
    * `^.?$`, `^.{0,}$`, `^.{0,n}$` مساوٍ لـ `^.+$`

    تدعم مؤقتا:

    * الأصناف مثل `\W` لما لا يكون ألفبيا، `\w` لما هو ألفبي، `\D` لأي أرقام غير-عشرية، `\d` لأي عشريات، `\S` لما لا يكون مساحات بيضاء، `\s` لما يكون مساحات بيضاء

    لا تدعم صيغة:

    * تعليمات أكتالية ثلاثية الأرقام `\NNN`, `\oNNN`, `\ONNN`
    * `\cN` تمرير الأحرف التحكم عبر `\c` (على سبيل المثال، `\cC` لـ CTRL+C)
    * `\A` لبداية السلسلة
    * `\z` لنهاية السلسلة
    * `\b` قبل أو بعد أحرف السلسلة عند نهايته
    * `??`, `*?`, `+?` المعدلات الكسولة
    * الظروف

**اختبار التعابير العادية**

لاختبار التعبير العادي، يمكنك استخدام أداة **cpire** المساعدة على Debian أو Ubuntu المدعومة:

1. أضف مستودع Wallarm:

    === "Debian 10.x (buster)"
        ```bash
        sudo apt update
        sudo apt -y install dirmngr
        curl -fsSL https://repo.wallarm.com/wallarm.gpg | sudo apt-key add -
        sh -c "echo 'deb https://repo.wallarm.com/debian/wallarm-node buster/4.8/' | sudo tee /etc/apt/sources.list.d/wallarm.list"
        sudo apt update
        ```
    === "Debian 11.x (bullseye)"
        ```bash
        sudo apt update
        sudo apt -y install dirmngr
        curl -fSsL https://repo.wallarm.com/wallarm.gpg | sudo gpg --no-default-keyring --keyring gnupg-ring:/etc/apt/trusted.gpg.d/wallarm.gpg --import
        sudo chmod 644 /etc/apt/trusted.gpg.d/wallarm.gpg
        sh -c "echo 'deb https://repo.wallarm.com/debian/wallarm-node bullseye/4.8/' | sudo tee /etc/apt/sources.list.d/wallarm.list"
        sudo apt update
        ```
    === "Ubuntu 18.04 LTS (bionic)"
        ```bash
        sudo apt update
        curl -fsSL https://repo.wallarm.com/wallarm.gpg | sudo apt-key add -
        sh -c "echo 'deb https://repo.wallarm.com/ubuntu/wallarm-node bionic/4.8/' | sudo tee /etc/apt/sources.list.d/wallarm.list"
        sudo apt update
        ```
    === "Ubuntu 20.04 LTS (focal)"
        ```bash
        sudo apt update
        curl -fsSL https://repo.wallarm.com/wallarm.gpg | sudo apt-key add -
        sh -c "echo 'deb https://repo.wallarm.com/ubuntu/wallarm-node focal/4.8/' | sudo tee /etc/apt/sources.list.d/wallarm.list"
        sudo apt update
        ```
    === "Ubuntu 22.04 LTS (jammy)"
        ```bash
        sudo apt update
        curl -fsSL https://repo.wallarm.com/wallarm.gpg | sudo apt-key add -
        sh -c "echo 'deb https://repo.wallarm.com/ubuntu/wallarm-node jammy/4.8/' | sudo tee /etc/apt/sources.list.d/wallarm.list"
        sudo apt update
        ```
2. تثبيت أداة **cpire** المساعدة:

    ```bash
    sudo apt -y install libcpire-utils
    ```
3. تشغيل أداة **cpire** المساعدة:
    ```bash
    cpire-runner -r '<YOUR_REGULAR_EXPRESSION>'
    ```
4. أدخل القيمة للتحقق مما إذا كانت تتطابق مع التعبير العادي. ستقوم الأداة بإرجاع النتيجة:
    * `0` إذا كانت القيمة تتطابق مع التعبير العادي
    * `FAIL` إذا كانت القيمة لا تتطابق مع التعبير العادي
    * رسالة خطأ إذا كان التعبير العادي غير صالح

    !!! warning "تفاصيل التعامل مع الرمز  `\`"
        إذا كان التعبير يشمل `\`، يرجى الهرب منه بـ `[]` و `\` (على سبيل المثال، `[\\]`).

**أمثلة على التعابير العادية المضافة عبر واجهة Wallarm Console**

* لتطابق أي سلسلة تشمل <code>/.git</code>

    ```
    /[.]git
    ```
* لتطابق أي سلسلة تشمل <code>.example.com</code>

    ```
    [.]example[.]com
    ```
* لتطابق أي سلسلة تنتهي بـ <code>/.example.*.com</code> حيث `*` يمكن أن تكون أي رمز يتكرر أي عدد من المرات

    ```
    /[.]example[.].*[.]com$
    ```
* لتطابق جميع العناوين IP باستثناء 1.2.3.4 و 5.6.7.8

    ```
    ^(~((1[.]2[.]3[.]4)|(5[.]6[.]7[.]8)))$
    ```
* لتطابق أي سلسلة تنتهي بـ <code>/.example.com.php</code>

    ```
    /[.]example[.]com[.]php$
    ```
* لتطابق أي سلسلة تشمل <code>sqlmap</code>بـ الأحرف الصغيرة والكبيرة: <code>sqLmAp</code>, <code>SqLMap</code>, إلخ

    ```
    [sS][qQ][lL][mM][aA][pP]
    ```
* لتطابق أي سلسلة تشمل قيمة واحدة أو عدة قيم: <code>admin\\.exe</code>, <code>admin\\.bat</code>, <code>admin\\.sh</code>, <code>cmd\\.exe</code>, <code>cmd\\.bat</code>, <code>cmd\\.sh</code>

    ```
    (admin|cmd)[\\].(exe|bat|sh)
    ```
* لتطابق أي سلسلة تشمل قيمة واحدة أو عدة قيم: <code>onmouse</code> مع أحرف صغيرة وكبيرة, <code>onload</code> مع أحرف صغيرة وكبيرة, <code>win\\.ini</code>, <code>prompt</code>

    ```
    [oO][nN][mM][oO][uU][sS][eE]|[oO][nN][lL][oO][aA][dD]|win[\\].ini|prompt
    ```
* لتطابق أي سلسلة تبدأ بـ `Mozilla` ولكن لا تحتوي على السلسلة `1aa875F49III`
    
    ```
    ^(Mozilla(~(.*1aa875F49III.*)))$
    ```
* لتطابق أي سلسلة بـ واحدة من القيم: `python-requests/`, `PostmanRuntime/`, `okhttp/3.14.0`, `node-fetch/1.0`

    ```
    ^(python-requests/|PostmanRuntime/|okhttp/3.14.0|node-fetch/1.0)
    ```

## دورة حياة المجموعة القاعدية

تُشكل جميع القواعد المنشأة مجموعة قاعدية مخصصة. يعتمد العقدة Wallarm على المجموعة القاعدية المخصصة أثناء تحليل الطلبات الواردة.

لا تسري تغييرات المجموعة القاعدية المخصصة على الفور. يتم تطبيق التغييرات على عملية تحليل الطلب فقط بعد اكتمال **بناء** المجموعة القاعدية المخصصة و **تحميلها إلى العقدة الفاصلة**.

### بناء المجموعة القاعدية المخصصة

إضافة قاعدة جديدة، أو حذف أو تغيير القواعد الحالية في Wallarm Console → **القواعد** تطلق بناء المجموعة القاعدية المخصصة. خلال عملية البناء، تتم تحسين القواعد وتجميعها في تنسيق معتمد للعقدة الفاصلة. يستغرق عملية بناء المجموعة القاعدية المخصصة عادة من بضع ثوان لعدد صغير من القواعد إلى ما يصل إلى ساعة للأشجار القاعدية المعقدة.

يتم عرض حالة بناء المجموعة القاعدية المخصصة والوقت المتوقع لاكتمالها في واجهة Wallarm Console. إذا لم يكن هناك بناء جاري، فإن الواجهة تعرض تاريخ البناء الأخير المكتمل.

![حالة البناء](../../images/user-guides/rules/build-rules-status.png)

### التحميل إلى العقدة الفاصلة

يتم تحميل بناء المجموعة القاعدية المخصصة إلى العقدة الفاصلة أثناء تزامن العقدة الفاصلة وسحابة Wallarm. بشكل افتراضي، يتم إطلاق تزامن العقدة الفاصلة وسحابة Wallarm كل 2-4 دقائق. [المزيد من التفاصيل حول تكوين تزامن العقدة الفاصلة وسحابة Wallarm →](../../admin-en/configure-cloud-node-synchronization-en.md)

تتم تسجيل حالة تحميل المجموعة القاعدية المخصصة إلى العقدة الفاصلة في ملف `/var/log/wallarm/syncnode.log` أو `/opt/wallarm/var/log/wallarm/syncnode-out.log` [اعتماداً على طريقة تثبيت العقدة](../../admin-en/configure-logging.md).

تتلقى جميع عقد Wallarm المتصلة بحساب Wallarm نفسه مجموعة متماثلة من القواعد الافتراضية والمخصصة لترشيح حركة المرور. لا يزال بإمكانك تطبيق قواعد مختلفة لتطبيقات مختلفة باستخدام معرفات التطبيقات المناسبة أو معلمات طلب HTTP فريدة مثل الرؤوس، معلمات سلسلة الاستعلام، إلخ.

### النسخ الاحتياطي والاستعادة

لحماية نفسك من القواعد التي تم تكوينها بطريق الخطأ أو حذفها، يمكنك الاحتفاظ بنسخة احتياطية من مجموعة القواعد المخصصة الحالية لديك.

هناك الخيارات التالية لنسخ القاعدة الاحتياطي:

* إنشاء نسخة احتياطية تلقائية بعد كل [بناء مجموعة قاعدية مخصصة](#custom-ruleset-building). عدد النسخ الاحتياطية التلقائية محدود إلى 7: لكل يوم عندما تغير القواعد عدة مرات، يتم الاحتفاظ فقط بالنسخة الاحتياطية الأخيرة.
* إنشاء نسخة احتياطية يدوية في أي وقت. عدد النسخ الاحتياطية اليدوي يقتصر على 5 بشكل افتراضي. إذا كنت بحاجة إلى المزيد، اتصل بفريق [دعم فني من Wallarm](mailto:support@wallarm.com).

يمكنك:

* الوصول إلى النسخ الاحتياطية الحالية: في قسم **القواعد**، انقر على **النسخ الاحتياطية**.
* إنشاء نسخة احتياطية جديدة يدويا: في نافذة **النسخ الاحتياطية**، انقر فوق **إنشاء نسخة احتياطية**.
* تعيين اسم ووصف للنسخة الاحتياطية اليدوية وتحريرها في أي لحظة.

    !!! info "تسمية النسخ الاحتياطية التلقائية"
        يتم تسمية النسخ الاحتياطية التلقائية بواسطة النظام ولا يمكن تسميتها.

* التحميل من النسخة الاحتياطية الموجودة: انقر على **تحميل** للنسخة الاحتياطية المطلوبة. عند التحميل من النسخة الاحتياطية، يتم حذف تكوين القاعدة الحالي واستبداله بالتكوين من النسخة الاحتياطية.
* حذف النسخة الاحتياطية.

    ![القواعد - إنشاء نسخة احتياطية](../../images/user-guides/rules/rules-create-backup.png)

!!! warning "قيود تعديل القاعدة"
    لا يمكنك إنشاء أو تعديل القواعد حتى تكتمل عملية إنشاء النسخة الاحتياطية أو تحميلها من النسخة الاحتياطية.

## مكالمات API للحصول على القواعد

للحصول على القواعد المخصصة، يمكنك [الاتصال بـ API Wallarm مباشرة](../../api/request-examples.md#get-all-configured-rules).
