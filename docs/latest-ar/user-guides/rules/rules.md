[link-regex]:                   https://github.com/yandex/pire
[link-request-processing]:      request-processing.md
[img-add-rule]:                 ../../images/user-guides/rules/add-rule.png

# القواعد

في والرم، تُستخدم القواعد لضبط سلوك النظام أثناء تحليل الطلبات ومعالجتها المتابعة في وحدة ما بعد التحليل وكذلك في الوالرم كلاود. يمكنك التفتيش على القواعد الحالية وتكوين الجديدة في قسم **القواعد** من والرم كونسول.

لفهم أفضل لكيفية تطبيق قواعد معالجة حركة المرور، من الجيد معرفة كيف يقوم العقدة الفلتر بـ [تحليل الطلبات][link-request-processing].

الشيء الأكثر أهمية حول عمل التغييرات على القواعد هو أن هذه التغييرات لا تدخل حيز التنفيذ على الفور. قد يستغرق بعض الوقت لـ [تجميع القواعد](#ruleset-lifecycle) وتحميلها في عقد الفلتر.

## ما يمكنك فعله بواسطة القواعد

باستخدام القواعد، يمكنك تقديم العديد من تدابير الحماية لتطبيقاتك وواجهات برمجة التطبيقات الخاصة بك، وأيضًا ضبط كيفية الكشف عن الهجمات، كيف يعمل العقد الوالرم وبعض مكونات الوالرم:

* [تعيين الحد الأقصى للمعدل](../../user-guides/rules/rate-limiting.md)
* [تطبيق التصحيح الافتراضي](../../user-guides/rules/vpatch-rule.md)
* [إنشاء قاعدة الكشف الخاصة بك](../../user-guides/rules/regex-rule.md)
* [قناعة البيانات الحساسة](../../user-guides/rules/sensitive-data-rule.md)
* معايرة وظائف العقد بواسطة [تحديد زمن معالجة الطلبات](../../user-guides/rules/configure-overlimit-res-detection.md)
* ضبط معالجة الطلبات بواسطة [إدارة معالجات الطلبات](../../user-guides/rules/request-processing.md#managing-parsers) و[تغيير رؤوس الرد من الخادم](../../user-guides/rules/add-replace-response-header.md)
* ضبط الكشف عن الهجمات عن طريق الحصول على [تجاهل أنواع الهجمات المعينة](../../about-wallarm/protecting-against-attacks.md#ignoring-certain-attack-types) والحصول على [تجاهل بعض الدلائل الهجومية في البيانات الثنائية](../../about-wallarm/protecting-against-attacks.md#ignoring-certain-attack-signs-in-the-binary-data)

## المصطلحات

**النقطة**

النقطة هي معلمة لطلب HTTP. يمكن وصف المعلمة بتسلسل الفلاتر المطبقة لمعالجة الطلب، على سبيل المثال، رؤوس، الجسم، URL، الBase64، وما إلى ذلك. يُطلق على هذا التسلسل اسم *النقطة*.

تسمى فلاتر معالجة الطلبات أيضًا بالمحللات.

**فرع القاعدة**

يُطلق على مجموعة معلمات طلب HTTP وظروفهم اسم *الفرع*. إذا تم تحقيق الشروط، ستُطبق القواعد المتعلقة بهذا الفرع.

على سبيل المثال، فرع القاعدة `example.com/**/*.*` يصف الظروف التي تطابق جميع الطلبات لأي URL للنطاق `example.com`.

**النقطة النهائية (فرع النقطة النهائية)**

الفرع الذي لا يحتوي على فروع قاعدة متداخلة يُطلق عليه اسم *فرع نقطة نهائية*. idealّيًا، تتوافق نقطة النهاية للتطبيق مع وظيفة أعمال واحدة للتطبيق المحمي. على سبيل المثال، يمكن أن تكون وظيفة الأعمال مثل التفويض عبارة عن فرع قاعدة نقطة النهاية لـ `example.com/login.php`.

**القاعدة**

إعداد معالجة الطلبات للعقدة الفلتر، وحدة ما بعد التحليل، السحابة يُطلق عليه اسم *قاعدة*.

تتم ربط قواعد المعالجة بالفروع أو النقاط النهائية. يتم تطبيق القاعدة على الطلب فقط إذا كان الطلب يطابق جميع الظروف الموصوفة في الفرع.

## التفتيش

لعرض القواعد، انتقل إلى قسم **القواعد** من والرم كونسول. يمثل هذا القسم الفروع والنقاط النهائية المعروفة بالفعل.

![نظرة عامة على تبويب القواعد](../../images/user-guides/rules/rules-overview.png)

يقوم النظام تلقائياً بتجميع القواعد حسب الفروع، مما يبرز الشروط المشتركة ويبني بنية شجرية. كنتيجة، قد يكون للفرع فروع فرعية. لإظهار أو إخفاء الفروع المتداخلة، انقر على الدائرة الزرقاء إلى اليسار من وصف الفرع.

العلامتان النجميتان `**` في وصف الفرع تشير إلى أي عدد من المسارات المتداخلة. على سبيل المثال، سيحتوي الفرع `/**/*.php` على كلا من `/index.php` و `/app/admin/install.php`.

يشير حجم الدائرة الزرقاء إلى الكمية النسبية للفروع المتداخلة. يشير لونها إلى الكمية النسبية للقواعد داخل الفرع وفروعه الفرعية. على كل مستوى من مستويات التداخل، يكون حجم ولون الدوائر مستقلين عن بعضها البعض.

قد يعرض النظام إلى اليمين من وصف الفرع رقم برتقالي، يشير إلى عدد القواعد في ذلك الفرع (فقط الأحفاد المباشرين، وليس القواعد المتداخلة). إذا لم يتم عرض أي رقم، فإن الفرع هو "افتراضي" – يُستخدم فقط لتجميع الفروع الفرعية المشابهة.

يتم إخفاء الفروع التي لا تتوفر فيها أي قواعد للمستخدم (وفقًا لنموذج الامتياز) تلقائيا.

### عرض القاعدة

في كل فرع، يمكن للمستخدم النظر في قائمة القواعد المرتبطة به. للتبديل إلى الصفحة مع قائمة القواعد، انقر على وصف الفرع المقابل.

![عرض قواعد الفرع](../../images/user-guides/rules/view-rules.png)

تتم تجميع القواعد داخل الفرع حسب الحقل *النقطة*. القواعد التي تؤثر على الطلب كله، بدلاً من المعالم الفردية، تتم تجميعها في سطر واحد. لرؤية القائمة الكاملة، انقر على الخط.

بالنسبة لكل قاعدة، يعرض النظام العوامل التالية: الوقت الأخير للتعديل، الكمية، الأنواع، والنقطة.

### القواعد الافتراضية

يمكنك إنشاء القواعد مع الإجراء المحدد ولكن بدون ربطها بأي نقطة نهائية - يطلق عليها **قواعد افتراضية**. يتم تطبيق هذه القواعد على جميع النقاط النهائية.

* لإنشاء قاعدة افتراضية، اتبع الـ [إجراء القياسي](rules.md) ولكن اترك الURI فارغًا. سيتم إنشاء القاعدة الجديدة غير المرتبطة بأي نقطة نهائية.
* لعرض قائمة القواعد الافتراضية المنشأة، انقر على الزر **القواعد الافتراضية**.

!!! info "قاعدة الوضع الافتراضي لتصفية حركة المرور"
    يقوم الوالرم تلقائياً بـ [إنشاء](../../admin-en/configure-wallarm-mode.md#setting-up-endpoint-targeted-filtration-rules-in-wallarm-console) القاعدة الافتراضية "تعيين وضع التصفية" لجميع العملاء وتحديد قيمتها على أساس إعداد [وضع التصفية العام](../../admin-en/configure-wallarm-mode.md#setting-up-the-general-filtration-rule-in-wallarm-console).

تتم [الإرث](#distinct-and-inherited-rules) من قبل جميع الفروع الافتراضية.

### القواعد المتميزة والموروثة

تتم إرث القواعد عبر فرع القواعد. المبادئ التوجيهية:

* ترث جميع الفروع القواعد [الافتراضية](#default-rules).
* في الفرع، ترث نقاط النهاية الطفلة القواعد من الأصل.
* المتميز له الأولوية على الموروث.
* المحدد مباشرة له الأولوية على [التعبيرات العادية](rules.md#condition-type-regex).
* الحالة [الحساسة](rules.md#condition-type-equal) لها الأولوية على [الغير حساسة](rules.md#condition-type-iequal-aa).

إليك بعض التفاصيل حول كيفية العمل مع فرع القواعد:

* لتوسيع النقطة النهائية، انقر على الدائرة الزرقاء.
* النقاط النهائية التي لا تمتلك قواعد متميزة مُحايَدة وغير قابلة للنقر.

    ![فرع من النقاط النهائية](../../images/user-guides/rules/rules-branch.png)

* لعرض القواعد للنقطة النهائية، انقر عليها. أولاً، سيتم عرض القواعد المتميزة لهذه النقطة النهائية.
* عند عرض قائمة القواعد للنقطة النهائية المحددة، انقر على **القواعد المتميزة والموروثة** لعرض تلك الموروثة. سوف يتم عرض القواعد الموروثة مع المتميزة؛ سيتم تحضيرها بمقارنة المتميزة.

    ![القواعد المتميزة والموروثة للنقطة النهائية](../../images/user-guides/rules/rules-distinct-and-inherited.png)

### استدعاءات API للحصول على القواعد

للحصول على القواعد المخصصة، يمكنك [الاستدعاء مباشرة لواجهة برمجة تطبيقات الوالرم](../../api/overview.md) بجانب استخدام واجهة المستخدم الرسومية لوالرم كونسول. فيما يلي بعض أمثلة على الاستدعاءات المتناسبة لواجهة برمجة التطبيقات.

**الحصول على جميع القواعد المكونة**

--8<-- "../include/api-request-examples/get-all-configured-rules.md"

**الحصول فقط على شروط جميع القواعد**

--8<-- "../include/api-request-examples/get-conditions.md"

**الحصول على القواعد المرتبطة بشرط محدد**

للإشارة إلى شرط محدد، استخدم هويته - يمكنك الحصول عليه عند طلب شروط جميع القواعد (انظر أعلاه).

--8<-- "../include/api-request-examples/get-rules-by-condition-id.md"

## التكوين

لإضافة قاعدة جديدة، اذهب إلى علامة التبويب **القواعد**.

يمكن إضافة القواعد إلى الفروع الموجودة والجديدة. يمكن إنشاؤها من الألف إلى الياء أو استنادًا إلى واحدة من الفروع الموجودة.

لإضافة قاعدة إلى الفرع الموجود، انقر على *إضافة قاعدة* (بعد تحريك المؤشر الماوس فوق خط وصف الفرع، سيظهر الزر في القائمة المنبثقة على اليمين). يمكنك أيضا تنفيذ هذه العملية على صفحة القاعدة لهذا الفرع.

إذا لزم الأمر، فإنه من الممكن تعديل الفرع الذي سيتم إضافة قاعدة إليه. لهذا، انقر على الشرط *في حالة الطلب* في نموذج إضافة القاعدة وأجرِ التغييرات على ظروف وصف الفرع. إذا تم إنشاء فرع جديد، فسوف يظهر على الشاشة، وسيتم تحديث عرض هيكل التطبيق.

![إضافة قاعدة جديدة][img-add-rule]

### وصف الفرع

يتكون وصف الفرع من مجموعة من الظروف لمعايير مختلفة يجب أن يفي بها طلب HTTP؛ خلاف ذلك، لن تُطبق القواعد المرتبطة بهذا الفرع. يشير كل خط في القسم *إذا كان الطلب هو* من نموذج إضافة القاعدة إلى شرط منفصل يتألف من ثلاثة حقول: النقطة، النوع، ووسيطة المقارنة. يتم تطبيق القواعد الموصوفة في الفرع فقط على الطلب إذا تم تحقيق كل الظروف.

لتكوين مجموعة الظروف، يمكن استخدام **منشئ الURI** و **نموذج التعديل المتقدم** على حد سواء.

### منشئ الURI

#### العمل مع منشئ الURI

يتيح منشئ URI تكوين ظروف القاعدة عن طريق تحديد طريقة الطلب والنقطة النهائية في سلسلة واحدة فقط:

* لطريقة الطلب، يوفر منشئ الURI الاختيار الخاص. إذا لم يتم تحديد الطريقة، سيتم تطبيق القاعدة على الطلبات بأي طريقة.
* لقاعدة الطلب، يوفر منشئ URI الحقل الخاص الذي يقبل التنسيقات القيمة التالية:

    | التنسيق | الأمثلة وقيم نقطة الطلب |
    | ------ | ------ |
    | Full URI يشمل التالي:<ul><li> الإطار (يتم تجاهل القيمة، يمكنك تحديد الإطار بشكل صريح عن طريق استخدام النموذج المتقدم)</li><li> النطاق أو عنوان IP</li><li> المنفذ</li><li> المسار</li><li> معلمات سلسلة الاستعلام</ul> | `https://example.com:3000/api/user.php?q=action&w=delete`<br><ul><li>`[header, 'HOST']` - `example.com:3000`</li><li>`[path, 0]` - `api`</li><li>`[path, 1]` - `∅`</li><li>`[action_name]` - `user`</li><li>`[action_ext]` - `php`</li><li>`[query, 'q']` - `action`</li><li>`[query, 'w']` - `delete`</li></ul>|
    | URI مع بعض المكونات المتروكة | `example.com/api/user`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[path, 0]` - `api`</li><li>`[path, 1]` - `∅`</li><li>`[action_name]` - `user`</li><li>`[action_ext]` - `∅`</li></ul><br>`http://example.com/api/clients/user/?q=action&w=delete`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[path, 0]` - `api`</li><li>`[path, 1]` - `clients`</li><li>`[path, 2]` - `∅`</li><li>`[action_name]` - `user`</li><li>`[query, 'q']` - `action`</li><li>`[query, 'w']` - `delete`</li></ul><br>`/api/user`<br><ul><li>``[header, 'HOST']` - any value</li><li>`[path, 0]` - `api`</li><li>`[path, 1]` - `∅`</li><li>`[action_name]` - `user`</li><li>`[action_ext]` - `∅`</li></ul>|
    | URI مع `*` يعني أي قيمة غير فارغة للمكون | `example.com/*/create/*.*`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[path, 0]` - any non‑empty value (hidden in the advanced edit form)</li><li>`[path, 1]` - `create`</li><li>`[path, 2]` - `∅`</li><li>`[action_name]` - any non‑empty value (hidden in the advanced edit form)</li><li>`[action_ext]` - any non‑empty value (hidden in the advanced edit form)</li>القيمة تطابق `example.com/api/create/user.php`<br>و لا تطابق `example.com/create/user.php` و `example.com/api/create`.</ul>|
    | URI مع `**` يعني أي عدد من المكونات بما في ذلك غيابها | `example.com/**/user`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[action_name]` - `user`</li><li>`[action_ext]` - `∅`</li>القيمة تطابق `example.com/api/create/user` و `example.com/api/user`.<br>ولا تطابق القيمة `example.com/user`, `example.com/api/user/index.php` و `example.com/api/user/?w=delete`.</ul><br>`example.com/api/**/*.*`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[path, 0]` - `api`</li><li>`[action_name]` - any non‑empty value (hidden in the advanced edit form)</li><li>`[action_ext]` - any non‑empty value (hidden in the advanced edit form)</li> القيمة تطابق `example.com/api/create/user.php` و `example.com/api/user/create/index.php`<br>و لا تطابق `example.com/api`, `example.com/api/user` and `example.com/api/create/user.php?w=delete`.</ul> |
    | URI مع الـ[التعبير العادي](#condition-type-regex) لمطابقة قيم المكونات المعينة (يجب أن يُلف التعبير العادي في `{{}}`) | `example.com/user/{{[0-9]}}`<br><ul><li>`[header, 'HOST']` - `example.com`</li><li>`[path, 0]` - `user`</li><li>`[path, 1]` - `∅`</li><li>`[action_name]` - `[0-9]`</li><li>`[action_ext]` - `∅`</li>القيمة تطابق `example.com/user/3445`<br>و لا تتطابق `example.com/user/3445/888` و `example.com/user/3445/index.php`.</ul> |

تتم تحليل السلسلة المحددة في المكون URI تلقائيًا إلى مجموعة الشروط لنقاط الطلب التالية:

* `method`
* `header`. يسمح المكون URI بتحديد الرأس `HOST` فقط.
* `path`, `action_name`, `action_ext`. قبل تأكيد إنشاء القاعدة، يرجى التأكد من أن قيم هذه النقاط الطلب مشفرة بأحد الطرق التالية:
    * قيمة صريحة من عدد `path` معين + `action_name` + `action_ext` (اختياري)
    * قيمة صريحة من `action_name` + `action_ext` (اختياري)
    * قيمة صريحة من عدد `path` معين بدون `action_name` وبدون `action_ext`
* `query`

يمكن إكمال القيمة المحددة في المكون URI بواسطة نقاط الطلب الأخرى المتاحة فقط في [نموذج التعديل المتقدم](#advanced-edit-form).

#### استخدام الأحرف الخاصة

بالنسبة لوالرم، هل يمكنك استخدام الأحرف الخاصة عند العمل مع منشئ الURI؟ الجواب هو لا ونعم. "لا" يعني أنك لا يمكنك استخدامها [بالطريقة الكلاسيكية](https://en.wikipedia.org/wiki/Wildcard_character)، "نعم" يعني أنه باستطاعتك تحقيق نفس النتيجة بالعمل مثل الشارحة التالية:

* داخل موكوننات URI الخاصة بك، بدلاً من استخدام الأحرف الخاصة، استخدم التعبيرات العادية.
* ضع رمز `*` أو `**` في حقل URI نفسه لاستبدال مكون واحد أو أي عدد من المكونات (انظر الأمثلة في القسم [أعلاه](#working-with-uri-constructor)).

**بعض التفاصيل**

لغة تعبيرات الريجكس تختلف عن الأحرف الخاصة الكلاسيكية، لكن النتائج نفسها يمكن تحقيقها. على سبيل المثال، قد ترغب في الحصول على قناع يقابل:

* `something-1.example.com/user/create.com` و
* `anything.something-2.example.com/user/create.com`

...الذي في الأحرف الخاصة الكلاسيكية سوف تحاول الحصول عليه عن طريق كتابة شيء مثل:

* `*.example.com/user/create.com`

ولكن في والرم فإن `something-1.example.com/user/create.com` الخاصة بك ستتم تحليلها إلى:

![مثال على تحليل URI إلى المكونات](../../images/user-guides/rules/something-parsed.png)

...حيث أن `something-1.example.com` هو نقطة الرأس-المضيف. أشرنا إلى أن الأحرف الخاصة لا يمكن استخدامها داخل النقاط، لذلك نحتاج بدلاً من ذلك لاستخدام التعبيرات العادية: قم بتعيين نوع الشرط إلى REGEX ومن ثم استخدم الريجكس الخاص بـ والرم [بصيغته الخاصة](#condition-type-regex):

1. لا تستخدم `*` في معنى "أي عدد من الرموز".
1. ضع كل `.` التي نريد أن يتم تفسيرها على أنها "نقاط حقيقية" في أقواس مربعة:

    `something-1[.]example[.]com`

1. استخدم `.` بدون أقواس كبديل لـ "أي رمز" و `*` بعد ذلك كمحدد "0 أو أكثر من التكرارات السابقة"، وبالتالي `.*` و:
    
    `.*[.]example[.]com`

1. إضافة `$` في نهاية التعبير العادي للقول أن ما أنشأناه يجب أن ينتهي مكوننا:
    
    `.*[.]example[.]com$`

    !!! info "الطريقة الأبسط"
        يمكنك تجاهل `.*` وترك `[.]example[.]com$` فقط. في كلتا الحالتين، سيفترض الوالرم أن أي حرف يمكن أن يظهر قبل `[.]example[.]com$` عددًا من المرات.

![استخدام التعبير العادي في مكون الرأس](../../images/user-guides/rules/wildcard-regex.png)

### نموذج التعديل المتقدم

#### النقاط

حقل *النقطة* يشير إلى أي قيمة معلمة يجب استخراجها من الطلب للمقارنة. في الوقت الحالي، لا يتم دعم جميع النقاط التي يمكن تحليلها بواسطة العقد الفلتر.

تدعم النقاط التالية حاليًا:

* **التطبيق**: معرف التطبيق.
* **بروتو**، إصدار بروتوكول HTTP (1.0، 1.1، 2.0، ...).
* **الإطار**: http أو https.
* **uri**: جزء من URL الطلب دون النطاق (على سبيل المثال، `/blogs/123/index.php?q=aaa` للطلب المرسل إلى `http://example.com/blogs/123/index.php?q=aaa`).
* **المسار**، **إسم الإجراء**، **ملحق الإجراء** هو تسلسل مكون URI التسلسلي حيث: 

    * **المسار**: مصفوفة بأجزاء URI مفصولة برمز `/` (لن يتم تضمين الجزء الأخير من URI في المصفوفة). إذا كان هناك جزء واحد فقط في URI، ستكون المصفوفة فارغة.
    * **إسم الإجراء**: الجزء الأخير من URI بعد الرمز `/` وقبل النقطة الأولى (`.`). هذا الجزء من URI موجود دائمًا في الطلب، حتى ولو كانت قيمته سلسلة فارغة.
    * **ملحق الإجراء**: الجزء من URI بعد النقطة الأخيرة (`.`). قد يكون مفقودًا في الطلب
* **الاستعلام**: معلمات سلسلة الاستعلام.
* **الرأس**: رؤوس الطلب. عند إدخال اسم الرأس، يتم عرض القيم الأكثر شيوعًا في قائمة منسدلة. على سبيل المثال: `HOST`, `USER-AGENT`, `COOKIE`, `X-FORWARDED-FOR`, `AUTHORIZATION`, `REFERER`, `CONTENT-TYPE`.

    !!! info "إدارة قواعد رأس `HOST` لـFQDNs وعناوين IP"
        إذا تم تعيين رأس `HOST` على FQDN، لن يتأثر الطلبات المستهدفة عنوان IP المعتبر بشكل تلقائي بالقاعدة. لتطبيق القاعدة على هذه الطلبات، قم بتعيين قيمة رأس `HOST` على IP معين في ظروف القاعدة، أو أنشئ قاعدة منفصلة لكلاً من الـFQDN وIP الخاص به.

        عند وضعها بعد التوازن الحمولة التي تعديل رأس `HOST`، تتبع العقدة الوالرم قواعد استنادًا الى القيمة المحدثة، ليس الأصلية. على سبيل المثال، إذا قام التوازن الحمولة بتبديل `HOST` من IP إلى دومين، ستتبع العقدة قواعد دومين ذلك.
* **الطريقة**: الطرق الطلب. إذا لم يتم تحديد القيمة بصراحة، سيتم تطبيق القاعدة على الطلبات مع أي طريقة.

#### نوع الشرط: EQUAL (`=`)

يجب أن تتطابق قيمة النقطة بدقة مع وسيطة المقارنة. على سبيل المثال، فإن `example` فقط يطابق قيمة نقطة `example`.

!!! info "نوع الشرط EQUAL لقيمة رأس المضيف"
    لتغطية الطلبات أكثر بالقواعد، قمنا بتقييد نوع الشرط EQUAL لرأس المضيف. بدلاً من نوع EQUAL، نوصي باستخدام النوع IEQUAL الذي يسمح باستيعاب قيم المعالم في أي حالة.
    
    إذا كنت قد استخدمت النوع EQUAL في السابق، سيتم استبداله تلقائياً بنوع IEQUAL.

#### نوع الشرط: IEQUAL (`Aa`)

يجب أن تتطابق قيمة النقطة مع وسيطة المقارنة في أي حالة. على سبيل المثال: `example`, `ExAmple`, `exampLe` تتطابق مع قيمة نقطة `example`.

#### نوع الشرط: REGEX (`.*`)

يجب أن تتطابق قيمة النقطة على التعبير العادي.

**صيغة التعبير العادي**

لمطابقة الطلبات مع التعبير العادي، يُستخدم مكتبة PIRE. في الغالب، صيغة التعبير العادي هي قياسية ولكن لديها بعض التحديدات كما هو موضح أدناه وفي ملف README لـ [مستودع PIRE][link-regex].

??? info "عرض صيغة التعبير العادي"
    الأحرف التي يمكن استخدامها كما هي:

    * الحروف اللاتينية الصغيرة: `a b c d e f g h i j k l m n o p q r s t u v w x y z`
    * الحروف اللاتينية الكبيرة: `A B C D E F G H I J K L M N O P Q R S T U V W X Y Z`
    * أرقام: `0 1 3 4 5 6 7 8 9`
    * أحرف خاصة: <code>! " # % ' , - / : ; < = > @ ] _ ` }</code>
    * المسافات البيضاء

    الأحرف التي يجب وضعها في الأقواس المربعة `[]` بدلاً من الهروب بـ `\`:

    * `. $ ^ { [ ( | ) * + ? \ & ~`

    الأحرف التي يجب تحويلها إلى ASCII وفقًا لISO-8859:

    * أحرف UTF-8 (على سبيل المثال، الرمز `ʃ` محول إلى ASCII هو `Ê`)

    مجموعات الأحرف:

    * `.` لأي حرف باستثناء سطر جديد
    * `()` لتجميع التعبيرات العادية، البحث عن الرموز الموجودة داخل `()` أو تأسيس ترتيب الأولوية
    * `[]` لحرف واحد موجود داخل `[]` (حساسة لحالة الأحرف); يمكن استخدام المجموعة للحالات الخاصة:
        * لتجاهل الحالة (على سبيل المثال، `[cC]`)
        * `[a-z]` لمطابقة واحد من الحروف اللاتينية الصغيرة
        * `[A-Z]` لمطابقة واحد من الحروف اللاتينية الكبيرة
        * `[0-9]` لمطابقة واحد من الأرقام
        * `[a-zA-Z0-9[.]]` لمطابقة واحد من الأحرف الصغيرة، أو الكبيرة اللاتينية، أو الأرقام، أو النقطة

    الأحرف المنطقية:

    * `~` معادلة لـ NOT. يجب وضع التعبير المعكوس والرمز داخل `()`,<br>على سبيل المثال: `(~(a))`
    * `|` معادلة لـ OR
    * `&` معادلة لـ AND

    الأحرف لتحديد حدود السلسة:

    * `^` لبداية السلسة
    * `$` لنهاية السلسة

    المعدلات:

    * `*` لأصفار أو تكرارات أكثر من التعبير العادي السابق
    * `+` لواحد أو تكرارات أكثر من التعبير العادي السابق
    * `?` لأصفار أو تكرارات واحدة من التعبير العادي السابق
    * `{m}` لتكرارات `m` من التعبير العادي السابق
    * `{m,n}` لـ `m` إلى `n` تكرارات من التعبير العادي السابق؛ تجاهل `n` يحدد الحد العلوي المطلق

    مجموعات الأحرف التي تعمل مع التحديدات:

    * `^.*$` معادلة لـ `^.+$` (القيم الفارغة لا تطابق مع `^.*$`)
    * `^.?$`, `^.{0,}$`, `^.{0,n}$` معادلة لـ `^.+$`

    مؤقتًا غير مدعوم:

    * الأصناف المحرفة مثل `\W` لغير الأبجديات، `\w` للأبجديات، `\D` لأي غير الأرقام، `\d` لأي عشريات، `\S` لغير مساحات البيضاء، `\s` للمسافات البيضاء

    الصيغة غير المدعومة:

    * أكواد أوكتال من ثلاث أرقام `\NNN`, `\oNNN`, `\ONNN`
    * `\cN` يمر الأحرف السيطرة عبر `\c` (على سبيل المثال، `\cC` لـ CTRL+C)
    * `\A` لبداية السلسة
    * `\z` لنهاية السلسة
    * `\b` قبل أو بعد الرمز فارغ في نهاية السلسة
    * `??`, `*?`, `+?` المحددات الكسولة
    * التكيفيات


**اختبار التعبيرات العادية**

بالنسبة لاختبار التعبير العادي، يمكنك استخدام أداة **cpire** على ديبيان أو أوبنتو المدعومة:

1. أضف مستودع الوالرم:

    === "Debian 10.x (buster)"
        ```bash
        sudo apt update
        sudo apt -y install dirmngr
        curl -fsSL https://repo.wallarm.com/wallarm.gpg | sudo apt-key add -
        sh -c "echo 'deb https://repo.wallarm.com/debian/wallarm-node buster/4.8/' | sudo tee /etc/apt/sources.list.d/wallarm.list"
        sudo apt update
        ```
    === "Debian 11.x (bullseye)"
        ```bash
        sudo apt update
        sudo apt -y install dirmngr
        curl -fSsL https://repo.wallarm.com/wallarm.gpg | sudo gpg --no-default-keyring --keyring gnupg-ring:/etc/apt/trusted.gpg.d/wallarm.gpg --import
        sudo chmod 644 /etc/apt/trusted.gpg.d/wallarm.gpg
        sh -c "echo 'deb https://repo.wallarm.com/debian/wallarm-node bullseye/4.8/' | sudo tee /etc/apt/sources.list.d/wallarm.list"
        sudo apt update
        ```
    === "Ubuntu 18.04 LTS (bionic)"
        ```bash
        sudo apt update
        curl -fsSL https://repo.wallarm.com/wallarm.gpg | sudo apt-key add -
        sh -c "echo 'deb https://repo.wallarm.com/ubuntu/wallarm-node bionic/4.8/' | sudo tee /etc/apt/sources.list.d/wallarm.list"
        sudo apt update
        ```
    === "Ubuntu 20.04 LTS (focal)"
        ```bash
        sudo apt update
        curl -fsSL https://repo.wallarm.com/wallarm.gpg | sudo apt-key add -
        sh -c "echo 'deb https://repo.wallarm.com/ubuntu/wallarm-node focal/4.8/' | sudo tee /etc/apt/sources.list.d/wallarm.list"
        sudo apt update
        ```
    === "Ubuntu 22.04 LTS (jammy)"
        ```bash
        sudo apt update
        curl -fsSL https://repo.wallarm.com/wallarm.gpg | sudo apt-key add -
        sh -c "echo 'deb https://repo.wallarm.com/ubuntu/wallarm-node jammy/4.8/' | sudo tee /etc/apt/sources.list.d/wallarm.list"
        sudo apt update
        ```
2. قم بتثبيت أداة **cpire**:

    ```bash
    sudo apt -y install libcpire-utils
    ```
3. قم بتشغيل أداة **cpire**:
    ```bash
    cpire-runner -r '<التعبير العادي الخاص بك>'
    ```
4. أدخل القيمة للتحقق مما إذا كانت تطابق التعبير العادي. ستقوم الأداة بإعادة النتيجة:
    * `0` إذا كانت القيمة تطابق التعبير العادي
    * `FAIL` إذا لم تطابق القيمة التعبير العادي
    * رسالة خطأ إذا كان التعبير العادي غير صالح

    !!! warning "تفاصيل التعامل مع الحرف `\`"
        إذا كان التعبير يحتوي على `\`، الرجاء تجاهله ب `[[]]` و `\` (على سبيل المثال، `[\\]`).

**أمثلة على التعبيرات العادية المضافة عبر والرم كونسول**

* لمطابقة أي سلسلة تشتمل على <code>/.git</code>

    ```
    /[.]git
    ```
* لمطابقة أي سلسلة تتضمن <code>.example.com</code>

    ```
    [.]example[.]com
    ```
* لمطابقة أي سلسلة تنتهي بـ <code>/.example.*.com</code> حيث أن `*` يمكن أن يكون أي رمز يتكرر أي عدد من المرات

    ```
    /[.]example[.].*[.]com$
    ```
* لمطابقة كل عناوين الانترنت بإستثناء 1.2.3.4 و 5.6.7.8

    ```
    ^(~((1[.]2[.]3[.]4)|(5[.]6[.]7[.]8)))$
    ```
* لمطابقة أي سلسلة تنتهي بـ <code>/.example.com.php</code>

    ```
    /[.]example[.]com[.]php$
    ```
* لمطابقة أي سلسلة تتضمن واحدة أو عدة قيم: <code>sqlmap</code> بالأحرف الصغيرة والعليا: <code>sqLmAp</code>, <code>SqLMap</code>, إلخ.

    ```
    [sS][qQ][lL][mM][aA][pP]
    ```
* لمطابقة أي سلسلة تتضمن واحدة أو عدة قيم: <code>admin\\.exe</code>, <code>admin\\.bat</code>, <code>admin\\.sh</code>, <code>cmd\\.exe</code>, <code>cmd\\.bat</code>, <code>cmd\\.sh</code>

    ```
    (admin|cmd)[\].(exe|bat|sh)
    ```
* لمطابقة أي سلسلة تتضمن واحدة أو عدة قيم: <code>onmouse</code> بالأحرف الصغيرة والعليا, <code>onload</code> بالأحرف الصغيرة والعليا, <code>win\\.ini</code>, <code>prompt</code>

    ```
    [oO][nN][mM][oO][uU][sS][eE]|[oO][nN][lL][oO][aA][dD]|win[\].ini|prompt
    ```
* لمطابقة أي سلسلة تبدأ ب `Mozilla` ولكن لا تحتوي على السلسلة `1aa875F49III`
    
    ```
    ^(Mozilla(~(.*1aa875F49III.*)))$
    ```
* لمطابقة أي سلسلة مع واحدة من القيم: `python-requests/`, `PostmanRuntime/`, `okhttp/3.14.0`, `node-fetch/1.0`

    ```
    ^(python-requests/|PostmanRuntime/|okhttp/3.14.0|node-fetch/1.0)
    ```

#### نوع الشرط: ABSENT (`∅`)

يجب ألا يحتوي الطلب على النقطة المُعيَّنة. في هذه الحالة، لا يُستخدم وسيط المقارنة.

## دورة حياة مجموعة القواعد

تحدد مجموعة القواعد المخصصة خصوصيات معالجة حركة مرور العميل الخاصة (على سبيل المثال، يسمح بإعداد قواعد الكشف عن الهجمات المخصصة أو تقنيع البيانات الحساسة). يعتمد العقدة الوالرم على مجموعة القواعد المخصصة أثناء تحليل الطلبات الواردة.

لا تدخل تغييرات القواعد المخصصة حيز التنفيذ على الفور. يتم تطبيق التغييرات على عملية تحليل الطلب فقط بعد أن يكتمل **بناء** مجموعة القواعد المخصصة و**تفريغها إلى العقدة الفلتر**.

### بناء مجموعة القواعد المخصصة

إضافة قاعدة جديدة، حذف أو تغيير القواعد القائمة في والرم كونسول → **القواعد** تطلق بناء مجموعة القواعد المخصصة. خلال عملية التبني، يتم تحسين القواعد وتجميعها في تنسيق معتمد للعقد الفلتر. عادةً ما يمتد عملية بناء مجموعة القواعد المخصصة من بضع ثوان لعدد صغير من القواعد إلى حوالي ساعة لأشجار القواعد المعقدة.

يتم عرض حالة بناء مجموعة القواعد المخصصة والوقت المتوقع للانتهاء في والرم كونسول. إذا لم يكن هناك بناء قيد التقدم، تعرض الواجهة تاريخ آخر بناء مكتمل.

![حالة البناء](../../images/user-guides/rules/build-rules-status.png)

### تفريغ مجموعة القواعد المخصصة إلى العقدة الفلتر

يُفرغ بناء مجموعة القواعد المخصص إلى العقدة الفلتر أثناء مزامنة العقدة الفلتر ووالرم السحابة. بشكل افتراضي، يتم إطلاق مزامنة العقدة الفلتر ووالرم السحابة كل 2-4 دقائق. [المزيد من التفاصيل عن تكوين مزامنة العقدة الفلتر والوالرم السحابة →](../../admin-en/configure-cloud-node-synchronization-en.md)

يتم تسجيل حالة تفريغ مجموعة القواعد المخصصة إلى العقدة الفلتر في الملف `/var/log/wallarm/syncnode.log` أو `/opt/wallarm/var/log/wallarm/syncnode-out.log` [اعتمادًا على طريقة تثبيت العقدة](../../admin-en/configure-logging.md).

تتلقى جميع عقد الوالرم المتصلة بحساب الوالرم نفسه نفس مجموعة القواعد الافتراضية والمخصصة لتصفية حركة المرور. لا يزال بإمكانك تطبيق قواعد مختلفة لتطبيقات مختلفة عن طريق استخدام معرفات التطبيق السليمة أو معالم الطلب الفريدة مثل الرؤوس، معالم سلسلة الاستعلام، وما إلى ذلك.

### النسخ الاحتياطي والاستعادة

لحماية نفسك من القواعد المحذوفة أو الملفوظة عن طريق الخطأ، يمكنك النسخ الاحتياطي لمجموعة القواعد المخصصة الحالية.

هناك الخيارات التالية للنسخ الاحتياطي للقاعدة: 

* إنشاء نسخة احتياطية تلقائية بعد كل [بناء مجموعة القواعد المخصصة](#custom-ruleset-building). يتم تقييد عدد النسخ الاحتياطية التلقائية إلى 7: لكل يوم عند تغيير القواعد عدة مرات، يتم الاحتفاظ بالنسخة الاحتياطية الأخيرة فقط.
* إنشاء نسخة احتياطية يدويًا في أي وقت. يتم تقييد عدد النسخ الاحتياطية اليدوية إلى 5 بشكل افتراضي. إذا كنت بحاجة إلى المزيد، اتصل بـ [فريق الدعم الفني للوالرم](mailto:support@wallarm.com).

يمكنك:

* الوصول إلى النسخ الاحتياطية الحالية: في قسم **القواعد**، انقر على **النسخ الاحتياطيات**.
* إنشاء نسخة احتياطية جديدة يدويًا: في نافذة **النسخ الاحتياطية**، انقر على **إنشاء نسخة احتياطية**.
* تعيين اسم ووصف معينين للنسخة الاحتياطية اليدوية وتعديلهما في أي لحظة.

    !!! info "تسمية النسخ الاحتياطية الأوتوماتيكية"
        يتم تسمية النسخ الاحتياطية الأوتوماتيكية بواسطة النظام ولا يمكن التغيير الاسم.

* التحميل من النسخة الاحتياطية الموجودة: قم بالنقر على **تحميل** للنسخة الاحتياطية المطلوبة. عند التحميل من النسخة الاحتياطية، يتم حذف تكوين القاعدة الحالي واستبداله بالتكوين من النسخة الاحتياطية.
* حذف النسخة الاحتياطية.

    ![القواعد - إنشاء نسخة احتياطية](../../images/user-guides/rules/rules-create-backup.png)

!!! warning "تقييدات التعديل القاعدة"
   لا يمكنك إنشاء أو تعديل القواعد حتى يكتمل إنشاء النسخة الاحتياطية أو التحميل من النسخة الاحتياطية.