[doc-allowed-hosts]:                ../operations/env-variables.md#limiting-the-number-of-requests-to-be-recorded
[doc-get-token]:                    prerequisites.md#anchor-token
[doc-concurrent-pipelines]:         ci-mode-concurrent-pipelines.md
[doc-env-variables]:                ../operations/env-variables.md

[anchor-recording-variables]:       #environment-variables-in-recording-mode

[link-docker-compose]:              https://docs.docker.com/compose/
[link-docker-compose-install]:      https://docs.docker.com/compose/install/

# تشغيل عقدة FAST في وضع التسجيل

في هذا الوضع، تعمل عقدة FAST قبل اختبار التطبيق المستهدف.

يتم ضبط مصدر الطلبات لاستخدام عقدة FAST كبروكسي وإرسال طلبات HTTP أو HTTPS إلى التطبيق المستهدف.

تحدد عقدة FAST الطلبات الأساسية من بين الطلبات التي تم توجيهها عبر البروكسي وتضعها في سجل اختبار.

!!! info "متطلبات الفصل"
    لمتابعة الخطوات الموصوفة في هذا الفصل، يجب الحصول على [رمز][doc-get-token].
    
    القيم التالية تُستخدم كأمثلة طوال هذا الفصل:

    * `token_Qwe12345` كرمز.
    * `rec_0001` كمعرف لسجل اختبار.

!!! info "تثبيت `docker-compose`"
    سيتم استخدام أداة [`docker-compose`][link-docker-compose] طوال هذا الفصل لعرض كيفية عمل عقدة FAST في وضع التسجيل.
    
    تتوفر تعليمات التثبيت لهذه الأداة [هنا][link-docker-compose-install].

## متغيرات البيئة في وضع التسجيل

يتم ضبط تكوين عقدة FAST عبر متغيرات البيئة. تحتوي الجدول أدناه على جميع متغيرات البيئة التي يمكن استخدامها لضبط عقدة FAST في وضع التسجيل.

| متغير البيئة          | القيمة   | مطلوب؟ |
|--------------------	| --------	| -----------	|
| `WALLARM_API_TOKEN`  	| رمز للعقدة. | نعم |
| `WALLARM_API_HOST`   	| اسم نطاق خادم واجهة برمجة تطبيقات Wallarm المُستخدم. <br>القيم المسموح بها: <br>`us1.api.wallarm.com` للاستخدام مع السحابة الأمريكية؛<br>`api.wallarm.com` للاستخدام مع السحابة الأوروبية.| نعم |
| `CI_MODE`            	| وضع تشغيل عقدة FAST. <br>القيمة المطلوبة: `recording`. | نعم |
| `TEST_RECORD_NAME`   	| اسم سجل الاختبار الجديد المراد إنشاؤه. <br>القيمة الافتراضية بهذا الشكل: “TestRecord Oct 08 12:18 UTC”. | لا |
| `INACTIVITY_TIMEOUT` 	| إذا لم تصل الطلبات الأساسية إلى عقدة FAST خلال فترة `INACTIVITY_TIMEOUT`، يتم إيقاف عملية التسجيل مع عقدة FAST.<br>القيم المسموح بها: من 1 إلى 691200 ثوان (أسبوع واحد)<br>القيمة الافتراضية: 600 ثانية (10 دقائق). | لا |
| `ALLOWED_HOSTS`       | ستسجل عقدة FAST تلك الطلبات التي تستهدف أي نطاق مدرج في متغير البيئة. <br>القيمة الافتراضية: سلسلة فارغة (سيتم تسجيل جميع الطلبات الواردة). انظر [هذا][doc-allowed-hosts] المستند للتفاصيل.| لا |
| `BUILD_ID` | معرف سير عمل CI/CD. يسمح هذا المعرف لعدة عقد FAST بأن تعمل بشكل متزامن باستخدام نفس العقدة سحابة FAST. انظر [هذا][doc-concurrent-pipelines] المستند للتفاصيل.| لا |

!!! info "انظر أيضًا"
    تتوفر أوصاف متغيرات البيئة التي لا تختص بنمط تشغيل عقدة FAST معيّن [هنا][doc-env-variables].

## نشر عقدة FAST في وضع التسجيل

سيتم استخدام ملف تكوين يسمى `docker-compose.yaml` كمثال لعرض كيفية عمل FAST في وضع التسجيل (لاحظ قيمة متغير البيئة `CI_MODE`):

```
version: '3'
  services:
    fast:                                        
      image: wallarm/fast
      environment:
        WALLARM_API_TOKEN: token_Qwe12345        # حدد قيمة الرمز هنا
        WALLARM_API_HOST: us1.api.wallarm.com    # هنا يتم استخدام خادم واجهة برمجة تطبيقات السحابة الأمريكية. استخدم api.wallarm.com لخادم واجهة برمجة تطبيقات السحابة الأوروبية.
        CI_MODE: recording
      ports:
        - '8080:8080'                              
      networks:
        main:
          aliases:
            - fast

networks:
  main:
```

لتشغيل حاوية Docker بعقدة FAST، انتقل إلى الدليل الذي يحتوي على ملف `docker-compose.yaml` ونفذ الأمر `docker-compose up fast`.

إذا تم تنفيذ الأمر بنجاح، سيتم إنشاء مخرجات وحدة التحكم مشابهة لما هو موضح هنا:

```
  __      __    _ _
  \ \    / /_ _| | |__ _ _ _ _ __
   \ \/\/ / _` | | / _` | '_| '  \
    \_/\_/\__,_|_|_\__,_|_| |_|_|_|
             ___ _   ___ _____
            | __/_\ / __|_   _|
            | _/ _ \\__ \ | |
            |_/_/ \_\___/ |_|
 
 Loading...
 [info] العقدة متصلة بسحابة Wallarm
 [info] تم تحميل 0 امتدادات مخصصة لماسح FAST الضوئي
 [info] تم تحميل 44 امتداد افتراضي لماسح FAST الضوئي
 [info] سجل TestRecord#rec_0001 TestRecord Oct 01 01:01 UTC يبدأ في التسجيل

```

تُعلمنا هذه المخرجات أن عقدة FAST قد اتصلت بنجاح بالسحابة وأنشأت سجل اختبار بمعرف `rec_0001` والاسم `TestRecord Oct 01 01:01 UTC.` وهي جاهزة لاستقبال الطلبات وتسجيل الطلبات الأساسية.

!!! info "ملاحظة حول أسماء سجل الاختبار"
    لتغيير اسم سجل الاختبار الافتراضي، يجب إدخال القيمة اللازمة عبر متغير البيئة `TEST_RECORD_NAME` عند تشغيل حاوية Docker لعقدة FAST.

!!! warning "تنفيذ الاختبار"
    هذه هي اللحظة لإجراء الاختبارات الموجودة للتطبيق المستهدف. سوف تسجل FAST الطلبات الأساسية وتضيفها إلى سجل الاختبار.

## إيقاف وإزالة حاوية Docker بعقدة FAST في وضع التسجيل

عندما يتم تسجيل جميع الطلبات الأساسية الضرورية، سيتم إيقاف عقدة FAST بواسطة أداة CI/CD وإرجاع رمز خروج.

إذا لم تواجه عقدة FAST أي أخطاء وانتهت عملية تسجيل الأساسيات بنجاح، سيتم إرجاع رمز الخروج `0`.

إذا واجهت عقدة FAST بعض الأخطاء أو تم إيقاف عملية التسجيل بسبب انتهاء الوقت (انظر وصف متغير البيئة [`INACTIVITY_TIMEOUT`][anchor-recording-variables])، فإن عقدة FAST تتوقف تلقائيًا ويتم إرجاع رمز الخروج `1`.

عندما تنتهي عقدة FAST من عملها، يجب إيقاف حاوية Docker المقابلة وإزالتها.

إذا لم تتوقف عقدة FAST تلقائيًا برمز الخروج `1` وتم تسجيل كافة الطلبات الأساسية المطلوبة، فيمكنك إيقاف حاوية Docker لعقدة FAST بتنفيذ أمر `docker-compose stop <اسم الحاوية>`:

```
docker-compose stop fast
```

لإزالة حاوية عقدة FAST، نفذ الأمر `docker-compose rm <اسم الحاوية>`:

```
docker-compose rm fast
```

في الأمثلة أعلاه، يستخدم `fast` كاسم لحاوية Docker المراد إيقافها أو إزالتها.

بديلاً، يمكنك استخدام الأمر `docker-compose down`، الذي يوقف ويزيل الحاويات لجميع الخدمات الموصوفة في ملف `docker-compose.yaml`.