[doc-testpolicy]:                   ../operations/internals.md#fast-test-policy
[doc-testpolicy-creation-example]:  ../qsg/test-preparation.md#2-create-a-test-policy-targeted-at-xss-vulnerabilities
[doc-waiting-for-tests]:            waiting-for-tests.md
[doc-get-token]:                    prerequisites.md#anchor-token
[doc-concurrent-pipelines]:         ci-mode-concurrent-pipelines.md
[doc-env-variables]:                ../operations/env-variables.md

[link-wl-portal-new-policy]:        https://us1.my.wallarm.com/testing/policies/new#general
[link-docker-compose]:              https://docs.docker.com/compose/
[link-docker-compose-install]:      https://docs.docker.com/compose/install/

[anchor-testing-mode]:              #deployment-of-a-fast-node-in-the-testing-mode
[anchor-testing-variables]:         #environment-variables-in-testing-mode
[anchor-stopping-fast-node]:        ci-mode-recording.md#stopping-and-removing-the-docker-container-with-the-fast-node-in-recording-mode
[anchor-testing-mode]:              #deployment-of-a-fast-node-in-the-testing-mode

#  تشغيل عقدة FAST في وضع الاختبار

أثناء وجودها في وضع الاختبار، تقوم عقدة FAST بإنشاء تشغيل اختبار استنادًا إلى السجل الاختباري الذي تم تعبئته من الطلبات الأساسية في وضع التسجيل وتنفيذ مجموعة الاختبار الأمني للتطبيق الهدف.

!!! info "الشروط الأساسية لهذا الفصل"
    لمتابعة الخطوات الموصوفة في هذا الفصل، تحتاج إلى الحصول على [رمز][doc-get-token].
    
    يتم استخدام القيم التالية كأمثلة طوال هذا الفصل:
        
    * 'tr_1234' كمعرف لتشغيل الاختبار
    * 'rec_0001' كمعرف لسجل الاختبار
    * 'bl_7777' كمعرف لىطلب الأساسي

!!! info "تثبيت 'docker-compose'"
    سيتم استخدام أداة ['docker-compose'][link-docker-compose] في جميع أنحاء هذا الفصل للتوضيح كيف تعمل عقدة FAST في وضع الاختبار.
    
    تتوافر تعليمات التثبيت لهذه الأداة [هنا][link-docker-compose-install].

## المتغيرات البيئية في وضع الاختبار

يتم تكوين عقدة FAST عبر المتغيرات البيئية. الجدول أدناه يحتوي على جميع المتغيرات البيئية التي يمكن استخدامها لتكوين عقدة FAST في وضع الاختبار.

| المتغير البيئي   | القيمة  | مطلوب؟ |
|--------------------    | --------    | -----------    |
| `WALLARM_API_TOKEN`  | الرمز للعقدة. | نعم |
| `WALLARM_API_HOST`    | اسم المجال لخادم Wallarm API للاستخدام. <br>القيم المسموح بها: <br>`us1.api.wallarm.com` للاستخدام مع السحابة الأمريكية؛<br>`api.wallarm.com` للاستخدام مع السحابة الأوروبية.| نعم |
| `CI_MODE`                  | وضع تشغيل العقدة FAST. <br>القيمة المطلوبة: 'testing'. | نعم |
| `WORKERS` | عدد النوى المتوازية التي تعمل مع الطلبات الأساسية المتعددة بطريقة متوازية.<br>القيمة الافتراضية: "10". | لا |
| `TEST_RECORD_ID` | معرف سجل الاختبار.<br>الافتراضي: قيمة فارغة. | لا |
| `TEST_RUN_NAME` | اسم تشغيل الاختبار.<br> القيمة الافتراضية بصيغة مشابهة: "TestRun Sep 24 12:31 UTC". | لا |
| `TEST_RUN_DESC` | وصف تشغيل الاختبار.<br>القيمة الافتراضية: سلسلة فارغة. | لا |
| `TEST_RUN_POLICY_ID` | مُعرِّف سياسة الاختبار.<br>إذا كان العامل مفقودًا، فسيتم اتخاذ السياسة الافتراضية. | لا |
| `TEST_RUN_RPS` | يحدد العامل حدًا لعدد طلبات الاختبار (RPS ، طلبات لكل ثانية) التي يتم إرسالها إلى التطبيق الهدف أثناء تنفيذ تشغيل الاختبار.<br>نطاق القيم المسموح به: من 1 إلى 1000 (طلب لكل ثانية) <br> القيمة الافتراضية: غير محدودة. | لا |
| `TEST_RUN_STOP_ON_FIRST_FAIL` | يحدد هذا العامل سلوك FAST عند اكتشاف ثغرة أمنية:<br>'true': يتوقف عن تنفيذ تشغيل الاختبار عند اكتشاف الثغرة الأولى.<br>'false': يعالج جميع الطلبات الأساسية بغض النظر عما إذا تم اكتشاف أي ثغرة أمنية أم لا.<br>القيمة الافتراضية: 'false'. | لا |
| `TEST_RUN_URI` | URI للتطبيق الهدف.<br>قد يتغير عنوان IP للتطبيق الهدف أثناء عملية CI/CD، لذا يمكنك استخدام URI التطبيق. <br>على سبيل المثال، URI للتطبيق الذي تم نشره عبر 'docker-compose' قد يبدو مثل 'http://app-test:3000'.  | لا |
| `BUILD_ID` | معرف سير العملية CI/CD. يتيح هذا المعرف لعدة عقد FAST العمل بشكل متوازي باستخدام نفس العقدة السحابية FAST. يمكنك الرجوع إلى [هذا][doc-concurrent-pipelines] الوثيقة للحصول على التفاصيل.| لا |
| `FILE_EXTENSIONS_TO_EXCLUDE` | قائمة الاضافات الملفات الثابتة التي يجب استبعادها من عملية التقييم أثناء الاختبار.<br>يمكنك تعداد هذه الامتدادات باستخدام الحرف <code>&#124;</code>: <br><code>FILE_EXTENSIONS_TO_EXCLUDE='jpg & #124; ico & #124; png'</code> | لا |
| `PROCESSES` | عدد العمليات التي يمكن استخدامها بواسطة عقدة FAST. كل عملية تستخدم عدد الخيوط المحدد في متغير `WORKERS`.<br>العدد الافتراضي للعمليات: '1'.<br>القيمة الخاصة: 'مرة' يساوي نصف عدد وحدات المعالجة المركزية التي يتم حسابها باستخدام الأمر [nproc](https://www.gnu.org/software/coreutils/manual/html_node/nproc-invocation.html#nproc-invocation). | لا |

!!! info "انظر أيضًا"
    متوفرة وصفات المتغيرات البيئية التي ليست محددة لوضع تشغيل عقدة FAST المعينة [هنا][doc-env-variables].

## الحصول على معرف سياسة الاختبار

إذا كنت تخطط لاستخدام [سياسة الاختبار][doc-testpolicy] الخاصة بك، ثم [إنشاء واحدة][link-wl-portal-new-policy] في سحابة Wallarm. في وقت لاحق، قم بتمرير المعرف إلى حاوية Docker للعقدة FAST عبر متغير البيئة `TEST_RUN_POLICY_ID` عند تشغيل العقدة FAST في وضع الاختبار. 

وإلا، إذا اخترت استخدام سياسة الاختبار الافتراضية، فلا تقم بتعيين متغير البيئة `TEST_RUN_POLICY_ID` للحاوية.

!!! info "كيفية إنشاء سياسة اختبار"
    دليل "البدء السريع" يحتوي على تعليمات [خطوة بخطوة][doc-testpolicy-creation-example] حول كيفية إنشاء سياسة اختبار عينة.

## الحصول على معرف سجل اختبار
 
لاستخدام سجل اختبار معين في وضع الاختبار، يمكنك تمرير العرف سجل الاختبار إلى العقدة FAST باستخدام معلمة [`TEST_RECORD_ID`][anchor-testing-variables]. لذا، لا حاجة لتشغيل العقدة FAST في وضع التسجيل أولاً. بدلاً من ذلك، يمكنك استخدام سجل اختبار مشكل مسبقًا لإجراء نفس اختبارات الأمان عدة مرات في عقد مختلفة وتشغيل اختبارات.
 
يمكنك الحصول على معرف سجل الاختبار في واجهة بوابة Wallarm أو من سجل العقدة FAST في وضع الاختبار. إذا لم تستخدم الفعل `TEST_RECORD_ID`، فإن العقدة FAST ستستخدم آخر سجل اختبار للعقدة.

## تنشيط العقدة FAST في وضع الاختبار

ملف `docker-compose.yaml` الذي تم إنشاؤه في وقت سابق مناسب لتشغيل العقدة FAST في وضع الاختبار.
للقيام بذلك، من الضروري تغيير قيمة متغير البيئة `CI_MODE` إلى القيمة 'testing'.

يمكنك إما تغيير قيمة المتغير عن طريق تعديله في ملف 'docker-compose.yaml' أو نقدم المتغير البيئي بالقيمة المطلوبة إلى حاوية Docker عبر الخيار `-e` للأمر 'docker-compose run':

```
docker-compose run --rm -e CI_MODE=testing fast
```

!!! info "الحصول على التقرير حول الاختبار"
    للحصول على التقرير مع نتائج الاختبار، قم بتوصيل الدليل لتنزيل التقرير عبر الخيار '-v {DIRECTORY_FOR_REPORTS}:/opt/reports/' عند نشر حاوية Docker العقدة FAST.

    عند الانتهاء من الاختبار الأمني، ستجد التقرير الأولي `<اسم تشغيل الاختبار>. <UNIX TIME>.txt` والتقرير التفصيلي `<اسم تشغيل الاختبار>. <UNIX TIME>.json` في دليل `{DIRECTORY_FOR_REPORTS}`.

!!! info "خيارات الأمر `docker-compose`"
    يمكنك تمرير أي من المتغيرات البيئية الموصوفة أعلاه إلى حاوية Docker للعقدة FAST عبر خيار '-e'.

    يتم استخدام الخيار `--rm` أيضًا في الأمثلة أعلاه، بحيث يتم التخلص تلقائيًا من حاوية العقدة FAST عند إيقاف العقدة.

إذا نفذ الأمر بنجاح، فسيتم إنشاء ناتج وحدة التحكم مشابه للذي يظهر هنا:

```
 __      __    _ _
 \ \    / /_ _| | |__ _ _ _ _ __
  \ \/\/ / _` | | / _` | '_| '  \
   \_/\_/\__,_|_|_\__,_|_| |_|_|_|
            ___ _   ___ _____
           | __/_\ / __|_   _|
           | _/ _ \\__ \ | |
           |_/_/ \_\___/ |_|

Loading...
INFO synccloud[13]: Registered new instance 16dd487f-3d40-4834-xxxx-8ff17842d60b
INFO [1]: Loaded 0 custom extensions for fast scanner
INFO [1]: Loaded 44 default extensions for fast scanner
INFO [1]: Use TestRecord#rec_0001 for creating TestRun
INFO [1]: TestRun#tr_1234 created
```

هذا الخروج يعلمنا أن سجل الاختبار ذو المعرف 'rec_0001' تم استخدامه لإنشاء تشغيل اختبار ذو المعرف 'tr_1234'، وتمت هذه العملية بنجاح.

بعد ذلك، يتم إنشاء اختبارات الأمان وتنفيذها بواسطة العقدة FAST لكل طلب أساسي في سجل الاختبار الذي ينطبق على سياسة الاختبار. ستحتوي ناتج الوحدة التحكم على رسائل مشابهة لهذه:

```
INFO [1]: Running a test set for the baseline #bl_7777
INFO [1]: Test set for the baseline #bl_7777 is running
INFO [1]: Retrieving the baseline request Hit#["hits_production_202_20xx10_v_1", "AW2xxxxxW26"]
INFO [1]: Use TestPolicy with name 'Default Policy'
```

هذا الإخراج يُبلغنا أن مجموعة الاختبار قيد التشغيل للطلبات الأساسية بالمعرف 'bl_7777'. أيضًا، يخبرنا أن سياسة الاختبار الافتراضية is being used بسبب عدم وجود متغير البيئة `TEST_RUN_POLICY_ID`.

## إيقاف وإزالة الحاوية Docker مع العقدة FAST في وضع الاختبار

اعتمادًا على نتائج الاختبار المحصل عليها، يمكن أن تتوقف العقد FAST بطرق مختلفة.

إذا تم اكتشاف بعض الثغرات الأمنية في التطبيق الهدف، فإن العقدة FAST تظهر رسالة مشابهة لهذه:

```
INFO [1]: Found 4 vulnerabilities, marking the test set for baseline #bl_7777 as failed
ERROR [1]: TestRun#tr_1234 failed
```

في هذه الحالة، تم العثور على أربعة ثغرات. يعتبر مجموعة الاختبار للطلب الأساسي بالمعرف 'bl_7777' قد فشلت. يتم أيضًا وضع علامة على تشغيل الاختبار الملائم بالمعرف 'tr_1234' كفاشل.

إذا لم يتم اكتشاف أي ثغرات أمنية في التطبيق الهدف، تظهر العقدة FAST رسالة مشابهة لهذه:

```
INFO [1]: No issues found. Test set for baseline #bl_7777 passed.
INFO [1]: TestRun#tr_1234 passed
```

في هذه الحالة، يعتبر تشغيل الاختبار بالمعرف 'tr_1234' قد نجح.

!!! warning "حول مجموعات الاختبار الأمني"
    لاحظ مع ذلك أن الأمثلة أعلاه لا تعني أنه تم تنفيذ مجموعة اختبار واحدة فقط. يتم تكوين مجموعة اختبار لكل طلب أساسي يتوافق مع سياسة اختبار FAST.
    
    تظهر هنا رسالة متعلقة بمجموعة اختبار وحدة لأغراض التوضيح.

بعد انتهاء العقدة FAST من عملية الاختبار، تنتهي وتعيد كود الخروج إلى العملية التي تعمل كجزء من وظيفة CI/CD.
* إذا كان حالة الاختبار الأمني "نجح" والعقدة FAST لم تواجه أي أخطاء أثناء عملية الاختبار، فيتم إرجاع الرمز الخروج '0'. 
* خلاف ذلك، إذا فشلت الاختبارات الأمنية أو تواجه العقدة FAST بعض الأخطاء أثناء عملية الاختبار، ثم يتم إرجاع الرمز الخروج '1'.

سوف تتوقف حاوية العقدة FAST في وضع الاختبار تلقائيًا بعد الانتهاء من الاختبار الأمني. ومع ذلك، يمكن أن يكون لأداة CI/CD لا يزال تحت سيطرته على العقدة ودورة حياة حاويتها من خلال الوسائل [وصفت في وقت سابق][anchor-stopping-fast-node].

في [المثال أعلاه][anchor-testing-mode] تم تشغيل حاوية العقدة FAST مع الخيار `--rm`، وهذا يعني أن الحاوية المتوقفة يتم إزالتها تلقائيًا.