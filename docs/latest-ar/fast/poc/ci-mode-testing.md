[doc-testpolicy]:                   ../operations/internals.md#fast-test-policy
[doc-testpolicy-creation-example]:  ../qsg/test-preparation.md#2-create-a-test-policy-targeted-at-xss-vulnerabilities
[doc-waiting-for-tests]:            waiting-for-tests.md
[doc-get-token]:                    prerequisites.md#anchor-token
[doc-concurrent-pipelines]:         ci-mode-concurrent-pipelines.md
[doc-env-variables]:                ../operations/env-variables.md

[link-wl-portal-new-policy]:        https://us1.my.wallarm.com/testing/policies/new#general
[link-docker-compose]:              https://docs.docker.com/compose/
[link-docker-compose-install]:      https://docs.docker.com/compose/install/

[anchor-testing-mode]:              #deployment-of-a-fast-node-in-the-testing-mode
[anchor-testing-variables]:         #environment-variables-in-testing-mode
[anchor-stopping-fast-node]:        ci-mode-recording.md#stopping-and-removing-the-docker-container-with-the-fast-node-in-recording-mode
[anchor-testing-mode]:              #deployment-of-a-fast-node-in-the-testing-mode

#  تشغيل FAST Node في وضع الاختبار

أثناء الوضع الاختباري، يقوم العقدة FAST بإنشاء تشغيل الاختبار بناءً على سجل الاختبار الذي تم ملؤه من الطلبات الأساسية في وضع التسجيل وينفذ مجموعة الاختبار الأمني للتطبيق الهدف.

!!! info "المتطلبات الأساسية للفصل"
    لمتابعة الخطوات الموضحة في هذا الفصل، تحتاج إلى الحصول على [رمز][doc-get-token].
    
    يتم استخدام القيم التالية كأمثلة طوال هذا الفصل::
        
    * `tr_1234` كمعرف لتشغيل الاختبار
    * `rec_0001` كمعرف لسجل الاختبار
    * `bl_7777` كمعرف لطلب الخط الأساسي

!!! info "تثبيت `docker-compose`"
    سيتم استخدام أداة [`docker-compose`][link-docker-compose] طوال هذا الفصل للتوضيح كيف يعمل العقدة FAST في وضع الاختبار.
    
    تتوفر تعليمات التثبيت لهذه الأداة [هنا][link-docker-compose-install].

## المتغيرات البيئية في وضع الاختبار

يتم تكوين العقدة FAST عبر المتغيرات البيئية. الجدول أدناه يحتوي على جميع المتغيرات البيئية التي يمكن استخدامها لتكوين العقدة FAST في وضع الاختبار.

| المتغير البيئي   | القيمة  | مطلوب؟ |
|--------------------	| --------	| -----------	|
| `WALLARM_API_TOKEN`  	| الرمز للعقدة. | نعم |
| `WALLARM_API_HOST`   	| اسم النطاق لخادم API Wallarm المطلوب استخدامه. <br>القيم المسموح بها: <br>`us1.api.wallarm.com` للاستخدام مع السحابة الأمريكية;<br>`api.wallarm.com` للاستخدام مع السحابة الأوروبية.| نعم |
| `CI_MODE`            	| وضع تشغيل العقدة FAST. <br> القيمة المطلوبة: `testing`. | نعم |
| `WORKERS` | عدد الخيوط المتزامنة التي تعمل مع العديد من الطلبات الأساسية بطريقة متوازية.<br>قيمة الافتراضية: `10`.| لاء |
| `TEST_RECORD_ID` | معرف سجل الاختبار.<br>الافتراضي: قيمة فارغة. | لاء |
| `TEST_RUN_NAME` | اسم تشغيل الاختبار.<br>القيمة الافتراضية في تنسيق مماثل: “TestRun Sep 24 12:31 UTC”. | لاء |
| `TEST_RUN_DESC` | وصف تشغيل الاختبار.<br>القيمة الافتراضية: سلسلة فارغة. | لاء |
| `TEST_RUN_POLICY_ID` | معرف السياسة الاختبار.<br> إذا كان المعامل مفقودًا، فإن السياسة الافتراضية تتدخل. | لاء |
| `TEST_RUN_RPS` | يحدد المعامل حدًا لعدد الطلبات الاختبار (*RPS*, *requests per second*) التي يتم إرسالها إلى التطبيق الهدف خلال تنفيذ تشغيل الاختبار.<br>النطاق المسموح به القيمة: من 1 إلى 1000 (طلب في الثانية)<br>القيمة الافتراضية: غير محدود. | لاء |
| `TEST_RUN_STOP_ON_FIRST_FAIL` | يحدد هذا المعامل سلوك FAST عند اكتشاف الثغرة:<br>`true`: يوقف تنفيذ تشغيل الاختبار عند الثغرة الأولى المكتشفة.<br>`false`: يعالج جميع الطلبات الأساسية بغض النظر عن اكتشاف أي ثغرة.<br>القيمة الافتراضية: `false`. | لاء |
| `TEST_RUN_URI` | URI للتطبيق الهدف.<br> قد يتغير عنوان IP للتطبيق الهدف خلال عملية CI/CD، لذا يمكنك استخدام URI التطبيق. <br>على سبيل المثال، يمكن أن يبدو URI التطبيق المنشر عبر `docker-compose` مثل `http://app-test:3000`.  | لاء |
| `BUILD_ID` | معرف سير عمل CI/CD. هذا المعرف يسمح لعدة عقدات FAST بالعمل بالتزامن باستخدام العقدة السحابية FAST نفسها. انظر [هذا][doc-concurrent-pipelines] المستند للتفاصيل.| لاء |
| `FILE_EXTENSIONS_TO_EXCLUDE` | قائمة الامتدادات الملف الثابتة التي يجب استبعادها من عملية التقييم أثناء الاختبار.<br>يمكنك تعداد هذه الامتدادات باستخدام الحرف <code>&#124;</code>: <br><code>FILE_EXTENSIONS_TO_EXCLUDE='jpg&#124;ico&#124;png'</code> | لاء |
| `PROCESSES`            | عدد العمليات التي يمكن استخدامها بواسطة العقدة FAST. كل عملية تستخدم عدد الخيوط المحدد في المتغير `WORKERS`.<br>عدد العمليات الافتراضية: `1`.<br>القيمة الخاصة: `auto` يساوي نصف عدد الوحدة المركزية المحسوبة باستخدام الأمر [nproc](https://www.gnu.org/software/coreutils/manual/html_node/nproc-invocation.html#nproc-invocation). | لاء |

!!! info "انظر أيضًا"
    تتوفر وصف المتغيرات البيئية التي ليست خاصة بوضع عمل العقدة FAST معينة [هنا][doc-env-variables].

## الحصول على معرف السياسة الاختبار

إذا كنت تخطط لاستخدام [سياسة الاختبار][doc-testpolicy] الخاصة بك، ثم [إنشاء واحد][link-wl-portal-new-policy] في السحابة Wallarm. لاحقا، قم بتمرير المعرف إلى حاوية Docker للعقدة FAST عبر المتغير البيئي `TEST_RUN_POLICY_ID` عند تشغيل العقدة FAST في وضع الاختبار. 

وإلا، إذا اخترت استخدام سياسة الاختبار الافتراضية، فلا تقم بتعيين المتغير البيئي `TEST_RUN_POLICY_ID` للحاوية.

!!! info "كيفية إنشاء سياسة الاختبار"
    الدليل "البدء السريع" يحتوي على تعليمات [خطوة بخطوة][doc-testpolicy-creation-example] حول كيفية إنشاء سياسة اختبار نموذجية.

## الحصول على معرف سجل الاختبار
 
لاستخدام سجل اختبار معين في وضع الاختبار، يمكنك تمرير معرف سجل الاختبار إلى العقدة FAST باستخدام المعامل [`TEST_RECORD_ID`][anchor-testing-variables]. وبهذا، لا حاجة لتشغيل العقدة FAST في وضع التسجيل أولا. بدلاً من ذلك، يمكنك استخدام سجل اختبار مشكل مسبقا لإجراء نفس الاختبارات الأمنية عدة مرات في عقد مختلفة وتشغيل-اختبار.

يمكنك الحصول على المعرف لسجل الاختبار في واجهة بوابة Wallarm أو من سجل FAST node في وضع الاختبار. إذا لم تستخدم المعامل `TEST_RECORD_ID`، فإن العقدة FAST ستستخدم آخر سجل اختبار للعقدة.

## نشر العقدة FAST في وضع الاختبار

الملف `docker-compose.yaml` الذي تم إنشاؤه في وقت سابق مناسب لتشغيل العقدة FAST في وضع الاختبار.
للقيام بذلك، من الضروري تغيير قيمة المتغير البيئي `CI_MODE` إلى القيمة `testing`.

إما أنك يمكنك تغيير قيمة المتغير عن طريق تعديله في الملف `docker-compose.yaml` أو تمرير المتغير البيئي بالقيمة المطلوبة إلى حاوية Docker عبر الخيار `-e` للأمر `docker-compose run`:

```
docker-compose run --rm -e CI_MODE=testing fast
```

!!! info "حصول على التقرير حول الاختبار"
    للحصول على التقرير مع نتائج الاختبار، قم بتوصيل الدليل لتنزيل التقرير عبر الخيار `-v {DIRECTORY_FOR_REPORTS}:/opt/reports/` عند نشر حاوية Docker للعقدة FAST.

    عندما ينتهي الاختبار الأمني، ستجد التقرير البسيط `<TEST RUN NAME>.<UNIX TIME>.txt` والتقرير المفصل `<TEST RUN NAME>.<UNIX TIME>.json` في الدليل `{DIRECTORY_FOR_REPORTS}`.

!!! info "خيارات الأمر `docker-compose`"
    يمكنك تمرير أي من المتغيرات البيئية الموضحة أعلاه إلى حاوية Docker للعقدة FAST عبر الخيار `-e`.

    الخيار `--rm` يتم استخدامه أيضًا في الأمثلة أعلاه، بحيث يتم التخلص تلقائياً من حاوية العقدة FAST عند إيقاف العقدة.

إذا تم تنفيذ الأمر بنجاح، فسيتم إنشاء ناتج كونسول مشابه للذي يتم عرضه هنا:

```
 __      __    _ _
 \ \    / /_ _| | |__ _ _ _ _ __
  \ \/\/ / _` | | / _` | '_| '  \
   \_/\_/\__,_|_|_\__,_|_| |_|_|_|
            ___ _   ___ _____
           | __/_\ / __|_   _|
           | _/ _ \\__ \ | |
           |_/_/ \_\___/ |_|

جارٍ التحميل...
INFO synccloud[13]: تم تسجيل العينة الجديدة بنجاح 16dd487f-3d40-4834-xxxx-8ff17842d60b
INFO [1]: تم تحميل 0 مكونات مخصصة لماسحة fast
INFO [1]: تم تحميل 44 مكونات افتراضية لماسحة fast
INFO [1]: استخدم TestRecord#rec_0001 لإنشاء TestRun
INFO [1]: تم إنشاء TestRun#tr_1234
```

هذا الناتج يبلغنا أنه تم استخدام سجل الاختبار بالمعرف `rec_0001` لإنشاء تشغيل الاختبار بالمعرف `tr_1234`، وإنجاز هذه العملية بنجاح.

بعد ذلك، يتم إنشاء اختبارات الأمن وتنفيذها بواسطة العقدة FAST لكل طلب أساسي في سجل الاختبار الذي يستوفي سياسة الاختبار. سيحتوي الناتج الكونسول على رسائل مشابهة لهذه:

```
INFO [1]: تشغيل مجموعة اختبار للخط الأساسي #bl_7777
INFO [1]: تشغيل مجموعة اختبار للخط الأساسي #bl_7777
INFO [1]: جار الاسترجاع لطلب الخط الأساسي Hit#["hits_production_202_20xx10_v_1", "AW2xxxxxW26"]
INFO [1]: استخدم TestPolicy بالاسم 'Default Policy'
```

هذا الناتج يبلغنا أن مجموعة الاختبار قيد التشغيل للطلبات الأساسية بالمعرف `bl_7777`. وكذلك، يخبرنا أن سياسة الاختبار الافتراضية قيد الاستخدام بسبب عدم وجود المتغير البيئي `TEST_RUN_POLICY_ID`.

## إيقاف وإزالة حاوية Docker مع العقدة FAST في وضع الاختبار

حسب نتائج الاختبار المحصل عليها، يمكن أن تتوقف العقدات FAST بطرق مختلفة.

إذا كانت هناك بعض الثغرات مكتشفة في التطبيق الهدف، فإن العقدة FAST توجه رسالة مشابهة لهذه:

```
INFO [1]: تم العثور على 4 ثغرات، تم وضع علامة فشل على مجموعة الاختبار للقاعدة #bl_7777
ERROR [1]: فشل TestRun#tr_1234
```

في هذه الحالة، تم العثور على أربع ثغرات. تعتبر مجموعة الاختبار للقاعدة بالمعرف `bl_7777` فاشلة. تم الأيضا تمييز تشغيل الاختبار المقابل بالمعرف `tr_1234` كفاشل.

إذا لم يتم اكتشاف ثغرات في التطبيق الهدف، يعرض العقدة FAST رسالة مشابهة لهذه:

```
INFO [1]: لم يتم العثور على أي مشكلات. تم اجتياز مجموعة الاختبار للخط الأساسي #bl_7777.
INFO [1]: نجح TestRun#tr_1234
```

في هذه الحالة، يعتبر تشغيل الاختبار بالمعرف `tr_1234` ناجحًا.

!!! warning "حول مجموعات الاختبار الأمني"
    لاحظ أن الأمثلة أعلاه لا تعني أن مجموعة اختبار واحدة فقط تم تنفيذها. يتم تشكيل مجموعة اختبار لكل طلب أساسي يتوافق مع سياسة الاختبار FAST.
    
    رسالة واحدة متعلقة بمجموعة الاختبار تظهر هنا لأغراض العرض فقط.

بعد أن ينتهي العقدة FAST من عملية الاختبار، يتوقف ويعود بكود الخروج لعملية الجري كجزء من وظيفة CI/CD. 
* إذا كان حالة الاختبار الأمني "ناجح" ولم تواجه العقدة FAST أي أخطاء أثناء عملية الاختبار، فيتم إرجاع كود الخروج `0`. 
* وإلا، إذا فشلت الاختبارات الأمنية أو تواجه العقدة FAST بعض الأخطاء أثناء عملية الاختبار، فيتم إرجاع كود الخروج `1`.

سيتوقف حاوية العقدة FAST في وضع الاختبار تلقائيًا بعد الانتهاء من الاختبار الأمني. ومع ذلك، يمكن لأداة CI/CD أن تظل في السيطرة على العقدة ودورة حياتها الحاوية بواسطة الوسائل [وصفت في وقت سابق][anchor-stopping-fast-node].

في الـ [أمثلة أعلاه][anchor-testing-mode] تشتغل العقدة FAST بخيار `--rm`. هذا يعني أنه يتم إزالة الحاوية التي توقفت تلقائيا.