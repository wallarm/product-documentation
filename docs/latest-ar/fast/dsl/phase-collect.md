[link-points]:          points/intro.md
[link-ruby-regexp]:     http://ruby-doc.org/core-2.6.1/doc/regexp_rdoc.html
[link-ext-logic]:       logic.md

[img-collect-uniq]:    ../../images/fast/dsl/en/phases/collect-uniq.png

# مرحلة التجميع

!!! info "نطاق المرحلة"
    تُستخدم هذه المرحلة في امتداد تعديلي وهي اختيارية لعمليته (قسم `collect` قد يكون غائبًا أو موجودًا في ملف YAML).
    
    كذلك، تُستخدم هذه المرحلة بشكل ضمني من قِبل امتداد غير تعديلي لأن هذا النوع من الامتداد يستخدم شرط الفرادة.
    
    اقرأ عن أنواع الامتداد بالتفصيل [هنا][link-ext-logic].

!!! info "صيغة وصف عناصر الطلب"
    عند إنشاء امتداد FAST، تحتاج إلى فهم بنية الطلب HTTP المرسل إلى التطبيق وذلك الخاص بالرد HTTP المُستلَم من التطبيق لكي تستطيع وصف عناصر الطلب التي تحتاج للعمل معها باستخدام النقاط بشكل صحيح.
    
    لرؤية معلومات مفصلة، توجه إلى هذا [الرابط][link-points].

تجمع هذه المرحلة جميع الطلبات الأساسية التي تلبي الشرط المحدد. لاتخاذ قرار بشأن جمع الطلب، تستخدم المرحلة معلومات حول الطلبات التي تم جمعها بالفعل أثناء تشغيل الاختبار.

تحدث عملية جمع الطلبات الأساسية في الوقت الحقيقي. سيتم معالجة كل الطلبات حسب الترتيب الذي يكتب فيه العقدة FAST الطلبات الأساسية. لا حاجة لانتظار الانتهاء من عملية كتابة الطلب ليتم معالجة الطلبات وجمعها من قبل مرحلة التجميع.

## شرط الفرادة

لا يسمح شرط الفرادة لتلك الطلبات الأساسية التي ليست فريدة وفقًا للمعايير المحددة بالمضي قدمًا للمعالجة في المراحل المتبقية. لا يتم توليد طلبات الاختبار لهذه الطلبات المُصفّاة. قد يكون هذا مفيدًا لتقليل الحمل على التطبيق المستهدف في حالة استقباله لعدة طلبات أساسية من نوع متشابه.

يتم تحديد فرادة كل طلب مُستلَم على أساس البيانات الموجودة في الطلبات التي تم استلامها مسبقًا.

![مرحلة التجميع مع شرط الفرادة][img-collect-uniq]

تُحدد قائمة العناصر في الطلب التي يجب استخدامها لتحديد فرادة الطلب الأساسي في شرط الفرادة.

عند استقبال الطلب الأساسي، يقوم الامتداد في مرحلة التجميع بالإجراءات التالية لكل من عناصر الطلب في القائمة:
1. إذا لم يكن العنصر موجودًا في الطلب الأساسي، انتقل إلى العنصر التالي في القائمة.
2. إذا كان هذا العنصر موجودًا في الطلب الأساسي وبيانات هذا العنصر فريدة (بمعنى آخر، لا تتطابق مع أي من بيانات الطلبات الأساسية التي تم استقبالها مسبقًا)، اعتبر هذا الطلب الأساسي فريدًا وانقله إلى المراحل التالية. تذكر بيانات عنصر الطلب هذا.
3. إذا كان هذا العنصر موجودًا في الطلب الأساسي وبيانات هذا العنصر غير فريدة (بمعنى آخر، تتطابق مع بيانات الطلبات الأساسية التي تم استقبالها مسبقًا)، استبعد هذا الطلب الأساسي لأنه لا يُلبي شرط الفرادة. لن يتم تنفيذ الامتداد لهذا الطلب.
4. إذا تم الوصول إلى نهاية القائمة ولم يتم العثور على عنصر طلب يمكن التحقق من فرادته، استبعد هذا الطلب الأساسي. لن يتم تنفيذ الامتداد لهذا الطلب.

يمكنك وصف شرط الفرادة في قسم `collect` من ملف YAML الخاص بالامتداد باستخدام قائمة `uniq` التي تحتوي على العناصر التي من خلالها سيتم تحديد فرادة الطلب الأساسي.

```
collect:
  - uniq:
    - [عنصر الطلب]
    - [عنصر الطلب 1، عنصر الطلب 2، …، عنصر الطلب N]
    - testrun
```  

يمكن أن يحتوي عنصر الطلب في القائمة على [تعبيرات نظامية بصيغة تعبيرات Ruby النظامية][link-ruby-regexp].

يتضمن شرط الفرادة `uniq` صفًا من عناصر الطلب التي تحتوي على البيانات التي يُستخدم في التحقق من فرادة الطلب الأساسي. يمكن أيضًا استخدام المعلمة `testrun`.

شروط شرط الفرادة كالتالي:

* **`- [عنصر الطلب]`**
    
    يجب أن يحتوي الطلب على بيانات فريدة في عنصر الطلب حتى يُعتبر الطلب فريدًا.
    
    ??? info "مثال"
        `- [GET_uid_value]` — يتم تحديد فرادة الطلب من خلال بيانات معلمة `uid` GET (بمعنى آخر، يجب تشغيل الامتداد لكل من الطلبات الأساسية التي تحتوي على قيمة فريدة لمعلمة `uid` GET).

        * `example.com/example/app.php?uid=1` هو طلب فريد.
        * `example.com/demo/app.php?uid=1` ليس طلبًا فريدًا.
        * `example.com/demo/app.php?uid=` هو طلب فريد.
        * `example.org/billing.php?uid=1` ليس طلبًا فريدًا.
        * `example.org/billing.php?uid=abc` هو طلب فريد.

* **`- [عنصر الطلب 1، عنصر الطلب 2، …، عنصر الطلب N]`**
    
    يجب أن يحتوي الطلب على مجموعة من عناصر N، ويجب أن تكون بيانات عنصر الطلب فريدة في كل من هذه المجموعات حتى يُعتبر الطلب فريدًا.
    
    ??? info "مثال 1"
        `- [GET_uid_value, HEADER_COOKIE_value]` — يتم تحديد فرادة الطلب من خلال بيانات معلمة `uid` GET وبيانات رأس HTTP `Cookie` (بمعنى آخر، يجب تشغيل الامتداد لكل من الطلبات الأساسية التي تحتوي على قيمة فريدة لمعلمة `uid` GET ورأس `Cookie`).

        * `example.org/billing.php?uid=1, Cookie: client=john` هو طلب فريد.
        * `example.org/billing.php?uid=1, Cookie: client=ann` هو طلب فريد.
        * `example.com/billing.aspx?uid=1, Cookie: client=john` ليس طلبًا فريدًا.
    
    ??? info "مثال 2"
        `- [PATH_0_value, PATH_1_value]` — حدد فرادة الطلب بزوج من العنصرين الأول والثاني من المسار (بمعنى آخر، شغل الامتداد لكل من الطلبات الأساسية التي تحتوي على قيمة فريدة للزوج الذي يضم معلمتي `PATH_0` و `PATH_1`).
            
        Wallarm يقوم بتحليل عناصر الطلب أثناء معالجة العنصر. لكل من مسارات URI بالشكل `/en-us/apps/banking/` يضع مُحلل المسار كل من عناصر المسار في صفيف PATH.
            
        يمكنك الوصول إلى قيم كل من عناصر الصفيف باستخدام مؤشره. للمسار `/en-us/apps/banking/` الذي ذكرناه سابقًا، يوفر المُحلل البيانات التالية:

        * `"PATH_0_value": "en-us"`
        * `"PATH_1_value": "apps"`
        * `"PATH_2_value": "banking"`
            
        وبالتالي، سيُلبى شرط الفرادة لـ`[PATH_0_value, PATH_1_value]` بأي طلب يحتوي على قيم مختلفة في العنصر الأول والثاني من المسار.

        * `example.com/en-us/apps/banking/charge.php` هو طلب فريد.
        * `example.com/en-us/apps/banking/vip/charge.php` ليس طلبًا فريدًا.
        * `example.com/de-de/apps/banking/vip/charge.php` هو طلب فريد.
    
* **`- testrun`**
    
    سيتم تنفيذ الامتداد مرة واحدة في تشغيل الاختبار إذا تم إنشاء طلب الاختبار بنجاح (بمعنى آخر، إذا تم تجاوز جميع المراحل الأخرى).
    
    على سبيل المثال، إذا لم يمكن توليد طلبات الاختبار بناءً على الطلب الأساسي المستلم بسبب استبعاد الطلبات الأساسية في مرحلة المطابقة، فإن الامتداد في مرحلة التجميع يستمر في جمع الطلبات الأساسية حتى يتم معالجة أحدهم من خلال مرحلة المطابقة ثم يتم إنشاء طلبات الاختبار للتطبيق المستهدف بناءً عليه.
    
    لا يُسمح باستخدام أي من عناصر الطلب في قائمة `uniq` إذا كنت تستخدم بالفعل معلمة `testrun`. ستحتوي شرط الفرادة `uniq`  على عنصر واحد.
    
    ```
    collect:
      - uniq:
        - testrun 
    ```
    
    إذا كان هناك عدة عناصر في قائمة `uniq`، فمن الضروري للطلب أن يحتوي على معلم واحد على الأقل فريد من قائمة `uniq` من أجل تحديد الطلب الأساسي كفريد. 



!!! info "معاملات مرحلة التجميع"
    حاليًا، يتم دعم شرط الفرادة للطلبات الأساسية المُستلَمة في مرحلة التجميع فقط. قد يتم توسيع وظائف هذه المرحلة في المستقبل.