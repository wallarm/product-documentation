# Executando Testes de Verificação de Ameaça Ativa em Sistemas Não-Produtivos <a href="../../../about-wallarm/subscription-plans/#subscription-plans"><img src="../../../images/api-security-tag.svg" style="border: none;"></a>

A [Verificação de Ameaça Ativa da Wallarm](overview.md) transforma atacantes em seus próprios testadores de penetração. Depois de analisar uma solicitação do atacante, ela cria e testa solicitações potenciais para exposição de vulnerabilidade em seu aplicativo. Enquanto a configuração padrão envia testes para o endereço original da solicitação, a Wallarm recomenda configurar o módulo para redirecionar os testes para um ambiente de stage. Esta configuração permite que você use o tráfego de ataque da produção para testar aplicativos e APIs pré-produção. Este artigo orienta sobre como configurar a Wallarm para este caso de uso recomendado.

Testar no ambiente de produção usando dados reais de produção pode trazer riscos, como causar inatividade devido a testes extensos ou comprometer os dados reais do usuário. Testar em um ambiente de stage ou de desenvolvimento elimina esses riscos. Essa abordagem permite testar vulnerabilidades usando dados semelhantes aos de produção sem os problemas associados. Além disso, garante a segurança de seus sistemas ativos, enquanto também identifica vulnerabilidades durante o desenvolvimento.

Para configurar o módulo para testes não-produtivos, siga estes passos:

1. Configure um host de ambiente não-produtivo.
1. Configure um cookie de autenticação não-produtivo ou chave API.
1. Ative a Verificação de Ameaça Ativa.

O diagrama a seguir demonstra como o módulo funciona neste caso de uso:

![Esquema ATV](../../images/vulnerability-detection/active-threat-verification-scheme-staging.png)

## 1. Configure um host de ambiente não-produtivo

A regra [**Reescrever ataque antes da verificação ativa**](modify-requests-before-replay.md) permite que você modifique o endereço de reprodução do ataque substituindo o valor do cabeçalho `HOST` original ou os caminhos da solicitação. Para conseguir isto:

1. Vá para o Console da Wallarm → **Regras** → crie a regra **Reescrever ataque antes da verificação ativa**.
1. Preencha o formulário de criação da regra seguindo as instruções:

      * **Se a solicitação for** [especifica](../../user-guides/rules/rules.md#branch-description) os endpoints para aplicar a regra.
      * **Regras** especifica o novo valor para o cabeçalho `HOST` ou para o caminho da solicitação (segmento URL sem o domínio, por exemplo, `/test-blogs/new`).

        O valor deve ser decodificado e definido usando a [linguagem de template Liquid](https://shopify.github.io/liquid/) da seguinte forma: colocado entre chaves duplas `{{}}` e aspas simples `''`. Por exemplo: `{{'example.com'}}`.
      
      * **Parte da solicitação**: selecione `header: HOST` ou `uri`, com base no segmento da solicitação que você pretende modificar.
1. Aguarde a [compilação da regra ser concluída](../../user-guides/rules/rules.md).

Por exemplo, a regra a seguir é para execução de ataques inicialmente direcionados para `example.com` no ambiente de teste `example-test.env.srv.loc`. O formato do endereço é `{{'example-test.env.srv.loc'}}`.

![Exemplo da regra modificando HOST](../../images/user-guides/rules/rewrite-request-example-host.png)

## 2. Configure um cookie de autenticação não-produtivo ou chave API

As APIs do seu aplicativo podem exigir autenticação. No entanto, como o módulo [remove](overview.md#test-request-security) os dados de autenticação antes de reproduzir os ataques, ou porque os dados de autenticação de produção não são válidos para ambientes de stage ou de desenvolvimento, as vulnerabilidades podem passar despercebidos.

Para solucionar isso, considere configurar parâmetros de autenticação específicos para a verificação de ameaça ativa em seus ambientes de não-produção. Isso pode ser feito quando:

* Os dados estão incluídos nos cabeçalhos de solicitação, e
* Os cabeçalhos de solicitação são consistentes entre os ambientes original e o novo ambiente não-produtivo.

Este método não só fornece o acesso necessário, mas também garante que você possa controlar de forma segura o processo de reprodução.

Para fornecer às solicitações reproduzidas os detalhes de autenticação necessários:

1. Vá para o Console da Wallarm → **Regras** → crie a regra **Reescrever ataque antes da verificação ativa**.
1. Preencha o formulário de criação da regra seguindo as instruções:

    * **Se a solicitação for** [especifica](../../user-guides/rules/rules.md#branch-description) os endpoints para aplicar a regra.
    * **Regras** fornece o valor do cookie ou token desenhado para solicitações de verificação de ameaça ativa.

        O valor deve ser decodificado e definido usando a [linguagem de template Liquid](https://shopify.github.io/liquid/) da seguinte forma: colocado entre as chaves duplas `{{}}` e aspas simples `''`. Por exemplo: `{{'example.com'}}`.

    * **Parte da solicitação**: selecione `header` e indique o nome do cabeçalho para passar dados de autenticação.
1. Aguarde a [compilação da regra ser concluída](../../user-guides/rules/rules.md).

Por exemplo, a regra a seguir garante que ataques reproduzidos em `example.com` transportem o valor `PHPSESSID=mntdtbgt87j3auaq60iori2i63; security=low` no cabeçalho `COOKIE`.

O formato do valor do cabeçalho é `{{'PHPSESSID=mntdtbgt87j3auaq60iori2i63; security=low'}}`.

![Exemplo da regra modificando COOKIE](../../images/user-guides/rules/rewrite-request-example-cookie.png)

## 3. Ative o módulo

Uma vez que tenha especificado todas as configurações necessárias para a execução de reproduções de ataques em ambientes não‑produtivos, ative o módulo para iniciar o processo de detecção de vulnerabilidade:

1. Garanta que tenha um plano de assinatura **Advanced API Security** [ativo](../../about-wallarm/subscription-plans.md#subscription-plans). O módulo está disponível apenas neste plano.

    Se estiver em um plano diferente, por favor, contate nossa [equipe de vendas](mailto:sales@wallarm.com) para fazer a transição para o plano necessário.
1. Vá para o Console da Wallarm → **Vulnerabilidades** → **Configure** seguindo o link para o [US Cloud](https://us1.my.wallarm.com/vulnerabilities/active?configure=true) ou [EU Cloud](https://my.wallarm.com/vulnerabilities/active?configure=true), e ative o interruptor **Verificação de ameaça ativa**.

![Configurações de análise de vulnerabilidade](../../images/user-guides/vulnerabilities/vuln-scan-settings.png)

Esta ação ativa o módulo para todos os recursos onde o nó de filtragem está configurado. A reprodução de ataques será executada considerando a configuração que você especificou anteriormente.

Você também tem a capacidade de [ativar ou desativar o módulo](enable-disable-active-threat-verification.md) para endpoints específicos.

## Monitoramento e abordagem de vulnerabilidades detectadas

Você pode optar por receber [notificações](../../user-guides/settings/integrations/integrations-intro.md) oportunamente sobre as vulnerabilidades detectadas para sistemas como Splunk, OpsGenie, etc. Integrar notificações de vulnerabilidade em sua rotina de trabalho diária acelera significativamente o seu tempo de resposta a ameaças potenciais.

![Integração Opsgenie](../../images/user-guides/settings/integrations/add-opsgenie-integration-vulns.png)

Todas as vulnerabilidades devem ser corrigidas no lado do aplicativo, pois elas tornam seu sistema mais vulnerável a ações maliciosas. Se uma vulnerabilidade não puder ser corrigida, usar a regra de [remendo virtual](../../user-guides/rules/vpatch-rule.md) pode ajudar a bloquear ataques relacionados e eliminar o risco de um incidente.

As vulnerabilidades descobertas também são catalogadas na seção [**Vulnerabilidades**](../../user-guides/vulnerabilities.md) da UI do Console da Wallarm. Aqui você pode analisar e gerenciá-las.

![Aba de vulnerabilidades](../../images/user-guides/vulnerabilities/check-vuln.png)