### カスタムルールセットのビルド

Wallarm Console → **Security Controls** → **Rules**または**Mitigation Controls**で新しいrule/mitigation controlを追加したり、既存のものを削除・変更したりすると、カスタムルールセットのビルドが開始されます。ビルド処理の間に、ルールとコントロールは最適化され、フィルタリングノード用の形式にコンパイルされます。カスタムルールセットのビルド時間は、ルールが少数の場合は数秒、複雑なルールツリーでは最大1時間程度かかることがあります。

### フィルタリングノードへのアップロード

カスタムルールセットのビルドは、フィルタリングノードとWallarm Cloudの同期時にフィルタリングノードへアップロードされます。既定では、フィルタリングノードとWallarm Cloudの同期は2〜4分ごとに実行されます。[フィルタリングノードとWallarm Cloudの同期設定の詳細 →][link-cloud-node-synchronization]

カスタムルールセットをフィルタリングノードへアップロードするステータスは、`/opt/wallarm/var/log/wallarm/wcli-out.log`ファイルに記録されます。

同一のWallarmアカウントに接続されているすべてのWallarmノードは、トラフィックフィルタリング用の既定およびカスタムのルールセットを同一に受け取ります。ただし、適切なアプリケーションIDやヘッダー、クエリ文字列パラメーターなどの一意なHTTPリクエストパラメーターを使用することで、アプリケーションごとに異なるルールを適用することも可能です。

### バックアップと復元

誤ってルールを誤設定したり削除したりする事態に備えて、現在のカスタムルールセットをバックアップできます。

ルールのバックアップには次のオプションがあります:

* 各[カスタムルールセットのビルド](#custom-ruleset-building)後の自動バックアップ作成。自動バックアップの数は7個に制限されています。1日のうちに複数回ルールを変更した場合でも、その日の最後のバックアップのみが保持されます。
* 任意のタイミングでの手動バックアップ作成。手動バックアップの数は既定で5個に制限されています。より多くが必要な場合は、[Wallarmテクニカルサポート](mailto:support@wallarm.com)チームにお問い合わせください。

次の操作が可能です。

* 現在のバックアップにアクセスします: RulesセクションでBackupsをクリックします。
* 新しいバックアップを手動で作成します: BackupsウィンドウでCreate backupをクリックします。
* 手動バックアップの名前と説明を設定し、いつでも編集できます。

    !!! info "自動バックアップの命名"
        自動バックアップの名前はシステムによって付けられ、変更できません。

* 既存のバックアップから読み込みます: 目的のバックアップでLoadをクリックします。バックアップから読み込むと、現在のルール構成は削除され、バックアップの構成に置き換えられます。
* バックアップを削除します。

    ![Rules - バックアップの作成][img-rules-create-backup]

!!! warning "ルール変更の制限"
    Create backupまたはバックアップからのLoadが完了するまで、ruleやmitigation controlを作成または変更することはできません。