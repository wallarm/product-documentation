## 要件

* AWSアカウント
* AWS EC2、セキュリティグループに関する理解
* 希望のAWSリージョン（Wallarmノードの展開にリージョンの制限はありません）
* [US Cloud](https://us1.my.wallarm.com/) または [EU Cloud](https://my.wallarm.com/) で**管理者**ロールを持ち、二段階認証が無効になっているアカウントへのアクセス
* US Wallarm Cloudを使用する場合は `https://us1.api.wallarm.com:444` へのアクセス、EU Wallarm Cloudを使用する場合は `https://api.wallarm.com:444` へのアクセス。プロキシサーバー経由でのみアクセスを設定できる場合は、[こちらの指示][wallarm-api-via-proxy]を使用してください
* Wallarmインスタンス上での全てのコマンドをスーパーユーザー（例: `root`）として実行

## 1. AWSでSSHキーペアを作成

展開プロセス中には、SSHを介して仮想マシンに接続する必要があります。Amazon EC2では、インスタンスに接続するために使用できる公開鍵と秘密鍵の名前付きペアを作成できます。

キーペアを作成するには:

1. Amazon EC2ダッシュボードの**キーペア**タブに移動します。
2. **キーペアの作成**ボタンをクリックします。
3. キーペアの名前を入力し、**作成**ボタンをクリックします。

PEM形式の秘密SSHキーが自動的にダウンロードを開始します。将来的に作成したインスタンスに接続するためにキーを保存してください。

SSHキーの作成に関する詳細は、[AWSのドキュメント][link-ssh-keys]を参照してください。

## 2. セキュリティグループを作成

セキュリティグループは、仮想マシンの許可および禁止される入出力接続を定義します。最終的な接続リストは、保護されるアプリケーション（例えば、TCP/80およびTCP/443ポートへのすべての入力接続を許可する）に依存します。

フィルタリングノード用のセキュリティグループを作成するには:

1. Amazon EC2ダッシュボードの**セキュリティグループ**タブに移動し、**セキュリティグループの作成**ボタンをクリックします。
2. 表示されたダイアログウィンドウにセキュリティグループ名と省略記述を入力します。
3. 必要なVPCを選択します。
4. **入力**および**出力**タブで入出力接続ルールを設定します。
5. **作成**ボタンをクリックしてセキュリティグループを作成します。

![セキュリティグループの作成][img-create-sg]

!!! warning "セキュリティグループからの出力接続のルール"
    セキュリティグループを作成する際、全ての出力接続はデフォルトで許可されています。フィルタリングノードからの出力接続を制限する場合は、Wallarm APIサーバーへのアクセスが許可されていることを確認してください。Wallarm APIサーバーの選択は、使用しているWallarm Cloudによって異なります:

    * US Cloudを使用している場合、ノードは `us1.api.wallarm.com` へのアクセスが必要です。
    * EU Cloudを使用している場合、ノードは `api.wallarm.com` へのアクセスが必要です。
    
    正常な運用には、フィルタリングノードがWallarm APIサーバーへのアクセスが必要です。

セキュリティグループの作成に関する詳細は、[AWSのドキュメント][link-sg]を参照してください。

## 3. Wallarmノードインスタンスを起動

Wallarmフィルタリングノードを含むインスタンスを起動するには、この[リンク](https://aws.amazon.com/marketplace/pp/B073VRFXSD)にアクセスし、フィルタリングノードにサブスクライブしてください。

インスタンスを作成する際には、次のように[以前に作成した][anchor1]セキュリティグループを指定する必要があります:

1. Launch Instance Wizardで作業中に、対応するタブをクリックして**6. セキュリティグループの設定**インスタンス起動ステップに進みます。
2. **セキュリティグループの割り当て**設定で**既存のセキュリティグループを選択**オプションを選択します。
3. 表示されるリストからセキュリティグループを選択します。

必要なインスタンス設定の指定が完了したら、**確認して起動**ボタンをクリックし、インスタンスが正しく構成されていることを確認してから、**起動**ボタンをクリックします。

表示されるウィンドウでは、次の操作を行って[以前に作成した][anchor2]キーペアを指定します:

1. 最初のドロップダウンリストで**既存のキーペアを選択**オプションを選択します。
2. 2番目のドロップダウンリストでキーペアの名前を選択します。
3. 2番目のドロップダウンリストで指定したキーペアからPEM形式の秘密鍵へのアクセスがあることを確認し、このことを確認するチェックボックスにチェックを入れます。
4. **インスタンスの起動**ボタンをクリックします。

インスタンスは、プリインストールされたフィルタリングノードで起動されます。

AWSでインスタンスを起動する方法に関する詳細は、[AWSのドキュメント][link-launch-instance]を参照してください。

## 4. SSHを介してフィルタリングノードインスタンスに接続

SSHを介してインスタンスに接続する方法に関する詳細は、[AWSのドキュメント](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html)を参照してください。

インスタンスに接続するには、`admin`ユーザー名を使用します。

!!! info "SSH経由で接続するためにキーを使用する"
    [以前に作成した][anchor2]PEM形式の秘密鍵を使用して、SSH経由でインスタンスに接続します。これは、インスタンスの作成時に指定したSSHキーペアからの秘密鍵でなければなりません。

## 5. インスタンスをWallarm Cloudに接続するためのトークンを生成

ローカルWallarmフィルタリングノードは、適切なタイプのWallarmトークンを使用してWallarm Cloudに接続する必要があります[適切なタイプ][wallarm-token-types]。APIトークンを使用すると、Wallarm Console UIでノードグループを作成でき、ノードインスタンスを効果的に整理できます。

![グループ化されたノード][img-grouped-nodes]

トークンを次のように生成します:

=== "APIトークン"

    1. Wallarmコンソール → **設定** → **APIトークン**にアクセスし、[US Cloud](https://us1.my.wallarm.com/settings/api-tokens)または[EU Cloud](https://my.wallarm.com/settings/api-tokens)を開きます。
    1. `Deploy`ソースロールを持つAPIトークンを見つけるか、作成します。
    1. このトークンをコピーします。
=== "ノードトークン"

    1. Wallarmコンソール → **ノード**にアクセスし、[US Cloud](https://us1.my.wallarm.com/nodes)または[EU Cloud](https://my.wallarm.com/nodes)を開きます。
    1. 次のいずれかを行います:
        * **Wallarmノード**タイプのノードを作成し、生成されたトークンをコピーします。
        * 既存のノードグループを使用する - ノードのメニューからトークンをコピーします → **トークンをコピー**。