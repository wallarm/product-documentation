## 前提条件

* AWSアカウント
* AWS EC2、セキュリティグループの理解
* 二要素認証が無効な**管理者**ロールでの[US Cloud](https://us1.my.wallarm.com/)または[EU Cloud](https://my.wallarm.com/)のWallarm コンソールへのアカウントアクセス
* US Wallarm Cloudとの作業のための `https://us1.api.wallarm.com:444`へのアクセス、またはEU Wallarm Cloudとの作業のための `https://api.wallarm.com:444`へのアクセス。アクセスがプロキシサーバー経由でのみ設定可能な場合は、[instructions][wallarm-api-via-proxy]を使用してください。
* ユーザーがスーパーユーザー（例：`root`）としてWallarmインスタンス上で全てのコマンドを実行すること

## 1. AWSでSSHキーペアを作成する

デプロイプロセス中、SSH経由で仮想マシンに接続する必要があります。Amazon EC2は、インスタンスに接続するために使用できる命名された公開SSHキーと秘密SSHキーのペアを作成することを可能にします。

キーペアを作成するには：

1. Amazon EC2ダッシュボードで**キーペア** タブに移動します。
2. **キーペアの作成** ボタンをクリックします。
3. キーペア名を入力し、**作成** ボタンをクリックします。

PEM形式の秘密SSHキーが自動的にダウンロードを開始します。将来作成されたインスタンスに接続するためにキーを保存してください。

SSHキーの作成に関する詳細な情報をご覧になるには、[AWSのドキュメンテーション][link-ssh-keys]へ進んでください。

## 2. セキュリティグループを作成する

セキュリティグループは、仮想マシンの許可された接続と禁止された接続を定義します。接続の最終リストは、保護されたアプリケーションに依存します（例えば、TCP/80ポートとTCP/443ポートへのすべての受信接続を許可する）。

フィルタリングノード用のセキュリティグループを作成するには：

1. Amazon EC2ダッシュボードの**セキュリティグループ**タブに移動し、**セキュリティグループの作成**ボタンをクリックします。
2. 表示されるダイアログウィンドウにセキュリティグループ名とオプションの説明を入力します。
3. 必要なVPCを選択します。
4. **インバウンド**タブと**アウトバウンド**タブにて受信接続と送信接続のルールを設定します。
5. セキュリティグループを作成するために、**作成**ボタンをクリックします。

![セキュリティグループの作成][img-create-sg]

!!! warning "セキュリティグループからの送信接続のルール"
    セキュリティグループを作成する際、デフォルトで全ての送信接続が許可されます。フィルタリングノードからの送信接続を制限する場合、ノードがWallarm APIサーバーへのアクセス権を有していることを確認してください。Wallarm APIサーバーを選択するには、利用しているWallarm Cloudによります：

    * US Cloudを使用している場合、ノードは `us1.api.wallarm.com`へのアクセス権を持つ必要があります。
    * EU Cloudを使用している場合、ノードは `api.wallarm.com`へのアクセス権を持つ必要があります。
    
    フィルタリングノードが正常に働くためには、Wallarm APIサーバーへのアクセスが必要です。

セキュリティグループの作成についての詳細な情報を見るには、[AWSのドキュメンテーション][link-sg]へ進んでください。

## 3. Wallarmノードインスタンスを起動する

Wallarmフィルタリングノードを含んだインスタンスを起動するには、こちらの[リンク](https://aws.amazon.com/marketplace/pp/B073VRFXSD)へ進み、フィルタリングノード4.6に登録してください。

インスタンスを作成する際、下記の通り、[事前に作成した][anchor1]セキュリティグループを指定する必要があります：

1. Launch Instance Wizardを使って作業を行いながら、**6. セキュリティグループの設定** インスタンス起動ステップをクリックして該当のタブへ進みます。
2. **セキュリティグループの割り当て** 設定で **既存のセキュリティグループを選択** オプションを選びます。
3. 表示されるリストからセキュリティグループを選択します。

全ての必要なインスタンス設定を指定した後、**レビューと起動** ボタンをクリックし、インスタンスが正しく設定されているかを確認した後、**起動** ボタンをクリックします。

表示されるウィンドウで、次の操作を行って、[事前に作成した][anchor2] キーペアを指定します：

1. 最初のドロップダウンリストで、**既存のキーペアを選択** オプションを選択します。
2. 2つ目のドロップダウンリストでキーペアの名前を選択します。
3. 第2のドロップダウンリストで指定したキーペアからPEM形式の秘密キーへのアクセス権があることを確認し、これを確認するためにチェックボックスをチェックします。
4. **インスタンスの起動** ボタンをクリックします。

インスタンスが、事前インストールされたフィルタリングノードと共に起動します。

AWSでインスタンスを起動する方法についての詳細な情報を見るには、[AWSのドキュメンテーション][link-launch-instance]へ進んでください。

## 4. SSH経由でフィルタリングノードインスタンスに接続する

SSH経由でインスタンスに接続する方法についての詳細な情報を見るには、[AWSのドキュメンテーション](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html)へ進んでください。

インスタンスに接続するためには、`admin`ユーザー名を使用する必要があります。

!!! info "SSH接続のためのキーの使用"
    [以前に作成した][anchor2] PEM形式の秘密キーを使って、SSH経由でインスタンスに接続します。これは、インスタンス作成時に指定したSSHキーペアの秘密キーである必要があります。

## 5. フィルタリングノードをWallarm Cloudに接続する

--8<-- "../include-ja/waf/installation/connect-waf-and-cloud-4.6-only-with-postanalytics.md"